{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pago – Toolingo</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: {
        colors:{ brand:{50:'#fff7ed',100:'#ffedd5',600:'#f97316',700:'#c2410c'} },
        boxShadow:{ soft:'0 12px 30px rgba(15,23,42,.07)', lift:'0 18px 48px rgba(15,23,42,.14)'}
      }}
    }
  </script>
  <style>
    /* por si algún user-agent no trae border-box */
    *,*::before,*::after{ box-sizing:border-box; }
  </style>
</head>
<body class="bg-white text-slate-800">
  <!-- NAV -->
  <header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-6">
      <a href="/" class="flex items-center gap-2 shrink-0">
        <svg width="26" height="26" viewBox="0 0 24 24" class="text-brand-600 fill-current">
          <path d="M21 7.5a5.5 5.5 0 0 1-7.53 5.09l-6.44 6.44a1.5 1.5 0 0 1-2.12-2.12l6.44-6.44A5.5 5.5 0 1 1 21 7.5Z"/>
        </svg>
        <span class="text-lg font-extrabold">Toolingo</span>
      </a>
      <nav class="hidden md:flex ml-auto items-center gap-6 text-sm">
        <a href="/catalogo/" class="hover:text-brand-600">Productos</a>
        <a href="/carrito/" class="hover:text-brand-600">Carrito</a>
      </nav>
    </div>
  </header>

  <!-- CONTENIDO -->
  <main class="max-w-6xl mx-auto px-4 py-8">
    <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight">Pago</h1>
    <p class="text-slate-600 mt-1">Selecciona un método de pago y completa tus datos.</p>

    <!-- Resumen grande a la derecha, pero sin overflow -->
    <div class="mt-6 grid xl:grid-cols-12 gap-8">
      <!-- Izquierda -->
      <section class="xl:col-span-6 space-y-4 min-w-0">
        <!-- Métodos -->
        <div class="grid md:grid-cols-2 gap-3">
          <button data-method="credit" class="method border rounded-2xl p-4 text-left hover:bg-slate-50 focus:ring-2 focus:ring-brand-100">
            <div class="font-semibold">Tarjeta de crédito</div>
            <div class="text-sm text-slate-500">Visa, MasterCard, Amex</div>
          </button>
          <button data-method="debit" class="method border rounded-2xl p-4 text-left hover:bg-slate-50">
            <div class="font-semibold">Tarjeta de débito</div>
            <div class="text-sm text-slate-500">Visa Débito, MasterCard Débito</div>
          </button>
          <button data-method="pse" class="method border rounded-2xl p-4 text-left hover:bg-slate-50">
            <div class="font-semibold">PSE</div>
            <div class="text-sm text-slate-500">Débito bancario</div>
          </button>
          <button data-method="addi" class="method border rounded-2xl p-4 text-left hover:bg-slate-50">
            <div class="font-semibold">ADDI</div>
            <div class="text-sm text-slate-500">Compra ahora, paga después</div>
          </button>
          <button data-method="siste" class="method border rounded-2xl p-4 text-left hover:bg-slate-50 md:col-span-2">
            <div class="font-semibold">SisteCredito</div>
            <div class="text-sm text-slate-500">Crédito fácil y rápido</div>
          </button>
        </div>

        <!-- Formulario -->
        <section id="payForm" class="rounded-2xl border bg-white shadow-soft p-5 overflow-hidden">
          <!-- Logos -->
          <div id="brandRow" class="flex items-center gap-4 mb-4 min-w-0">
            <img src="https://upload.wikimedia.org/wikipedia/commons/5/5e/Visa_Inc._logo.svg" alt="Visa" class="h-6 shrink-0">
            <img src="https://upload.wikimedia.org/wikipedia/commons/2/2a/Mastercard-logo.svg" alt="Mastercard" class="h-6 shrink-0">
            <img src="{% static 'img/amex.png' %}" alt="Amex" class="h-6 shrink-0" onerror="this.style.display='none'">
            <span class="text-xs text-slate-500 truncate">Aceptamos tarjetas principales.</span>
          </div>

          <!-- CREDIT/DEBIT -->
          <form id="cardForm" class="grid md:grid-cols-2 gap-4">
            <label class="grid gap-1 md:col-span-2">
              <span class="text-sm text-slate-600">Número</span>
              <input id="cardNumber" type="text" inputmode="numeric" maxlength="19"
                     class="border rounded-xl px-3 py-2 w-full"
                     placeholder="•••• •••• •••• ••••">
            </label>

            <label class="grid gap-1">
              <span class="text-sm text-slate-600">Cuotas</span>
              <select id="installments" class="border rounded-xl px-3 py-2 w-full">
                <option value="">¿En cuántas cuotas?</option>
                <option>1</option><option>3</option><option>6</option><option>12</option>
              </select>
            </label>
            <label class="grid gap-1">
              <span class="text-sm text-slate-600">Nombre y Apellido (como figura en la tarjeta)</span>
              <input id="cardName" type="text" class="border rounded-xl px-3 py-2 w-full" placeholder="Nombre Apellido">
            </label>

            <!-- Aquí estaba el overflow: ahora es sm:grid-cols-3 y todo w-full -->
            <div class="grid sm:grid-cols-3 gap-3 md:col-span-2">
              <label class="grid gap-1">
                <span class="text-sm text-slate-600">Vencimiento</span>
                <input id="expMM" type="text" maxlength="2" class="border rounded-xl px-3 py-2 w-full" placeholder="MM">
              </label>
              <label class="grid gap-1">
                <span class="text-sm text-slate-600">&nbsp;</span>
                <input id="expYY" type="text" maxlength="2" class="border rounded-xl px-3 py-2 w-full" placeholder="AA">
              </label>
              <label class="grid gap-1">
                <span class="text-sm text-slate-600">CVV</span>
                <input id="cvv" type="password" maxlength="4" class="border rounded-xl px-3 py-2 w-full" placeholder="•••">
              </label>
            </div>

            <label class="flex items-center gap-2 md:col-span-2 text-sm">
              <input id="billAddr" type="checkbox" class="h-4 w-4 rounded border-slate-300" checked>
              <span>La dirección de la factura coincide con la de mi cuenta.</span>
            </label>

            <div class="md:col-span-2">
              <button id="payBtn" type="button"
                      class="px-5 py-3 rounded-xl bg-brand-600 text-white hover:bg-brand-700 w-full sm:w-auto">
                Pagar ahora
              </button>
            </div>
          </form>

          <!-- PSE / ADDI / SISTECREDITO -->
          <div id="altMethod" class="hidden">
            <div class="text-slate-700">
              <p id="altText" class="mb-3">Serás redirigido para completar tu pago.</p>
              <button id="goAlt" class="px-5 py-3 rounded-xl bg-brand-600 text-white hover:bg-brand-700">
                Continuar con el método seleccionado
              </button>
            </div>
          </div>
        </section>
      </section>

      <!-- Derecha: Resumen grande -->
      <aside class="xl:col-span-6 min-w-0">
        <div class="rounded-2xl border bg-white p-6 shadow-soft sticky top-24 ring-2 ring-brand-100 overflow-hidden">
          <div class="flex items-center justify-between gap-4">
            <h3 class="font-semibold text-xl">Resumen de la orden</h3>
            <span class="text-xs px-2 py-0.5 rounded-full bg-brand-50 text-brand-700 border border-brand-100 shrink-0">verificación segura</span>
          </div>

          <div id="itemsBox" class="mt-5 space-y-4"></div>

          <div class="mt-5 space-y-3 text-sm">
            <div class="flex items-center justify-between">
              <span class="text-slate-600">Productos (<span id="count">0</span>)</span>
              <span id="subtotal" class="font-medium">$0</span>
            </div>
            <div class="pt-3 mt-1 border-t flex items-center justify-between text-base font-bold text-slate-900">
              <span>Total</span><span id="total">$0</span>
            </div>
          </div>

          <p class="mt-3 text-[12px] text-slate-500">
            Las reservas se confirman por cada artículo y rango de fechas.
          </p>
        </div>
      </aside>
    </div>

    <!-- Franja de beneficios -->
    <section class="mt-12 rounded-2xl bg-brand-600 text-white p-6">
      <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-6 text-sm">
        <div class="flex items-center gap-3">
          <svg class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><path d="M3 6a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v3H3V6Zm0 5h18v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-7Zm3 5h4v2H6v-2Z"/></svg>
          <div><div class="font-semibold">Múltiples medios de pago</div><div class="text-brand-100">Tarjeta, PSE y más</div></div>
        </div>
        <div class="flex items-center gap-3">
          <svg class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l7 3v6c0 5-3.5 9-7 11-3.5-2-7-6-7-11V5l7-3Zm0 5a4 4 0 1 0 0 8 4 4 0 0 0 0-8Z"/></svg>
          <div><div class="font-semibold">Seguro y confiable</div><div class="text-brand-100">Protección de datos y pagos</div></div>
        </div>
        <div class="flex items-center gap-3">
          <svg class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.2 4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2Z"/></svg>
          <div><div class="font-semibold">Calidad garantizada</div><div class="text-brand-100">Publicaciones verificadas</div></div>
        </div>
        <div class="flex items-center gap-3">
          <svg class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><path d="M3 6h11v7h2l3 3v2h-2a2 2 0 1 1-4 0H9a2 2 0 1 1-4 0H3V6Zm15 8h1.59L18 12.41V14Z"/></svg>
          <div><div class="font-semibold">Entrega rápida</div><div class="text-brand-100">Coordina con el propietario</div></div>
        </div>
      </div>
    </section>
  </main>

  <footer class="py-10 text-center text-sm text-slate-500">© <span id="y"></span> Toolingo</footer>
  <script>document.getElementById('y').textContent = new Date().getFullYear()</script>

  <script>
    // ===== Helpers
    const fmt = n => Number(n||0).toLocaleString('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0});

    // ===== JWT + authFetch
    const TOKEN_KEY='access', REFRESH_KEY='refresh';
    const getToken = ()=> localStorage.getItem(TOKEN_KEY);
    const getRefresh = ()=> localStorage.getItem(REFRESH_KEY);
    const setTokens = ({access, refresh}) => { if(access) localStorage.setItem(TOKEN_KEY, access); if(refresh) localStorage.setItem(REFRESH_KEY, refresh); };

    async function refreshAccessToken(){
      const refresh = getRefresh(); if(!refresh) return null;
      const r = await fetch('/api/token/refresh/', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({refresh})});
      if(!r.ok) return null; const d=await r.json(); if(d.access){ setTokens({access:d.access}); return d.access; } return null;
    }
    async function authFetch(url, opts={}){
      const tk = getToken(); if(!tk){ location.replace('/login/?next=/checkout/'); throw new Error('No autenticado'); }
      const h = new Headers(opts.headers||{}); h.set('Authorization',`Bearer ${tk}`); if(opts.body && !h.has('Content-Type')) h.set('Content-Type','application/json');
      let resp = await fetch(url,{...opts,headers:h});
      if(resp.status===401){ const na = await refreshAccessToken(); if(na){ h.set('Authorization',`Bearer ${na}`); resp=await fetch(url,{...opts,headers:h}); } }
      return resp;
    }

    // ===== Cargar carrito en resumen
    const itemsBox = document.getElementById('itemsBox');
    const countEl = document.getElementById('count');
    const subtotalEl = document.getElementById('subtotal');
    const totalEl = document.getElementById('total');

    // >>> NUEVO: guardaremos los ítems del carrito para componer el pago
    let __CART_ITEMS__ = [];

    async function loadSummary(){
      try{
        const r = await authFetch('/api/carrito/'); 
        const items = await r.json();

        __CART_ITEMS__ = Array.isArray(items) ? items : [];

        countEl.textContent = __CART_ITEMS__.length;
        let sum = 0;
        itemsBox.innerHTML = __CART_ITEMS__.map(it=>{
          sum += Number(it.total_estimado||0);
          const img = it.articulo_portada
            ? `<img src="${it.articulo_portada}" class="h-14 w-20 rounded object-cover border" alt="">`
            : `<div class="h-14 w-20 rounded bg-slate-100 border"></div>`;
          return `
            <div class="flex gap-3 items-center">
              ${img}
              <div class="min-w-0 grow">
                <div class="text-sm font-medium truncate">${it.articulo_titulo || 'Artículo'}</div>
                <div class="text-xs text-slate-500">${it.fecha_inicio} → ${it.fecha_fin} · ${it.dias} día(s)</div>
              </div>
              <div class="text-sm font-semibold">${fmt(it.total_estimado)}</div>
            </div>`;
        }).join('') || `<div class="text-sm text-slate-500">Tu carrito está vacío.</div>`;
        subtotalEl.textContent = fmt(sum);
        totalEl.textContent = fmt(sum);
      }catch(e){
        itemsBox.innerHTML = `<div class="text-red-600 text-sm">${e.message}</div>`;
      }
    }

    // ===== UI métodos
    const methods = document.querySelectorAll('.method');
    const cardForm = document.getElementById('cardForm');
    const altMethod = document.getElementById('altMethod');
    const brandRow = document.getElementById('brandRow');
    const altText = document.getElementById('altText');

    function selectMethod(kind){
      methods.forEach(m=>{
        m.classList.remove('ring-2','ring-brand-100','bg-brand-50/40');
        if(m.dataset.method===kind) m.classList.add('ring-2','ring-brand-100','bg-brand-50/40');
      });
      if(kind==='credit' || kind==='debit'){
        cardForm.classList.remove('hidden');
        altMethod.classList.add('hidden');
        brandRow.classList.remove('hidden');
      }else{
        cardForm.classList.add('hidden');
        altMethod.classList.remove('hidden');
        brandRow.classList.add('hidden');
        altText.textContent = (kind==='pse')
          ? 'Te llevaremos al banco para completar el pago por PSE.'
          : (kind==='addi')
            ? 'Te redirigiremos a ADDI para solicitar el crédito y finalizar el pago.'
            : 'Te redirigiremos a SisteCredito para continuar con tu financiación.';
      }
      selectedMethod = kind;
    }

    methods.forEach(btn=> btn.addEventListener('click', ()=> selectMethod(btn.dataset.method)));
    let selectedMethod = 'credit';
    selectMethod(selectedMethod);

    // ===== Acciones de pago (demo + guardar simulación)
    document.getElementById('payBtn').addEventListener('click', ()=>{
      const num = document.getElementById('cardNumber').value.replace(/\s+/g,'');
      const name = document.getElementById('cardName').value.trim();
      const mm = document.getElementById('expMM').value.trim();
      const yy = document.getElementById('expYY').value.trim();
      const cvv = document.getElementById('cvv').value.trim();
      const cuotas = document.getElementById('installments').value || '1';

      // Validación simple para métodos de tarjeta
      if(selectedMethod==='credit' || selectedMethod==='debit'){
        if(num.length < 13 || !name || mm.length!==2 || yy.length!==2 || cvv.length<3){
          alert('Completa los datos de la tarjeta.'); 
          return;
        }
      }

      // Total del carrito
      const total = (__CART_ITEMS__ || []).reduce((acc, it) => acc + Number(it.total_estimado||0), 0);

      // Objeto de pago simulado
      const pago = {
        id: `PAY-${Date.now()}`,
        fecha_iso: new Date().toISOString(),
        metodo: selectedMethod || 'credit',
        cuotas,
        last4: (num || '').slice(-4) || '',
        total,
        items: (__CART_ITEMS__ || []).map(it => ({
          id: it.id || null,
          articulo_id: it.articulo || it.articulo_id || null,
          titulo: it.articulo_titulo || 'Artículo',
          fecha_inicio: it.fecha_inicio,
          fecha_fin: it.fecha_fin,
          dias: it.dias,
          total_estimado: it.total_estimado
        }))
      };

      // Guardar en localStorage (historial)
      try{
        const arr = JSON.parse(localStorage.getItem('sim_pagos') || '[]');
        arr.unshift(pago);
        localStorage.setItem('sim_pagos', JSON.stringify(arr));
      }catch(_){
        localStorage.setItem('sim_pagos', JSON.stringify([pago]));
      }

      alert('Simulación: pago con tarjeta listo para integrarse ');
      // Redirigir al historial de pagos
      window.location.href = '/pagos/';
    });

    document.getElementById('goAlt').addEventListener('click', ()=>{
      alert('Simulación: redirigir a pasarela externa');
    });

    loadSummary();
  </script>
</body>
</html>
