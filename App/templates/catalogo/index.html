<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cat√°logo ‚Äì Toolingo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: { colors: {
        brand: { 600:'#f97316',700:'#c2410c',100:'#ffedd5',50:'#fff7ed' }
      }}}
    }
  </script>
</head>
<body class="text-slate-800">
  <!-- Navbar -->
  <header class="sticky top-0 bg-white/80 backdrop-blur border-b border-slate-200 z-50">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-6">
      <!-- Logo -->
      <a href="/" class="flex items-center gap-2">
        <svg width="26" height="26" viewBox="0 0 24 24" class="text-brand-600 fill-current transition-transform duration-300 hover:rotate-12">
          <path d="M21 7.5a5.5 5.5 0 0 1-7.53 5.09l-6.44 6.44a1.5 1.5 0 0 1-2.12-2.12l6.44-6.44A5.5 5.5 0 1 1 21 7.5Z"/>
        </svg>
        <span class="text-lg font-extrabold">Toolingo</span>
      </a>

      <!-- Nav -->
      <nav class="hidden md:flex gap-6 text-sm ml-auto items-center">
        <a href="/" class="relative transition hover:text-brand-600 after:absolute after:left-0 after:-bottom-1 after:w-0 after:h-0.5 after:bg-brand-600 after:transition-all after:duration-300 hover:after:w-full">Inicio</a>
        <a href="/catalogo/" class="relative text-brand-700 font-semibold after:absolute after:left-0 after:-bottom-1 after:w-full after:h-0.5 after:bg-brand-600">Productos</a>
        <a id="btnPublicar" href="/publicar/" class="relative transition hover:text-brand-600 after:absolute after:left-0 after:-bottom-1 after:w-0 after:h-0.5 after:bg-brand-600 after:transition-all after:duration-300 hover:after:w-full font-semibold">
          Publicar
        </a>
        <!-- Carrito en navbar -->
        <button id="cartBtn" class="relative p-2 rounded-lg hover:bg-slate-100" title="Carrito">
          üõí
          <span id="cartBadge" class="absolute -top-1 -right-1 text-[11px] px-1.5 py-0.5 rounded-full bg-brand-600 text-white hidden">0</span>
        </button>

      </nav>

      <!-- √Årea auth (derecha) -->
      <div id="authArea" class="relative"></div>
    </div>
  </header>

  <!-- Panel Carrito -->
  <div id="cartPanel" class="fixed inset-0 z-[70] hidden">
    <div class="absolute inset-0 bg-black/30" data-close-cart="true"></div>
    <aside class="absolute right-0 top-0 h-full w-full max-w-md bg-white shadow-lift border-l flex flex-col">
      <div class="px-5 py-4 border-b flex items-center justify-between">
        <h3 class="text-lg font-semibold">Mi carrito</h3>
        <button class="p-2 rounded hover:bg-slate-100" data-close-cart="true">‚úï</button>
      </div>
      <div id="cartList" class="p-4 grow overflow-y-auto space-y-3 text-sm"></div>
      <div class="p-4 border-t flex items-center justify-between">
        <div class="text-slate-600">Total: <span id="cartTotal" class="font-bold text-slate-900">$0</span></div>
        <button id="cartCheckout" class="px-4 py-2 rounded-lg bg-brand-600 text-white hover:bg-brand-700">Confirmar pedido</button>
      </div>
    </aside>
  </div>

  <script>
    // Redirige "Publicar" a login si no hay token
    (function(){
      const t = localStorage.getItem('access');
      const a = document.getElementById('btnPublicar');
      if (!t && a) a.href = '/login/?next=/publicar/';
    })();

    // ===== JWT helpers + authFetch con auto-refresh =====
    const TOKEN_KEY = 'access';
    const REFRESH_KEY = 'refresh';

    function getToken(){ return localStorage.getItem(TOKEN_KEY) || null; }
    function getRefresh(){ return localStorage.getItem(REFRESH_KEY) || null; }
    function setTokens({ access, refresh }){ if(access) localStorage.setItem(TOKEN_KEY, access); if(refresh) localStorage.setItem(REFRESH_KEY, refresh); }

    async function refreshAccessToken(){
      const refresh = getRefresh(); if(!refresh) return null;
      const r = await fetch('/api/token/refresh/', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ refresh }) });
      if(!r.ok) return null;
      const data = await r.json();
      if(data.access){ setTokens({ access: data.access }); return data.access; }
      return null;
    }

    async function authFetch(url, options = {}){
      const token = getToken();
      if(!token){ location.href = `/login/?next=${encodeURIComponent(location.pathname + location.search)}`; throw new Error('No autenticado'); }
      const headers = new Headers(options.headers || {});
      headers.set('Authorization', `Bearer ${token}`);
      if(options.body && !headers.has('Content-Type')) headers.set('Content-Type','application/json');
      let resp = await fetch(url, { ...options, headers });
      if(resp.status === 401){
        const newAccess = await refreshAccessToken();
        if(!newAccess) return resp;
        headers.set('Authorization', `Bearer ${newAccess}`);
        resp = await fetch(url, { ...options, headers });
      }
      return resp;
    }

    // --------- Carrito API ---------
    function requireLoginOrRedirect(){
      const t = getToken(); if(!t){ location.href = `/login/?next=${encodeURIComponent(location.pathname + location.search)}`; return false; }
      return true;
    }
    async function apiGetCart(){ const r = await authFetch('/api/carrito/'); if(!r.ok) throw new Error('No se pudo cargar el carrito'); return r.json(); }
    async function apiDeleteCartItem(id){ const r = await authFetch(`/api/carrito/${id}/`, { method:'DELETE' }); if(!r.ok) throw new Error('No se pudo eliminar'); }
    async function apiCheckout(){ const r = await authFetch('/api/carrito/checkout/', { method:'POST' }); if(!r.ok){ const d = await r.json().catch(()=>({})); throw new Error(d.detail || 'No se pudo confirmar el pedido'); } return r.json(); }

    // --------- Navbar Cart UI ---------
    const cartBtn = document.getElementById('cartBtn');
    const cartBadge = document.getElementById('cartBadge');
    const cartPanel = document.getElementById('cartPanel');
    const cartList = document.getElementById('cartList');
    const cartTotalEl = document.getElementById('cartTotal');

    function openCart(){ cartPanel.classList.remove('hidden'); }
    function closeCart(){ cartPanel.classList.add('hidden'); }
    cartPanel.addEventListener('click', e => { if (e.target.matches('[data-close-cart], [data-close-cart] *')) closeCart(); });

    cartBtn?.addEventListener('click', async ()=>{
      if(!requireLoginOrRedirect()) return;
      await renderCart(); openCart();
    });

    async function renderCart(){
      try{
        const items = await apiGetCart();
        // badge
        cartBadge.classList.toggle('hidden', items.length === 0);
        cartBadge.textContent = items.length;

        let total = 0;
        cartList.innerHTML = items.map(it=>{
          total += Number(it.total_estimado || 0);
          const img = it.articulo_portada ? `<img src="${it.articulo_portada}" class="h-14 w-20 rounded object-cover border" />` : `<div class="h-14 w-20 rounded bg-slate-100 border"></div>`;
          return `
            <div class="flex gap-3 items-center">
              ${img}
              <div class="min-w-0 grow">
                <div class="font-semibold truncate">${it.articulo_titulo || 'Art√≠culo'}</div>
                <div class="text-slate-500">${it.fecha_inicio} ‚Üí ${it.fecha_fin} ¬∑ ${it.dias} d√≠a(s)</div>
                <div class="font-medium">$${Number(it.total_estimado).toLocaleString('es-CO')}</div>
              </div>
              <button class="px-2 py-1 text-sm rounded border hover:bg-slate-50" data-del="${it.id}">Quitar</button>
            </div>`;
        }).join('') || `<div class="text-slate-500">Tu carrito est√° vac√≠o.</div>`;

        cartTotalEl.textContent = Number(total).toLocaleString('es-CO', { style:'currency', currency:'COP', maximumFractionDigits:0 });

        cartList.querySelectorAll('[data-del]').forEach(btn=>{
          btn.onclick = async ()=>{ await apiDeleteCartItem(btn.dataset.del); await renderCart(); };
        });
      }catch(e){
        cartList.innerHTML = `<div class="text-red-600">${e.message}</div>`;
      }
    }

    document.getElementById('cartCheckout')?.addEventListener('click', async ()=>{
      try{
        const res = await apiCheckout();
        await renderCart();
        alert(`Listo üéâ  Reservas creadas: ${res.creados.length}${res.errores.length ? `, con errores en ${res.errores.length}` : ''}`);
      }catch(e){ alert(e.message); }
    });

    // Render de bot√≥n/login o men√∫ de usuario (bonito y a la derecha)
    (function(){
      const access = localStorage.getItem('access');
      const el = document.getElementById('authArea');
      if (!el) return;

      const iconUser = `
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.42 0-8 2.24-8 5v1a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-1c0-2.76-3.58-5-8-5Z"/>
        </svg>`;

      if (!access) {
        // Estado: sin sesi√≥n ‚Üí bot√≥n "Iniciar sesi√≥n"
        el.innerHTML = `
          <a href="/login/"
             class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border border-slate-200 shadow-sm
                    text-sm hover:bg-slate-50 active:scale-[.99] transition">
            ${iconUser}
            <span>Iniciar sesi√≥n</span>
          </a>`;
        // Ocultar badge si no hay login
        document.getElementById('cartBadge')?.classList.add('hidden');
        return;
      }

      // Estado: con sesi√≥n ‚Üí bot√≥n con men√∫
      const chevron = `
        <svg class="w-4 h-4 text-slate-500" viewBox="0 0 20 20" fill="currentColor"><path d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z"/></svg>`;
      el.innerHTML = `
        <button id="btnUser" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border border-slate-200 shadow-sm
                                   text-sm hover:bg-slate-50 active:scale-[.99] transition">
          <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-brand-100 text-brand-700">üë§</span>
          <span class="font-medium">Mi cuenta</span>
          ${chevron}
        </button>
        <div id="menuUser"
             class="absolute right-0 mt-2 w-56 rounded-2xl border bg-white shadow-lg p-2 hidden">
          <a href="/perfil/" class="block px-3 py-2 rounded-lg text-sm hover:bg-slate-50">Mi perfil</a>
          <a href="/publicar/" class="block px-3 py-2 rounded-lg text-sm hover:bg-slate-50">Publicar art√≠culo</a>
          <button id="logoutBtn" class="w-full text-left px-3 py-2 rounded-lg text-sm hover:bg-slate-50 text-red-600">Cerrar sesi√≥n</button>
        </div>`;

      const btn = document.getElementById('btnUser');
      const menu = document.getElementById('menuUser');
      const out  = document.getElementById('logoutBtn');

      const toggle = () => menu.classList.toggle('hidden');
      const closeOutside = (e) => { if (!menu.contains(e.target) && !btn.contains(e.target)) menu.classList.add('hidden'); };
      const logout = () => { localStorage.clear(); location.reload(); };

      btn.addEventListener('click', toggle);
      document.addEventListener('click', closeOutside);
      out.addEventListener('click', logout);

      // Inicializa badge del carrito cuando hay login
      (async () => {
        try{
          const items = await apiGetCart();
          const badge = document.getElementById('cartBadge');
          badge.classList.toggle('hidden', items.length === 0);
          badge.textContent = items.length;
        }catch(_){}
      })();
    })();
  </script>

  <!-- Contenido -->
  <main class="max-w-6xl mx-auto px-4 py-8">
    <h1 class="text-2xl md:text-3xl font-bold">Cat√°logo de productos</h1>
    <p class="text-slate-600 mt-1">Explora por categor√≠a, subcategor√≠a, precio y ubicaci√≥n.</p>

    <!-- Filtros -->
    <section class="mt-6 p-4 border rounded-2xl bg-white shadow-sm transition hover:shadow-md">
      <form id="filters" class="grid md:grid-cols-5 gap-3 items-end">
        <div class="md:col-span-2">
          <label class="text-sm text-slate-600">Buscar (texto)</label>
          <input id="q" type="text" class="w-full border rounded-xl px-3 py-2 transition focus:ring-2 focus:ring-brand-100 outline-none" placeholder="taladro, generador..." />
        </div>
        <div>
          <label class="text-sm text-slate-600">Precio m√≠n</label>
          <input id="pmin" type="number" class="w-full border rounded-xl px-3 py-2 transition focus:ring-2 focus:ring-brand-100 outline-none" placeholder="10000" />
        </div>
        <div>
          <label class="text-sm text-slate-600">Precio m√°x</label>
          <input id="pmax" type="number" class="w-full border rounded-xl px-3 py-2 transition focus:ring-2 focus:ring-brand-100 outline-none" placeholder="100000" />
        </div>
        <div>
          <label class="text-sm text-slate-600">Ubicaci√≥n</label>
          <input id="ubi" type="text" class="w-full border rounded-xl px-3 py-2 transition focus:ring-2 focus:ring-brand-100 outline-none" placeholder="Medell√≠n..." />
        </div>

        <div class="md:col-span-5 flex gap-3">
          <button class="px-4 py-2 rounded-xl bg-brand-600 text-white transition transform hover:bg-brand-700 hover:-translate-y-0.5" type="submit">Aplicar filtros</button>
          <button id="clear" class="px-4 py-2 rounded-xl border transition hover:bg-slate-50 hover:-translate-y-0.5" type="button">Limpiar</button>
        </div>
      </form>
    </section>

    <!-- Layout: sidebar categor√≠as + grid productos -->
    <section class="mt-6 grid md:grid-cols-12 gap-6">
      <!-- Sidebar categor√≠as -->
      <aside class="md:col-span-4 lg:col-span-3">
        <div class="p-4 border rounded-2xl bg-white shadow-sm">
          <div class="flex items-center justify-between">
            <h2 class="font-semibold">Categor√≠as</h2>
            <a id="verTodos" href="/catalogo/" class="text-sm text-brand-700 transition hover:underline hover:translate-x-0.5 inline-block">Ver todos</a>
          </div>
          <div id="cats" class="mt-3 space-y-2 text-sm"></div>
        </div>
      </aside>

      <!-- Resultados -->
      <div class="md:col-span-8 lg:col-span-9">
        <div id="status" class="text-sm text-slate-500"></div>
        <div id="grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6 mt-3"></div>
        <div id="pager" class="mt-6 flex items-center gap-3"></div>
      </div>
    </section>
  </main>

  <footer class="py-10 text-center text-sm text-slate-500">¬© <span id="y"></span> Toolingo</footer>
  <script>document.getElementById('y').textContent = new Date().getFullYear()</script>

  <script>
    const qs = new URLSearchParams(location.search);
    const byId = s => document.getElementById(s);
    const fmt = n => Number(n).toLocaleString('es-CO');
    let CATS = [], ITEMS = [], PAGE = parseInt(qs.get('page') || '1');
    const PER_PAGE = 9;

    async function loadCategorias() {
      const el = byId('cats');
      el.innerHTML = 'Cargando categor√≠as...';
      const r = await fetch('/api/categorias/');
      CATS = await r.json();
      const byParent = {};
      CATS.forEach(c => {
        const pid = c.parent || 'root';
        (byParent[pid] ||= []).push(c);
      });
      function renderNode(parentId, level=0) {
        const arr = byParent[parentId] || [];
        return arr.map(c => {
          const isSelectedCat = qs.get('cat') === c.slug;
          const isSelectedSub = qs.get('subcat') === c.slug;
          const children = renderNode(c.id, level+1);
          const pad = `style="padding-left:${level*8}px"`;
          const base = "block py-1 transition inline-block hover:translate-x-1";
          const link = children.length
            ? `<a ${pad} class="${base} ${isSelectedCat ? 'text-brand-700 font-semibold' : 'hover:text-brand-700'}" href="/catalogo/?cat=${c.slug}${filtersToQS()}">${c.nombre}</a>`
            : `<a ${pad} class="${base} ${isSelectedSub ? 'text-brand-700 font-semibold' : 'hover:text-brand-700'}" href="/catalogo/?subcat=${c.slug}${filtersToQS()}">${c.nombre}</a>`;
          return `<div>${link}${children.join('')}</div>`;
        });
      }
      el.innerHTML = renderNode('root').join('');
    }

    function filtersToQS() {
      const q = byId('q').value.trim();
      const pmin = byId('pmin').value.trim();
      const pmax = byId('pmax').value.trim();
      const ubi = byId('ubi').value.trim();
      const params = new URLSearchParams();
      if (q) params.set('q', q);
      if (pmin) params.set('pmin', pmin);
      if (pmax) params.set('pmax', pmax);
      if (ubi) params.set('ubi', ubi);
      if (PAGE > 1) params.set('page', PAGE);
      const s = params.toString();
      return s ? '&' + s : '';
    }

    function leafSlugsUnderCatSlug(slug) {
      const slugToCat = {}; CATS.forEach(c => slugToCat[c.slug] = c);
      const start = slugToCat[slug]; if (!start) return [];
      const children = {}; CATS.forEach(c => { if (c.parent) (children[c.parent] ||= []).push(c); });
      const leaves = [];
      function dfs(node) {
        const childs = children[node.id] || [];
        if (childs.length === 0) { leaves.push(node.slug); return; }
        childs.forEach(dfs);
      }
      dfs(start); return leaves;
    }

    async function loadArticulos() {
      const status = byId('status'), grid = byId('grid');
      grid.innerHTML = ''; status.textContent = 'Cargando art√≠culos...';
      const q = qs.get('q') || byId('q').value.trim();
      const pmin = qs.get('pmin') || byId('pmin').value.trim();
      const pmax = qs.get('pmax') || byId('pmax').value.trim();
      const ubi  = qs.get('ubi') || byId('ubi').value.trim();
      const subcat = qs.get('subcat'); const cat = qs.get('cat');
      const urls = [];
      function buildUrl(slug){
        const u = new URL(location.origin + '/api/articulos/');
        u.searchParams.set('ordering', '-creado');
        if (slug) u.searchParams.set('categoria', slug);
        if (pmin) u.searchParams.set('precio_min', pmin);
        if (pmax) u.searchParams.set('precio_max', pmax);
        if (ubi)  u.searchParams.set('ubicacion', ubi);
        return u.toString();
      }
      if (subcat) { urls.push(buildUrl(subcat)); }
      else if (cat) { leafSlugsUnderCatSlug(cat).forEach(s => urls.push(buildUrl(s))); }
      else { urls.push(buildUrl(null)); }
      const results = await Promise.all(urls.map(u => fetch(u).then(r => r.json())));
      let items = results.flat();
      const qlow = (q || '').toLowerCase();
      if (qlow) items = items.filter(a => a.titulo.toLowerCase().includes(qlow) || (a.descripcion||'').toLowerCase().includes(qlow));
      ITEMS = items; renderPage();
      status.textContent = `Mostrando ${ITEMS.length} resultado(s)`;
    }

    function renderCard(a) {
      const imgUrl = a.portada || (a.imagenes && a.imagenes[0] && a.imagenes[0].url) || null;
      const imgTag = imgUrl
        ? `<img src="${imgUrl}" alt="${a.titulo}" class="w-full h-36 object-cover rounded-xl bg-brand-100 mb-4">`
        : `<div class="h-36 rounded-xl bg-brand-100 mb-4"></div>`;

      return `
        <article class="rounded-2xl border bg-white shadow-sm p-5 transition transform hover:scale-105 hover:shadow-lg">
          <a href="/articulo/${a.id}/" class="block">
            ${imgTag}
            <h3 class="font-semibold line-clamp-1">${a.titulo}</h3>
            <p class="text-sm text-slate-500">
              ${a.ubicacion || ''} ‚Ä¢ $${fmt(a.precio_por_dia)}/d√≠a
            </p>
          </a>
          <div class="mt-2 flex items-center justify-between text-sm">
            <a href="/articulo/${a.id}/" class="text-brand-700 hover:underline">Ver detalle</a>
            <a href="/api/articulos/${a.id}/" target="_blank" rel="noopener" class="text-slate-400 hover:underline">API</a>
          </div>
        </article>
      `;
    }

    function renderPage() {
      const grid = byId('grid'), pager = byId('pager');
      const total = ITEMS.length, pages = Math.max(1, Math.ceil(total / PER_PAGE));
      if (PAGE > pages) PAGE = pages;
      const start = (PAGE - 1) * PER_PAGE, slice = ITEMS.slice(start, start + PER_PAGE);
      grid.innerHTML = slice.map(renderCard).join('');
      pager.innerHTML = `
        <button ${PAGE<=1?'disabled':''} class="px-3 py-1.5 border rounded-xl transition ${PAGE<=1?'opacity-50':''}" onclick="goPage(${PAGE-1})">Anterior</button>
        <span class="text-sm">P√°gina ${PAGE} de ${pages}</span>
        <button ${PAGE>=pages?'disabled':''} class="px-3 py-1.5 border rounded-xl transition ${PAGE>=pages?'opacity-50':''}" onclick="goPage(${PAGE+1})">Siguiente</button>
      `;
    }
    function goPage(p) {
      if (p<1) return; PAGE = p;
      const params = new URLSearchParams(location.search);
      if (PAGE>1) params.set('page', PAGE); else params.delete('page');
      history.replaceState({}, '', `${location.pathname}?${params.toString()}`);
      renderPage();
    }

    byId('filters').addEventListener('submit', (e) => {
      e.preventDefault(); PAGE = 1;
      const params = new URLSearchParams(location.search);
      ['q','pmin','pmax','ubi'].forEach(k => { const v = byId(k).value.trim(); if (v) params.set(k, v); else params.delete(k); });
      history.pushState({}, '', `${location.pathname}?${params.toString()}`); loadArticulos();
    });
    byId('clear').addEventListener('click', () => {
      ['q','pmin','pmax','ubi'].forEach(k => byId(k).value='');
      history.pushState({}, '', '/catalogo/'); PAGE = 1; loadArticulos();
    });
    (function primeFiltersFromQS(){ ['q','pmin','pmax','ubi'].forEach(k => { const v = qs.get(k); if (v) byId(k).value = v; }); })();
    (async function init(){
      await loadCategorias();
      await loadArticulos();
    })();
  </script>
</body>
</html>
