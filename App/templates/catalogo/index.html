<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cat√°logo ‚Äì Toolingo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: { colors: {
        brand: { 600:'#f97316',700:'#c2410c',100:'#ffedd5',50:'#fff7ed' }
      }}}
    }
  </script>
</head>
<body class="text-slate-800">
  <!-- Navbar -->
  <header class="sticky top-0 bg-white/80 backdrop-blur border-b border-slate-200 z-50">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-6">
      <!-- Logo -->
      <a href="/" class="flex items-center gap-2">
        <svg width="26" height="26" viewBox="0 0 24 24" class="text-brand-600 fill-current transition-transform duration-300 hover:rotate-12">
          <path d="M21 7.5a5.5 5.5 0 0 1-7.53 5.09l-6.44 6.44a1.5 1.5 0 0 1-2.12-2.12l6.44-6.44A5.5 5.5 0 1 1 21 7.5Z"/>
        </svg>
        <span class="text-lg font-extrabold">Toolingo</span>
      </a>

      <!-- Nav -->
      <nav class="hidden md:flex gap-6 text-sm ml-auto">
        <a href="/" class="relative transition hover:text-brand-600 after:absolute after:left-0 after:-bottom-1 after:w-0 after:h-0.5 after:bg-brand-600 after:transition-all after:duration-300 hover:after:w-full">Inicio</a>
        <a href="/catalogo/" class="relative text-brand-700 font-semibold after:absolute after:left-0 after:-bottom-1 after:w-full after:h-0.5 after:bg-brand-600">Productos</a>
        <a href="/api/docs/" class="relative transition hover:text-brand-600 after:absolute after:left-0 after:-bottom-1 after:w-0 after:h-0.5 after:bg-brand-600 after:transition-all after:duration-300 hover:after:w-full">API</a>
        <a id="btnPublicar" href="/publicar/" class="relative transition hover:text-brand-600 after:absolute after:left-0 after:-bottom-1 after:w-0 after:h-0.5 after:bg-brand-600 after:transition-all after:duration-300 hover:after:w-full font-semibold">
          Publicar
        </a>
      </nav>

      <!-- √Årea auth (derecha) -->
      <div id="authArea" class="relative"></div>
    </div>
  </header>

  <script>
    // Redirige "Publicar" a login si no hay token
    (function(){
      const t = localStorage.getItem('access');
      const a = document.getElementById('btnPublicar');
      if (!t && a) a.href = '/login/?next=/publicar/';
    })();

    // Render de bot√≥n/login o men√∫ de usuario (bonito y a la derecha)
    (function(){
      const access = localStorage.getItem('access');
      const el = document.getElementById('authArea');
      if (!el) return;

      const iconUser = `
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.42 0-8 2.24-8 5v1a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-1c0-2.76-3.58-5-8-5Z"/>
        </svg>`;

      if (!access) {
        // Estado: sin sesi√≥n ‚Üí bot√≥n "Iniciar sesi√≥n" pro
        el.innerHTML = `
          <a href="/login/"
             class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border border-slate-200 shadow-sm
                    text-sm hover:bg-slate-50 active:scale-[.99] transition">
            ${iconUser}
            <span>Iniciar sesi√≥n</span>
          </a>`;
        return;
      }

      // Estado: con sesi√≥n ‚Üí bot√≥n con men√∫
      const chevron = `
        <svg class="w-4 h-4 text-slate-500" viewBox="0 0 20 20" fill="currentColor"><path d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z"/></svg>`;
      el.innerHTML = `
        <button id="btnUser" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border border-slate-200 shadow-sm
                                   text-sm hover:bg-slate-50 active:scale-[.99] transition">
          <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-brand-100 text-brand-700">üë§</span>
          <span class="font-medium">Mi cuenta</span>
          ${chevron}
        </button>
        <div id="menuUser"
             class="absolute right-0 mt-2 w-56 rounded-2xl border bg-white shadow-lg p-2 hidden">
          <a href="/perfil/" class="block px-3 py-2 rounded-lg text-sm hover:bg-slate-50">Mi perfil</a>
          <a href="/publicar/" class="block px-3 py-2 rounded-lg text-sm hover:bg-slate-50">Publicar art√≠culo</a>
          <button id="logoutBtn" class="w-full text-left px-3 py-2 rounded-lg text-sm hover:bg-slate-50 text-red-600">Cerrar sesi√≥n</button>
        </div>`;

      const btn = document.getElementById('btnUser');
      const menu = document.getElementById('menuUser');
      const out  = document.getElementById('logoutBtn');

      const toggle = () => menu.classList.toggle('hidden');
      const closeOutside = (e) => {
        if (!menu.contains(e.target) && !btn.contains(e.target)) menu.classList.add('hidden');
      };
      const logout = () => { localStorage.clear(); location.reload(); };

      btn.addEventListener('click', toggle);
      document.addEventListener('click', closeOutside);
      out.addEventListener('click', logout);
    })();
  </script>

  <!-- Contenido -->
  <main class="max-w-6xl mx-auto px-4 py-8">
    <h1 class="text-2xl md:text-3xl font-bold">Cat√°logo de productos</h1>
    <p class="text-slate-600 mt-1">Explora por categor√≠a, subcategor√≠a, precio y ubicaci√≥n.</p>

    <!-- Filtros -->
    <section class="mt-6 p-4 border rounded-2xl bg-white shadow-sm transition hover:shadow-md">
      <form id="filters" class="grid md:grid-cols-5 gap-3 items-end">
        <div class="md:col-span-2">
          <label class="text-sm text-slate-600">Buscar (texto)</label>
          <input id="q" type="text" class="w-full border rounded-xl px-3 py-2 transition focus:ring-2 focus:ring-brand-100 outline-none" placeholder="taladro, generador..." />
        </div>
        <div>
          <label class="text-sm text-slate-600">Precio m√≠n</label>
          <input id="pmin" type="number" class="w-full border rounded-xl px-3 py-2 transition focus:ring-2 focus:ring-brand-100 outline-none" placeholder="10000" />
        </div>
        <div>
          <label class="text-sm text-slate-600">Precio m√°x</label>
          <input id="pmax" type="number" class="w-full border rounded-xl px-3 py-2 transition focus:ring-2 focus:ring-brand-100 outline-none" placeholder="100000" />
        </div>
        <div>
          <label class="text-sm text-slate-600">Ubicaci√≥n</label>
          <input id="ubi" type="text" class="w-full border rounded-xl px-3 py-2 transition focus:ring-2 focus:ring-brand-100 outline-none" placeholder="Medell√≠n..." />
        </div>

        <div class="md:col-span-5 flex gap-3">
          <button class="px-4 py-2 rounded-xl bg-brand-600 text-white transition transform hover:bg-brand-700 hover:-translate-y-0.5" type="submit">Aplicar filtros</button>
          <button id="clear" class="px-4 py-2 rounded-xl border transition hover:bg-slate-50 hover:-translate-y-0.5" type="button">Limpiar</button>
        </div>
      </form>
    </section>

    <!-- Layout: sidebar categor√≠as + grid productos -->
    <section class="mt-6 grid md:grid-cols-12 gap-6">
      <!-- Sidebar categor√≠as -->
      <aside class="md:col-span-4 lg:col-span-3">
        <div class="p-4 border rounded-2xl bg-white shadow-sm">
          <div class="flex items-center justify-between">
            <h2 class="font-semibold">Categor√≠as</h2>
            <a id="verTodos" href="/catalogo/" class="text-sm text-brand-700 transition hover:underline hover:translate-x-0.5 inline-block">Ver todos</a>
          </div>
          <div id="cats" class="mt-3 space-y-2 text-sm"></div>
        </div>
      </aside>

      <!-- Resultados -->
      <div class="md:col-span-8 lg:col-span-9">
        <div id="status" class="text-sm text-slate-500"></div>
        <div id="grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6 mt-3"></div>
        <div id="pager" class="mt-6 flex items-center gap-3"></div>
      </div>
    </section>
  </main>

  <footer class="py-10 text-center text-sm text-slate-500">¬© <span id="y"></span> Toolingo</footer>
  <script>document.getElementById('y').textContent = new Date().getFullYear()</script>

  <script>
    const qs = new URLSearchParams(location.search);
    const byId = s => document.getElementById(s);
    const fmt = n => Number(n).toLocaleString('es-CO');
    let CATS = [], ITEMS = [], PAGE = parseInt(qs.get('page') || '1');
    const PER_PAGE = 9;

    async function loadCategorias() {
      const el = byId('cats');
      el.innerHTML = 'Cargando categor√≠as...';
      const r = await fetch('/api/categorias/');
      CATS = await r.json();
      const byParent = {};
      CATS.forEach(c => {
        const pid = c.parent || 'root';
        (byParent[pid] ||= []).push(c);
      });
      function renderNode(parentId, level=0) {
        const arr = byParent[parentId] || [];
        return arr.map(c => {
          const isSelectedCat = qs.get('cat') === c.slug;
          const isSelectedSub = qs.get('subcat') === c.slug;
          const children = renderNode(c.id, level+1);
          const pad = `style="padding-left:${level*8}px"`;
          const base = "block py-1 transition inline-block hover:translate-x-1";
          const link = children.length
            ? `<a ${pad} class="${base} ${isSelectedCat ? 'text-brand-700 font-semibold' : 'hover:text-brand-700'}" href="/catalogo/?cat=${c.slug}${filtersToQS()}">${c.nombre}</a>`
            : `<a ${pad} class="${base} ${isSelectedSub ? 'text-brand-700 font-semibold' : 'hover:text-brand-700'}" href="/catalogo/?subcat=${c.slug}${filtersToQS()}">${c.nombre}</a>`;
          return `<div>${link}${children.join('')}</div>`;
        });
      }
      el.innerHTML = renderNode('root').join('');
    }

    function filtersToQS() {
      const q = byId('q').value.trim();
      const pmin = byId('pmin').value.trim();
      const pmax = byId('pmax').value.trim();
      const ubi = byId('ubi').value.trim();
      const params = new URLSearchParams();
      if (q) params.set('q', q);
      if (pmin) params.set('pmin', pmin);
      if (pmax) params.set('pmax', pmax);
      if (ubi) params.set('ubi', ubi);
      if (PAGE > 1) params.set('page', PAGE);
      const s = params.toString();
      return s ? '&' + s : '';
    }

    function leafSlugsUnderCatSlug(slug) {
      const slugToCat = {}; CATS.forEach(c => slugToCat[c.slug] = c);
      const start = slugToCat[slug]; if (!start) return [];
      const children = {}; CATS.forEach(c => { if (c.parent) (children[c.parent] ||= []).push(c); });
      const leaves = [];
      function dfs(node) {
        const childs = children[node.id] || [];
        if (childs.length === 0) { leaves.push(node.slug); return; }
        childs.forEach(dfs);
      }
      dfs(start); return leaves;
    }

    async function loadArticulos() {
      const status = byId('status'), grid = byId('grid');
      grid.innerHTML = ''; status.textContent = 'Cargando art√≠culos...';
      const q = qs.get('q') || byId('q').value.trim();
      const pmin = qs.get('pmin') || byId('pmin').value.trim();
      const pmax = qs.get('pmax') || byId('pmax').value.trim();
      const ubi  = qs.get('ubi') || byId('ubi').value.trim();
      const subcat = qs.get('subcat'); const cat = qs.get('cat');
      const urls = [];
      function buildUrl(slug){
        const u = new URL(location.origin + '/api/articulos/');
        u.searchParams.set('ordering', '-creado');
        if (slug) u.searchParams.set('categoria', slug);
        if (pmin) u.searchParams.set('precio_min', pmin);
        if (pmax) u.searchParams.set('precio_max', pmax);
        if (ubi)  u.searchParams.set('ubicacion', ubi);
        return u.toString();
      }
      if (subcat) { urls.push(buildUrl(subcat)); }
      else if (cat) { leafSlugsUnderCatSlug(cat).forEach(s => urls.push(buildUrl(s))); }
      else { urls.push(buildUrl(null)); }
      const results = await Promise.all(urls.map(u => fetch(u).then(r => r.json())));
      let items = results.flat();
      const qlow = (q || '').toLowerCase();
      if (qlow) items = items.filter(a => a.titulo.toLowerCase().includes(qlow) || (a.descripcion||'').toLowerCase().includes(qlow));
      ITEMS = items; renderPage();
      status.textContent = `Mostrando ${ITEMS.length} resultado(s)`;
    }

    function renderCard(a) {
      const imgUrl = a.portada || (a.imagenes && a.imagenes[0] && a.imagenes[0].url) || null;
      const imgTag = imgUrl
        ? `<img src="${imgUrl}" alt="${a.titulo}" class="w-full h-36 object-cover rounded-xl bg-brand-100 mb-4">`
        : `<div class="h-36 rounded-xl bg-brand-100 mb-4"></div>`;
      return `
        <article class="rounded-2xl border bg-white shadow-sm p-5 transition transform hover:scale-105 hover:shadow-lg">
          ${imgTag}
          <h3 class="font-semibold line-clamp-1">${a.titulo}</h3>
          <p class="text-sm text-slate-500">${a.ubicacion || ''} ‚Ä¢ $${fmt(a.precio_por_dia)}/d√≠a</p>
          <div class="mt-3">
            <a class="text-sm text-brand-700 hover:underline" href="/api/articulos/${a.id}/">Ver detalle (API)</a>
          </div>
        </article>
      `;
    }

    function renderPage() {
      const grid = byId('grid'), pager = byId('pager');
      const total = ITEMS.length, pages = Math.max(1, Math.ceil(total / PER_PAGE));
      if (PAGE > pages) PAGE = pages;
      const start = (PAGE - 1) * PER_PAGE, slice = ITEMS.slice(start, start + PER_PAGE);
      grid.innerHTML = slice.map(renderCard).join('');
      pager.innerHTML = `
        <button ${PAGE<=1?'disabled':''} class="px-3 py-1.5 border rounded-xl transition ${PAGE<=1?'opacity-50':''}" onclick="goPage(${PAGE-1})">Anterior</button>
        <span class="text-sm">P√°gina ${PAGE} de ${pages}</span>
        <button ${PAGE>=pages?'disabled':''} class="px-3 py-1.5 border rounded-xl transition ${PAGE>=pages?'opacity-50':''}" onclick="goPage(${PAGE+1})">Siguiente</button>
      `;
    }
    function goPage(p) {
      if (p<1) return; PAGE = p;
      const params = new URLSearchParams(location.search);
      if (PAGE>1) params.set('page', PAGE); else params.delete('page');
      history.replaceState({}, '', `${location.pathname}?${params.toString()}`);
      renderPage();
    }

    byId('filters').addEventListener('submit', (e) => {
      e.preventDefault(); PAGE = 1;
      const params = new URLSearchParams(location.search);
      ['q','pmin','pmax','ubi'].forEach(k => { const v = byId(k).value.trim(); if (v) params.set(k, v); else params.delete(k); });
      history.pushState({}, '', `${location.pathname}?${params.toString()}`); loadArticulos();
    });
    byId('clear').addEventListener('click', () => {
      ['q','pmin','pmax','ubi'].forEach(k => byId(k).value='');
      history.pushState({}, '', '/catalogo/'); PAGE = 1; loadArticulos();
    });
    (function primeFiltersFromQS(){ ['q','pmin','pmax','ubi'].forEach(k => { const v = qs.get(k); if (v) byId(k).value = v; }); })();
    (async function init(){ await loadCategorias(); await loadArticulos(); })();
  </script>
</body>
</html>
