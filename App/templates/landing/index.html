{% load static %}

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Toolingo – Alquiler de equipos y herramientas</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50:'#fff7ed',100:'#ffedd5',200:'#fed7aa',300:'#fdba74',
              400:'#fb923c',500:'#f97316',600:'#ea580c',700:'#c2410c'
            }
          },
          boxShadow: { soft: '0 8px 24px rgba(15,23,42,.06)' }
        }
      }
    }
  </script>

  <!-- Estilos extra -->
  <style>
    /* Magnetic row */
    .rail { transition: transform 250ms cubic-bezier(.22,.61,.36,1), filter 250ms; will-change: transform; }
    .rail.has-hover > .card-pro:not(.is-hover) { opacity: .9; transform: translateY(0) scale(.985); filter: saturate(.95); }
    .card-pro { transition: transform 220ms cubic-bezier(.22,.61,.36,1), box-shadow 220ms, opacity 220ms, filter 220ms; will-change: transform, box-shadow, filter; }
    .card-pro.is-hover { transform: translateY(-6px); box-shadow: 0 14px 40px rgba(15,23,42,.12); filter: saturate(1.02); }

    /* TOC lateral */
    .toc a { display:block; padding:.5rem .75rem; border-radius:.6rem; color:#334155; font-size:.925rem; }
    .toc a:hover { background:#f1f5f9; }
    .toc a.active { color:#ea580c; background:#fff7ed; font-weight:600; }

    html { scroll-behavior: smooth; } /* fallback; clics tienen offset JS */
  </style>
</head>
<body class="text-slate-800 bg-white">

  <!-- Navbar -->
  <header class="sticky top-0 bg-white/80 backdrop-blur border-b border-slate-200 z-50">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-6">
      <a href="/" class="flex items-center gap-2">
        <svg width="28" height="28" viewBox="0 0 24 24" class="text-brand-600 fill-current transition-transform duration-300 hover:rotate-12">
          <path d="M21 7.5a5.5 5.5 0 0 1-7.53 5.09l-6.44 6.44a1.5 1.5 0 0 1-2.12-2.12l6.44-6.44A5.5 5.5 0 1 1 21 7.5Z"/>
        </svg>
        <span class="text-xl font-extrabold">Toolingo</span>
      </a>

      <nav class="hidden md:flex gap-6 text-sm ml-auto">
        <a href="/catalogo/" class="relative font-semibold transition hover:text-brand-600">Productos</a>
      </nav>

      <!-- User menu mount point -->
      <div id="userMenuMount" class="relative"></div>
    </div>
  </header>

  <!-- Hero -->
  <section class="bg-brand-50">
    <div class="max-w-6xl mx-auto px-4 py-16 grid md:grid-cols-2 gap-10 items-center">
      <div>
        <h1 class="text-4xl md:text-5xl font-extrabold leading-tight">
          Toolingo es el <span class="text-brand-600">marketplace</span> para
          alquilar equipos y herramientas cerca de ti.
        </h1>
        <p class="mt-4 text-slate-700 text-lg">
          Publica tus herramientas como propietario o encuentra la indicada para tu proyecto como arrendatario.
          Seguro, rápido y con calificaciones verificadas.
        </p>
        <div class="mt-6 flex gap-3">
          <a href="#servicios" class="px-5 py-3 rounded-xl bg-brand-600 text-white transition transform hover:bg-brand-700 hover:-translate-y-1">Explorar servicios</a>
        </div>
        <div class="mt-6 text-sm text-slate-600">+ Disponibilidad por días • + Depósito opcional • + Pagos seguros</div>
      </div>

      <!-- Búsqueda -->
      <div class="bg-white rounded-2xl shadow-soft p-6 border border-slate-100 transition hover:shadow-lg">
        <div class="grid md:grid-cols-3 gap-4">
          <div class="md:col-span-2">
            <div class="text-sm mb-2 text-slate-500">Búsqueda rápida</div>
            <form id="searchForm" class="flex gap-2">
              <input id="searchInput"
                     class="w-full border rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-brand-200 transition"
                     placeholder="¿Qué herramienta necesitas?" />
              <button class="px-4 rounded-xl bg-brand-600 text-white transition hover:bg-brand-700 hover:-translate-y-0.5">Buscar</button>
            </form>
            <div id="searchResults" class="mt-4 space-y-2"></div>
            <div class="mt-3 text-xs text-slate-500">
              ¿No ves lo que buscas? <a class="text-brand-700 hover:underline" href="/catalogo/">Ir al catálogo completo</a>.
            </div>
          </div>
          <div class="flex">
            <div class="rounded-2xl shadow-sm p-4 border border-slate-200 transition hover:shadow-lg w-full">
              <div class="text-sm mb-2 font-semibold text-gray-700"></div>
              <div class="mt-3 text-xs text-gray-500 space-y-2">
                <p>Prueba el buscador con <span class="font-medium text-slate-700">“taladro”, “andamio”, “mezcladora”</span>.</p>
                <p>Se muestran hasta 5 resultados recientes.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- /tarjeta -->
    </div>
  </section>

  <!-- Contenido principal con sidebar -->
  <main class="max-w-6xl mx-auto px-4 mt-16 lg:grid lg:grid-cols-[270px_1fr] lg:gap-10">

    <!-- TOC lateral (solo desktop) -->
    <aside class="toc sticky top-24 self-start hidden lg:block">
      <div class="bg-slate-60 border border-slate-200 rounded-xl p-4">
        <div class="text-xs uppercase tracking-wide text-slate-400 mb-3">En esta página</div>

        <div class="relative pl-4">
          <div class="absolute left-0 top-0 w-1 rounded-full bg-slate-200 h-full"></div>
          <div id="tocProgress" class="absolute left-0 top-0 w-1 rounded-full bg-brand-600" style="height:0%"></div>

          <nav class="space-y-1">
            <a href="#como" data-target="como">¿Cómo funciona?</a>
            <a href="#servicios" data-target="servicios">Servicios principales</a>
            <a href="#destacados" data-target="destacados">Artículos destacados</a>
          </nav>
        </div>
      </div>
    </aside>

    <!-- Columna de contenido -->
    <div class="min-w-0">
      <div class="h-12 lg:h-16"></div>

      <!-- Cómo funciona -->
      <section id="como" class="py-16">
        <h2 class="text-2xl md:text-3xl font-extrabold tracking-tight">¿Cómo funciona Toolingo?</h2>
        <p class="mt-1 text-slate-600">Tres pasos sencillos para rentar o publicar:</p>

        <div id="gridComo" class="rail grid md:grid-cols-3 gap-6 mt-6">
          <div class="card-pro p-6 rounded-2xl border border-slate-200 bg-white shadow-soft">
            <div class="flex items-center gap-4 mb-3">
              <div class="h-10 w-10 rounded-full bg-brand-100 text-brand-700 grid place-items-center font-bold">1</div>
              <h3 class="font-semibold text-lg tracking-tight">Explora</h3>
            </div>
            <p class="text-slate-600 leading-relaxed">Filtra por categoría, ubicación y precio por día.</p>
          </div>
          <div class="card-pro p-6 rounded-2xl border border-slate-200 bg-white shadow-soft">
            <div class="flex items-center gap-4 mb-3">
              <div class="h-10 w-10 rounded-full bg-brand-100 text-brand-700 grid place-items-center font-bold">2</div>
              <h3 class="font-semibold text-lg tracking-tight">Reserva</h3>
            </div>
            <p class="text-slate-600 leading-relaxed">Elige fechas disponibles y realiza el pago seguro.</p>
          </div>
          <div class="card-pro p-6 rounded-2xl border border-slate-200 bg-white shadow-soft">
            <div class="flex items-center gap-4 mb-3">
              <div class="h-10 w-10 rounded-full bg-brand-100 text-brand-700 grid place-items-center font-bold">3</div>
              <h3 class="font-semibold text-lg tracking-tight">Califica</h3>
            </div>
            <p class="text-slate-600 leading-relaxed">Entrega/recibe el equipo y deja tu calificación.</p>
          </div>
        </div>
      </section>

      <!-- Servicios -->
      <section id="servicios" class="py-16">
        <h2 class="text-2xl md:text-3xl font-extrabold tracking-tight">Servicios principales</h2>
        <p class="text-slate-600 mt-1">Alquila por día herramientas para construcción, jardinería y más.</p>

        <div id="gridServicios" class="rail grid sm:grid-cols-2 md:grid-cols-3 gap-6 mt-6">
          <div class="card-pro p-6 rounded-2xl bg-white border border-slate-200 shadow-soft">
            <span class="inline-block text-sm font-semibold text-brand-700 bg-brand-50 px-2 py-1 rounded">Construcción</span>
            <div class="mt-2 text-slate-700">Demoledores, mezcladoras, compactadoras</div>
          </div>
          <div class="card-pro p-6 rounded-2xl bg-white border border-slate-200 shadow-soft">
            <span class="inline-block text-sm font-semibold text-brand-700 bg-brand-50 px-2 py-1 rounded">Eléctricas</span>
            <div class="mt-2 text-slate-700">Taladros, esmeriles, sierras</div>
          </div>
          <div class="card-pro p-6 rounded-2xl bg-white border border-slate-200 shadow-soft">
            <span class="inline-block text-sm font-semibold text-brand-700 bg-brand-50 px-2 py-1 rounded">Alturas</span>
            <div class="mt-2 text-slate-700">Andamios, escaleras</div>
          </div>
        </div>
      </section>

      <!-- Destacados -->
      <section id="destacados" class="py-16">
        <div class="flex items-end justify-between">
          <h2 class="text-2xl md:text-3xl font-extrabold tracking-tight">Artículos destacados</h2>
          <a href="/catalogo/" class="text-sm text-brand-700 hover:underline">Ver todo</a>
        </div>

        <div id="gridDest" class="rail grid sm:grid-cols-2 lg:grid-cols-3 gap-6 mt-6"></div>

        <template id="card-skeleton">
          <article class="rounded-2xl border border-slate-200 bg-white shadow-soft p-4 animate-pulse">
            <div class="h-44 rounded-xl bg-slate-100 mb-4"></div>
            <div class="h-4 w-2/3 bg-slate-100 rounded mb-2"></div>
            <div class="h-3 w-1/3 bg-slate-100 rounded"></div>
          </article>
        </template>
      </section>

      <!-- CTA -->
      <section class="py-16 bg-brand-600 text-white rounded-2xl mb-16">
        <div class="px-6 md:px-10 text-center">
          <h2 class="text-3xl font-bold tracking-tight">¿Listo para publicar o alquilar?</h2>
          <p class="mt-2 text-brand-100">Crea tu cuenta y empieza a generar ingresos con tus herramientas.</p>
          <div class="mt-6">
            <a href="/login/?next=/publicar/"
               class="px-6 py-3 bg-white text-brand-700 rounded-xl font-semibold transition transform hover:bg-slate-100 hover:-translate-y-1">
              Inicia sesión
            </a>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- JS -->
  <script>
    const fmtCOP = n => Number(n||0).toLocaleString('es-CO');

    // Tarjeta de destacado -> enlace a /articulo/<id>/
    function cardArticulo(a){
      const imgUrl = a.portada || (a.imagenes && a.imagenes[0]?.url) || null;
      const price  = a.precio_por_dia ? `$${fmtCOP(a.precio_por_dia)}/día` : '';
      const ubic   = a.ubicacion ? `<span class="inline-flex items-center px-2 py-0.5 rounded-full bg-slate-100">${a.ubicacion}</span>` : '';

      return `
        <article class="card-pro group rounded-2xl border border-slate-200 bg-white shadow-soft overflow-hidden transition hover:-translate-y-1 hover:shadow-lg">
          <a href="/articulo/${a.id}/" class="block" aria-label="Ver detalle de ${a.titulo}">
            <div class="relative">
              ${
                imgUrl
                  ? `<img src="${imgUrl}" alt="${a.titulo}" class="w-full aspect-[16/10] object-cover">`
                  : `<div class="w-full aspect-[16/10] bg-brand-100"></div>`
              }
              ${price ? `
                <span class="absolute top-3 right-3 px-2.5 py-1 rounded-full text-xs font-semibold bg-white/90 backdrop-blur-sm shadow text-brand-700">
                  ${price}
                </span>` : ``}
            </div>
            <div class="p-4">
              <h3 class="font-semibold tracking-tight line-clamp-1 group-hover:text-brand-700 transition">${a.titulo}</h3>
              <div class="mt-1 text-xs text-slate-500 flex items-center gap-2">${ubic}</div>
              <div class="mt-3">
                <span class="text-sm text-brand-700 hover:underline">Ver detalle</span>
                <a class="ml-2 text-xs text-slate-400 hover:underline" href="/api/articulos/${a.id}/" target="_blank" rel="noopener">API</a>
              </div>
            </div>
          </a>
        </article>
      `;
    }

    // Búsqueda rápida
    const $searchForm = document.getElementById('searchForm');
    const $searchInput = document.getElementById('searchInput');
    const $searchResults = document.getElementById('searchResults');

    // Resultados del buscador -> enlace al detalle
    function miniCard(a){
      const price = a.precio_por_dia ? `$${fmtCOP(a.precio_por_dia)}/día` : '';
      return `
        <a href="/articulo/${a.id}/"
           class="block rounded-xl border p-3 hover:shadow-md transition group"
           aria-label="Ver detalle de ${a.titulo}">
          <div class="flex items-start gap-3">
            <div class="h-12 w-12 rounded-lg bg-slate-100 overflow-hidden">
              ${
                a.portada || (a.imagenes && a.imagenes[0]?.url)
                  ? `<img src="${a.portada || a.imagenes[0]?.url}" alt="${a.titulo}" class="h-full w-full object-cover" />`
                  : ``
              }
            </div>
            <div class="min-w-0">
              <div class="text-sm font-semibold line-clamp-1 group-hover:text-brand-700">${a.titulo}</div>
              <div class="text-xs text-slate-500 mt-0.5 flex items-center gap-2">
                ${a.ubicacion ? `<span class="px-1.5 py-0.5 rounded bg-slate-100">${a.ubicacion}</span>` : ``}
                ${price ? `<span class="px-1.5 py-0.5 rounded bg-brand-50 text-brand-700">${price}</span>` : ``}
              </div>
            </div>
          </div>
        </a>
      `;
    }

    async function buscar(q){
      if(!q || q.trim().length < 2){
        $searchResults.innerHTML = '';
        return;
      }
      $searchResults.innerHTML = `
        <div class="rounded-xl border p-4">
          <div class="animate-pulse h-4 w-1/2 bg-slate-100 rounded"></div>
          <div class="animate-pulse h-4 w-1/3 bg-slate-100 rounded mt-2"></div>
        </div>`;

      try{
        let r = await fetch('/api/articulos/?ordering=-creado&search=' + encodeURIComponent(q));
        let items = await r.json();

        if(!Array.isArray(items)){
          const r2 = await fetch('/api/articulos/?ordering=-creado');
          const all = await r2.json();
          items = Array.isArray(all) ? all : [];
        }

        const needle = q.toLowerCase();
        const filtrados = items
          .filter(a => {
            const t = (a.titulo || '').toLowerCase();
            const d = (a.descripcion || '').toLowerCase?.() || '';
            return t.includes(needle) || d.includes?.(needle);
          })
          .slice(0, 5);

        if(filtrados.length === 0){
          $searchResults.innerHTML = `
            <div class="rounded-xl border p-4 text-sm text-slate-500">
              Sin resultados para <span class="font-semibold">"${q}"</span>.
            </div>`;
          return;
        }

        $searchResults.innerHTML = filtrados.map(miniCard).join('') +
          `<div class="text-xs text-slate-500">
             <a class="text-brand-700 hover:underline" href="/catalogo/?q=${encodeURIComponent(q)}">Ver más resultados</a>
           </div>`;
      }catch(e){
        $searchResults.innerHTML = `
          <div class="rounded-xl border p-4 text-red-600 text-sm">
            No se pudieron cargar los resultados.
          </div>`;
      }
    }

    $searchForm?.addEventListener('submit', (ev) => {
      ev.preventDefault();
      buscar($searchInput.value);
    });
    $searchInput?.addEventListener('input', (e) => {
      const q = e.target.value;
      clearTimeout($searchInput._t);
      $searchInput._t = setTimeout(() => buscar(q), 250);
    });

    // Destacados
    async function loadDestacados(){
      const grid = document.getElementById('gridDest');
      grid.innerHTML = '';
      for(let i=0;i<6;i++){
        grid.append(document.getElementById('card-skeleton').content.cloneNode(true));
      }
      try{
        const r = await fetch('/api/articulos/?ordering=-creado');
        let items = await r.json();
        items = items.slice(0,6);
        if(!Array.isArray(items) || items.length === 0){
          grid.innerHTML = `
            <div class="col-span-full text-center text-slate-500 border rounded-2xl py-10">
              Aún no hay artículos publicados. <a class="text-brand-700 hover:underline" href="/publicar/">¡Publica el primero!</a>
            </div>`;
          return;
        }
        grid.innerHTML = items.map(cardArticulo).join('');
      }catch(e){
        grid.innerHTML = `<div class="col-span-full text-center text-red-600">No se pudieron cargar los artículos.</div>`;
      }
    }
    loadDestacados();

    // Magnetic Row
    function setupRailMotion(railId) {
      const rail = document.getElementById(railId);
      if (!rail) return;
      rail.addEventListener('mouseenter', () => rail.classList.add('has-hover'));
      rail.addEventListener('mouseleave', () => {
        rail.classList.remove('has-hover');
        rail.style.transform = 'translateX(0px)';
        rail.querySelectorAll('.card-pro.is-hover').forEach(el => el.classList.remove('is-hover'));
      });
      rail.addEventListener('mousemove', (e) => {
        const rect = rail.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const t = (x / rect.width) - 0.5;
        const max = 10;
        rail.style.transform = `translateX(${(t * max).toFixed(2)}px)`;
      });
      rail.addEventListener('mouseover', (e) => {
        const card = e.target.closest('.card-pro');
        if (!card || !rail.contains(card)) return;
        rail.querySelectorAll('.card-pro.is-hover').forEach(el => el.classList.remove('is-hover'));
        card.classList.add('is-hover');
      });
    }
    setupRailMotion('gridComo');
    setupRailMotion('gridServicios');
    setupRailMotion('gridDest');

    // Scroll-Spy + Progreso en TOC
    (function(){
      const headerOffset = 80;
      const links = Array.from(document.querySelectorAll('.toc a'));
      const ids = links.map(a => a.dataset.target);
      const sections = ids.map(id => document.getElementById(id)).filter(Boolean);

      links.forEach(a => {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          const el = document.getElementById(a.dataset.target);
          const y = el.getBoundingClientRect().top + window.scrollY - headerOffset;
          window.scrollTo({ top: y, behavior: 'smooth' });
        });
      });

      const obs = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          const id = entry.target.id;
          const link = links.find(l => l.dataset.target === id);
          if (!link) return;
          if (entry.isIntersecting) {
            links.forEach(l => l.classList.remove('active'));
            link.classList.add('active');
          }
        });
      }, { rootMargin: '-40% 0px -50% 0px', threshold: 0 });
      sections.forEach(s => obs.observe(s));

      const progressEl = document.getElementById('tocProgress');
      const progressRail = progressEl?.parentElement;
      function updateProgress(){
        if(!progressEl || !progressRail) return;
        const start = sections[0].getBoundingClientRect().top + window.scrollY - headerOffset;
        const last = sections[sections.length-1];
        const end = last.getBoundingClientRect().bottom + window.scrollY - headerOffset;
        const total = Math.max(1, end - start);
        const sc = window.scrollY;
        const pct = Math.min(1, Math.max(0, (sc - start) / total));
        const railH = progressRail.offsetHeight;
        progressEl.style.height = Math.round(railH * pct) + 'px';
      }
      updateProgress();
      window.addEventListener('scroll', updateProgress, { passive:true });
      window.addEventListener('resize', updateProgress);
    })();

    // -------- User Menu (autenticación) --------
    (async function renderUserMenu(){
      const mount = document.getElementById('userMenuMount');
      if (!mount) return;

      const access = localStorage.getItem('access');

      const html = String.raw;
      const logout = () => {
        localStorage.removeItem('access');
        localStorage.removeItem('refresh');
        location.replace('/');
      };

      if (!access) {
        mount.innerHTML = html`
          <div class="flex items-center gap-3">
            <a href="/login/" class="px-3 py-1.5 rounded-lg border transition hover:bg-slate-50">Iniciar sesión</a>
            <a href="/registro/" class="px-3 py-1.5 rounded-lg bg-brand-600 text-white transition hover:bg-brand-700">Registrarse</a>
          </div>
        `;
        return;
      }

      // Con sesión → obtener nombre visible
      let displayName = '';
      try {
        const r1 = await fetch('/api/perfiles/me/', { headers: { Authorization: `Bearer ${access}` }});
        if (r1.ok) {
          const p = await r1.json();
          displayName = (p.nombre_completo || '').trim();
        }
        if (!displayName) {
          const r2 = await fetch('/api/users/me/', { headers: { Authorization: `Bearer ${access}` }});
          if (r2.ok) {
            const u = await r2.json();
            displayName = (u.nombre || u.email || '').trim();
          }
        }
      } catch (_) {}

      if (!displayName) displayName = 'Mi cuenta';

      mount.innerHTML = html`
        <button id="btnUser"
                class="flex items-center gap-2 px-3 py-1.5 rounded-lg border transition hover:bg-slate-50">
          <span class="inline-flex h-7 w-7 items-center justify-center rounded-full bg-brand-100 text-brand-700 font-semibold">👤</span>
          <span class="text-sm font-medium">${displayName}</span>
          <svg class="w-4 h-4 text-slate-500" viewBox="0 0 20 20" fill="currentColor"><path d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z"/></svg>
        </button>

        <div id="menuUser" class="absolute right-0 mt-2 w-56 rounded-2xl border bg-white shadow-lg p-2 hidden">
          <a href="/perfil/" class="block px-3 py-2 rounded-lg text-sm hover:bg-slate-50">Mi perfil</a>
          <a href="/perfil/editar/" class="block px-3 py-2 rounded-lg text-sm hover:bg-slate-50">Editar perfil</a>
          <a href="/publicar/" class="block px-3 py-2 rounded-lg text-sm hover:bg-slate-50">Publicar artículo</a>
          <button id="logoutBtn" class="w-full text-left px-3 py-2 rounded-lg text-sm hover:bg-slate-50 text-red-600">Cerrar sesión</button>
        </div>
      `;

      const btn = document.getElementById('btnUser');
      const menu = document.getElementById('menuUser');
      const out  = document.getElementById('logoutBtn');

      const toggle = () => menu.classList.toggle('hidden');
      const closeOnClickOutside = (e) => {
        if (!menu.contains(e.target) && !btn.contains(e.target)) menu.classList.add('hidden');
      };

      btn.addEventListener('click', toggle);
      document.addEventListener('click', closeOnClickOutside);
      out.addEventListener('click', logout);
    })();
  </script>
</body>
</html>
