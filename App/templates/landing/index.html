{% load static %}
{% load i18n %}

<!doctype html>
<html lang="{{ LANGUAGE_CODE }}">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% trans "Toolingo ‚Äì Alquiler de equipos y herramientas" %}</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { brand:{50:'#fff7ed',100:'#ffedd5',200:'#fed7aa',300:'#fdba74',400:'#fb923c',500:'#f97316',600:'#ea580c',700:'#c2410c'} },
          boxShadow: { soft:'0 8px 24px rgba(15,23,42,.06)' }
        }
      }
    }
  </script>

  <style>
    .rail{transition:transform 250ms cubic-bezier(.22,.61,.36,1),filter 250ms;will-change:transform;}
    .rail.has-hover>.card-pro:not(.is-hover){opacity:.9;transform:translateY(0) scale(.985);filter:saturate(.95);}
    .card-pro{transition:transform 220ms cubic-bezier(.22,.61,.36,1),box-shadow 220ms,opacity 220ms,filter 220ms;will-change:transform,box-shadow,filter;}
    .card-pro.is-hover{transform:translateY(-6px);box-shadow:0 14px 40px rgba(15,23,42,.12);filter:saturate(1.02);}
    .toc a{display:block;padding:.5rem .75rem;border-radius:.6rem;color:#334155;font-size:.925rem;}
    .toc a:hover{background:#f1f5f9;}
    .toc a.active{color:#ea580c;background:#fff7ed;font-weight:600;}
    html{scroll-behavior:smooth;}
    .notif-panel{position:absolute;right:0;top:52px;width:20rem;max-height:24rem;overflow:auto;background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 12px 32px rgba(15,23,42,.18);z-index:1000;}
  </style>
</head>
<body class="text-slate-800 bg-white">

  <!-- Navbar -->
  <header class="sticky top-0 bg-white/80 backdrop-blur border-b border-slate-200 z-50">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-6">
      <a href="{% url 'landing' %}" class="flex items-center gap-2">
        <svg width="28" height="28" viewBox="0 0 24 24" class="text-brand-600 fill-current transition-transform duration-300 hover:rotate-12">
          <path d="M21 7.5a5.5 5.5 0 0 1-7.53 5.09l-6.44 6.44a1.5 1.5 0 0 1-2.12-2.12l6.44-6.44A5.5 5.5 0 1 1 21 7.5Z"/>
        </svg>
        <span class="text-xl font-extrabold">Toolingo</span>
      </a>

      <nav class="hidden md:flex gap-6 text-sm ml-auto items-center">
        <a href="{% url 'catalogo' %}" class="relative font-semibold transition hover:text-brand-600">{% trans "Productos" %}</a>

        <!-- Campanita -->
        <button id="notifBell" class="relative p-2 rounded-lg hover:bg-slate-100" title="{% trans 'Notificaciones' %}">
          üîî
          <span id="notifBadge" class="absolute -top-1 -right-1 text-[11px] px-1.5 py-0.5 rounded-full bg-red-600 text-white hidden">0</span>
        </button>
        <div id="notifPanel" class="hidden notif-panel">
          <div class="px-4 py-2 border-b text-slate-800 font-semibold">{% trans "Notificaciones" %}</div>
          <div id="notifList" class="p-2 text-sm text-slate-700">
            <div class="p-3 text-slate-400 empty">{% trans "Sin notificaciones" %}</div>
          </div>
          <div class="px-3 py-2 border-t text-right">
            <button id="notifMarkAll" class="text-xs px-2 py-1 rounded bg-slate-100 hover:bg-slate-200">{% trans "Marcar todo como le√≠do" %}</button>
          </div>
        </div>

        <!-- Carrito -->
        <button id="cartBtn" class="relative p-2 rounded-lg hover:bg-slate-100" title="{% trans 'Carrito' %}">
          üõí
          <span id="cartBadge" class="absolute -top-1 -right-1 text-[11px] px-1.5 py-0.5 rounded-full bg-brand-600 text-white hidden">0</span>
        </button>

        <!-- Selector de idioma -->
        <form action="{% url 'set_language' %}" method="post" class="ml-2">
          {% csrf_token %}
          <input name="next" type="hidden" value="{{ request.get_full_path }}">
          <select name="language" onchange="this.form.submit()" class="text-sm border rounded px-2 py-1">
            {% get_current_language as LANGUAGE_CODE %}
            {% get_available_languages as LANGUAGES %}
            {% for lang in LANGUAGES %}
              <option value="{{ lang.0 }}" {% if lang.0 == LANGUAGE_CODE %}selected{% endif %}>{{ lang.1 }}</option>
            {% endfor %}
          </select>
        </form>
      </nav>

      <div id="userMenuMount" class="relative"></div>
    </div>
  </header>

  <!-- Hero -->
  <section class="bg-brand-50">
    <div class="max-w-6xl mx-auto px-4 py-16 grid md:grid-cols-2 gap-10 items-center">
      <div>
        <h1 class="text-5xl font-extrabold leading-tight text-slate-900">
          {% blocktrans trimmed %}
            Toolingo es el <span class="text-brand-600">marketplace</span>
            para alquilar equipos y herramientas cerca de ti.
          {% endblocktrans %}
        </h1>

        <p class="text-gray-600 mt-4">
          {% blocktrans trimmed %}
            Publica tus herramientas como propietario o encuentra la indicada
            para tu proyecto como arrendatario. Seguro, r√°pido y con calificaciones verificadas.
          {% endblocktrans %}
        </p>

        <div class="mt-6 flex gap-3">
          <a href="#servicios" class="px-5 py-3 rounded-xl bg-brand-600 text-white transition transform hover:bg-brand-700 hover:-translate-y-1">{% trans "Explorar servicios" %}</a>
        </div>
        <div class="mt-6 text-sm text-slate-600">{% trans "+ Disponibilidad por d√≠as ‚Ä¢ + Dep√≥sito opcional ‚Ä¢ + Pagos seguros" %}</div>
      </div>

      <!-- B√∫squeda -->
      <div class="bg-white rounded-2xl shadow-soft p-6 border border-slate-100 transition hover:shadow-lg">
        <div class="grid md:grid-cols-3 gap-4">
          <div class="md:col-span-2">
            <div class="text-sm mb-2 text-slate-500">{% trans "B√∫squeda r√°pida" %}</div>
            <form id="searchForm" class="flex gap-2">
              <input id="searchInput"
                     class="w-full border rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-brand-200 transition"
                     placeholder="{% trans '¬øQu√© herramienta necesitas?' %}" />
              <button class="px-4 rounded-xl bg-brand-600 text-white transition hover:bg-brand-700 hover:-translate-y-0.5">{% trans "Buscar" %}</button>
            </form>
            <div id="searchResults" class="mt-4 space-y-2"></div>
            <div class="mt-3 text-xs text-slate-500">
              {% trans "¬øNo ves lo que buscas?" %}
              <a class="text-brand-700 hover:underline" href="{% url 'catalogo' %}">{% trans "Ir al cat√°logo completo" %}</a>.
            </div>
          </div>
          <div class="flex">
            <div class="rounded-2xl shadow-sm p-4 border border-slate-200 transition hover:shadow-lg w-full">
              <div class="text-sm mb-2 font-semibold text-gray-700"></div>
              <div class="mt-3 text-xs text-gray-500 space-y-2">
                <p>{% blocktrans %}Prueba el buscador con <span class="font-medium text-slate-700">‚Äútaladro‚Äù, ‚Äúandamio‚Äù, ‚Äúmezcladora‚Äù</span>.{% endblocktrans %}</p>
                <p>{% trans "Se muestran hasta 5 resultados recientes." %}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- /tarjeta -->
    </div>
  </section>

  <!-- Contenido principal -->
  <main class="max-w-6xl mx-auto px-4 mt-16 lg:grid lg:grid-cols-[270px_1fr] lg:gap-10">
    <aside class="toc sticky top-24 self-start hidden lg:block">
      <div class="bg-slate-60 border border-slate-200 rounded-xl p-4">
        <div class="text-xs uppercase tracking-wide text-slate-400 mb-3">{% trans "En esta p√°gina" %}</div>
        <div class="relative pl-4">
          <div class="absolute left-0 top-0 w-1 rounded-full bg-slate-200 h-full"></div>
          <div id="tocProgress" class="absolute left-0 top-0 w-1 rounded-full bg-brand-600" style="height:0%"></div>
          <nav class="space-y-1">
            <a href="#como" data-target="como">{% trans "¬øC√≥mo funciona?" %}</a>
            <a href="#servicios" data-target="servicios">{% trans "Servicios principales" %}</a>
            <a href="#destacados" data-target="destacados">{% trans "Art√≠culos destacados" %}</a>
          </nav>
        </div>
      </div>
    </aside>

    <div class="min-w-0">
      <div class="h-12 lg:h-16"></div>

      <section id="como" class="py-16">
        <h2 class="text-2xl md:text-3xl font-extrabold tracking-tight">{% trans "¬øC√≥mo funciona Toolingo?" %}</h2>
        <p class="mt-1 text-slate-600">{% trans "Tres pasos sencillos para rentar o publicar:" %}</p>
        <div id="gridComo" class="rail grid md:grid-cols-3 gap-6 mt-6">
          <div class="card-pro p-6 rounded-2xl border border-slate-200 bg-white shadow-soft">
            <div class="flex items-center gap-4 mb-3">
              <div class="h-10 w-10 rounded-full bg-brand-100 text-brand-700 grid place-items-center font-bold">1</div>
              <h3 class="font-semibold text-lg tracking-tight">{% trans "Explora" %}</h3>
            </div>
            <p class="text-slate-600 leading-relaxed">{% trans "Filtra por categor√≠a, ubicaci√≥n y precio por d√≠a." %}</p>
          </div>
          <div class="card-pro p-6 rounded-2xl border border-slate-200 bg-white shadow-soft">
            <div class="flex items-center gap-4 mb-3">
              <div class="h-10 w-10 rounded-full bg-brand-100 text-brand-700 grid place-items-center font-bold">2</div>
              <h3 class="font-semibold text-lg tracking-tight">{% trans "Reserva" %}</h3>
            </div>
            <p class="text-slate-600 leading-relaxed">{% trans "Elige fechas disponibles y realiza el pago seguro." %}</p>
          </div>
          <div class="card-pro p-6 rounded-2xl border border-slate-200 bg-white shadow-soft">
            <div class="flex items-center gap-4 mb-3">
              <div class="h-10 w-10 rounded-full bg-brand-100 text-brand-700 grid place-items-center font-bold">3</div>
              <h3 class="font-semibold text-lg tracking-tight">{% trans "Califica" %}</h3>
            </div>
            <p class="text-slate-600 leading-relaxed">{% trans "Entrega/recibe el equipo y deja tu calificaci√≥n." %}</p>
          </div>
        </div>
      </section>

      <section id="servicios" class="py-16">
        <h2 class="text-2xl md:text-3xl font-extrabold tracking-tight">{% trans "Servicios principales" %}</h2>
        <p class="text-slate-600 mt-1">{% trans "Alquila por d√≠a herramientas para construcci√≥n, jardiner√≠a y m√°s." %}</p>

        <div id="gridServicios" class="rail grid sm:grid-cols-2 md:grid-cols-3 gap-6 mt-6">
          <div class="card-pro p-6 rounded-2xl bg-white border border-slate-200 shadow-soft">
            <span class="inline-block text-sm font-semibold text-brand-700 bg-brand-50 px-2 py-1 rounded">{% trans "Construcci√≥n" %}</span>
            <div class="mt-2 text-slate-700">{% trans "Demoledores, mezcladoras, compactadoras" %}</div>
          </div>
          <div class="card-pro p-6 rounded-2xl bg-white border border-slate-200 shadow-soft">
            <span class="inline-block text-sm font-semibold text-brand-700 bg-brand-50 px-2 py-1 rounded">{% trans "El√©ctricas" %}</span>
            <div class="mt-2 text-slate-700">{% trans "Taladros, esmeriles, sierras" %}</div>
          </div>
          <div class="card-pro p-6 rounded-2xl bg-white border border-slate-200 shadow-soft">
            <span class="inline-block text-sm font-semibold text-brand-700 bg-brand-50 px-2 py-1 rounded">{% trans "Alturas" %}</span>
            <div class="mt-2 text-slate-700">{% trans "Andamios, escaleras" %}</div>
          </div>
        </div>
      </section>

      <section id="destacados" class="py-16">
        <div class="flex items-end justify-between">
          <h2 class="text-2xl md:text-3xl font-extrabold tracking-tight">{% trans "Art√≠culos destacados" %}</h2>
          <a href="{% url 'catalogo' %}" class="text-sm text-brand-700 hover:underline">{% trans "Ver todo" %}</a>
        </div>

        <div id="gridDest" class="rail grid sm:grid-cols-2 lg:grid-cols-3 gap-6 mt-6"></div>

        <template id="card-skeleton">
          <article class="rounded-2xl border border-slate-200 bg-white shadow-soft p-4 animate-pulse">
            <div class="h-44 rounded-xl bg-slate-100 mb-4"></div>
            <div class="h-4 w-2/3 bg-slate-100 rounded mb-2"></div>
            <div class="h-3 w-1/3 bg-slate-100 rounded"></div>
          </article>
        </template>
      </section>

      <section class="py-16 bg-brand-600 text-white rounded-2xl mb-16">
        <div class="px-6 md:px-10 text-center">
          <h2 class="text-3xl font-bold tracking-tight">{% trans "¬øListo para publicar o alquilar?" %}</h2>
          <p class="mt-2 text-brand-100">{% trans "Crea tu cuenta y empieza a generar ingresos con tus herramientas." %}</p>
          <div class="mt-6">
            <a href="{% url 'login' %}?next={% url 'publicar' %}"
               class="px-6 py-3 bg-white text-brand-700 rounded-xl font-semibold transition transform hover:bg-slate-100 hover:-translate-y-1">
              {% trans "Inicia sesi√≥n" %}
            </a>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- JS -->
  <script>
    const fmtCOP = n => Number(n||0).toLocaleString('es-CO');

    // Prefijo de idioma para rutas generadas en JS
    const LANG = (document.documentElement.lang || 'es').toLowerCase();
    const L = (p) => `/${LANG}${p.startsWith('/')?p:`/${p}`}`;

    // ===== JWT helpers + authFetch =====
    const TOKEN_KEY='access', REFRESH_KEY='refresh';
    const getToken = ()=> localStorage.getItem(TOKEN_KEY) || null;
    const getRefresh = ()=> localStorage.getItem(REFRESH_KEY) || null;
    const setTokens = ({access, refresh}) => { if(access) localStorage.setItem(TOKEN_KEY, access); if(refresh) localStorage.setItem(REFRESH_KEY, refresh); };

    async function refreshAccessToken(){
      const refresh = getRefresh(); if(!refresh) return null;
      const r = await fetch('/api/token/refresh/', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ refresh }) });
      if(!r.ok) return null; const data = await r.json();
      if(data.access){ setTokens({ access:data.access }); return data.access; }
      return null;
    }
    async function authFetch(url, options = {}){
      const token = getToken();
      if(!token){ throw new Error('No autenticado'); }
      const headers = new Headers(options.headers || {});
      headers.set('Authorization', `Bearer ${token}`);
      if(options.body && !headers.has('Content-Type')) headers.set('Content-Type','application/json');
      let resp = await fetch(url, { ...options, headers });
      if(resp.status === 401){
        const na = await refreshAccessToken(); if(!na) return resp;
        headers.set('Authorization', `Bearer ${na}`);
        resp = await fetch(url, { ...options, headers });
      }
      return resp;
    }

    // ---- Carrito + badge ----
    const cartBtn = document.getElementById('cartBtn');
    const cartBadge = document.getElementById('cartBadge');

    cartBtn?.addEventListener('click', () => {
      if (!getToken()) location.href = L('{% url "login" %}?next={% url "carrito" %}');
      else location.href = L('{% url "carrito" %}');
    });

    (async ()=> {
      if (!getToken()) { cartBadge?.classList.add('hidden'); return; }
      try {
        const r = await authFetch('/api/carrito/');
        if (!r.ok) return;
        const items = await r.json();
        cartBadge.classList.toggle('hidden', items.length === 0);
        cartBadge.textContent = items.length;
      } catch(_) {}
    })();

    // -------- B√∫squeda / Destacados --------
    function cardArticulo(a){
      const imgUrl = a.portada || (a.imagenes && a.imagenes[0]?.url) || null;
      const price  = a.precio_por_dia ? `$${fmtCOP(a.precio_por_dia)}/d√≠a` : '';
      const ubic   = a.ubicacion ? `<span class="inline-flex items-center px-2 py-0.5 rounded-full bg-slate-100">${a.ubicacion}</span>` : '';
      const href   = L(`/articulo/${a.id}/`);
      return `
        <article class="card-pro group rounded-2xl border border-slate-200 bg-white shadow-soft overflow-hidden transition hover:-translate-y-1 hover:shadow-lg">
          <a href="${href}" class="block" aria-label="Ver detalle de ${a.titulo}">
            <div class="relative">
              ${imgUrl ? `<img src="${imgUrl}" alt="${a.titulo}" class="w-full aspect-[16/10] object-cover">` : `<div class="w-full aspect-[16/10] bg-brand-100"></div>`}
              ${price ? `<span class="absolute top-3 right-3 px-2.5 py-1 rounded-full text-xs font-semibold bg-white/90 backdrop-blur-sm shadow text-brand-700">${price}</span>` : ``}
            </div>
            <div class="p-4">
              <h3 class="font-semibold tracking-tight line-clamp-1 group-hover:text-brand-700 transition">${a.titulo}</h3>
              <div class="mt-1 text-xs text-slate-500 flex items-center gap-2">${ubic}</div>
              <div class="mt-3">
                <span class="text-sm text-brand-700 hover:underline">{% trans "Ver detalle" %}</span>
              </div>
            </div>
          </a>
        </article>`;
    }

    const $searchForm = document.getElementById('searchForm');
    const $searchInput = document.getElementById('searchInput');
    const $searchResults = document.getElementById('searchResults');

    function miniCard(a){
      const price = a.precio_por_dia ? `$${fmtCOP(a.precio_por_dia)}/d√≠a` : '';
      const href  = L(`/articulo/${a.id}/`);
      return `
        <a href="${href}" class="block rounded-xl border p-3 hover:shadow-md transition group" aria-label="Ver detalle de ${a.titulo}">
          <div class="flex items-start gap-3">
            <div class="h-12 w-12 rounded-lg bg-slate-100 overflow-hidden">
              ${(a.portada || (a.imagenes && a.imagenes[0]?.url)) ? `<img src="${a.portada || a.imagenes[0]?.url}" alt="${a.titulo}" class="h-full w-full object-cover" />` : ``}
            </div>
            <div class="min-w-0">
              <div class="text-sm font-semibold line-clamp-1 group-hover:text-brand-700">${a.titulo}</div>
              <div class="text-xs text-slate-500 mt-0.5 flex items-center gap-2">
                ${a.ubicacion ? `<span class="px-1.5 py-0.5 rounded bg-slate-100">${a.ubicacion}</span>` : ``}
                ${price ? `<span class="px-1.5 py-0.5 rounded bg-brand-50 text-brand-700">${price}</span>` : ``}
              </div>
            </div>
          </div>
        </a>`;
    }

    async function buscar(q){
      if(!q || q.trim().length < 2){ $searchResults.innerHTML = ''; return; }
      $searchResults.innerHTML = `
        <div class="rounded-xl border p-4">
          <div class="animate-pulse h-4 w-1/2 bg-slate-100 rounded"></div>
          <div class="animate-pulse h-4 w-1/3 bg-slate-100 rounded mt-2"></div>
        </div>`;
      try{
        let r = await fetch('/api/articulos/?ordering=-creado&search=' + encodeURIComponent(q));
        let data = await r.json();
        let items = Array.isArray(data) ? data :
                    Array.isArray(data?.results) ? data.results :
                    Array.isArray(data?.items) ? data.items : [];
        if(!Array.isArray(items)){
          const r2 = await fetch('/api/articulos/?ordering=-creado');
          const all = await r2.json();
          items = Array.isArray(all) ? all : (Array.isArray(all?.results) ? all.results : []);
        }
        const needle = q.toLowerCase();
        const filtrados = items.filter(a => ((a.titulo||'').toLowerCase().includes(needle)) || ((a.descripcion||'').toLowerCase?.().includes?.(needle))).slice(0,5);
        if(filtrados.length === 0){
          $searchResults.innerHTML = `<div class="rounded-xl border p-4 text-sm text-slate-500">{% trans "Sin resultados para" %} <span class="font-semibold">"${q}"</span>.</div>`;
          return;
        }
        $searchResults.innerHTML = filtrados.map(miniCard).join('') +
          `<div class="text-xs text-slate-500"><a class="text-brand-700 hover:underline" href="${L('/catalogo/')}?q=${encodeURIComponent(q)}">{% trans "Ver m√°s resultados" %}</a></div>`;
      }catch(_){
        $searchResults.innerHTML = `<div class="rounded-xl border p-4 text-red-600 text-sm">{% trans "No se pudieron cargar los resultados." %}</div>`;
      }
    }

    $searchForm?.addEventListener('submit', (ev) => { ev.preventDefault(); buscar($searchInput.value); });
    $searchInput?.addEventListener('input', (e) => { const q = e.target.value; clearTimeout($searchInput._t); $searchInput._t = setTimeout(() => buscar(q), 250); });

    // --- DESTACADOS (robusto y mostrando 3 como antes) ---
    async function loadDestacados(){
      const grid = document.getElementById('gridDest');
      grid.innerHTML = '';
      for(let i=0;i<3;i++){ grid.append(document.getElementById('card-skeleton').content.cloneNode(true)); }
      try{
        const r = await fetch('/api/articulos/?ordering=-creado&page_size=6');
        const data = await r.json();
        // Soporta lista directa, paginaci√≥n DRF (results) o campo items
        let items = Array.isArray(data) ? data :
                    Array.isArray(data?.results) ? data.results :
                    Array.isArray(data?.items) ? data.items : [];
        // Si el backend marca "destacado", priorizamos; si no, tomamos los 3 m√°s recientes
        const destacados = items.filter(it => it.destacado === true);
        const pick = (destacados.length ? destacados : items).slice(0,3);
        if(!pick.length){
          grid.innerHTML = `<div class="col-span-full text-center text-slate-500 border rounded-2xl py-10">{% trans "A√∫n no hay art√≠culos publicados." %} <a class="text-brand-700 hover:underline" href="${L('{% url "publicar" %}')}">{% trans "¬°Publica el primero!" %}</a></div>`;
          return;
        }
        grid.innerHTML = pick.map(cardArticulo).join('');
      }catch(_){
        grid.innerHTML = `<div class="col-span-full text-center text-red-600">{% trans "No se pudieron cargar los art√≠culos." %}</div>`;
      }
    }
    loadDestacados();

    function setupRailMotion(railId){
      const rail = document.getElementById(railId);
      if (!rail) return;
      rail.addEventListener('mouseenter', () => rail.classList.add('has-hover'));
      rail.addEventListener('mouseleave', () => {
        rail.classList.remove('has-hover');
        rail.style.transform = 'translateX(0px)';
        rail.querySelectorAll('.card-pro.is-hover').forEach(el => el.classList.remove('is-hover'));
      });
      rail.addEventListener('mousemove', (e) => {
        const rect = rail.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const t = (x / rect.width) - 0.5;
        const max = 10;
        rail.style.transform = `translateX(${(t * max).toFixed(2)}px)`;
      });
      rail.addEventListener('mouseover', (e) => {
        const card = e.target.closest('.card-pro');
        if (!card || !rail.contains(card)) return;
        rail.querySelectorAll('.card-pro.is-hover').forEach(el => el.classList.remove('is-hover'));
        card.classList.add('is-hover');
      });
    }
    setupRailMotion('gridComo');
    setupRailMotion('gridServicios');
    setupRailMotion('gridDest');

    (function(){
      const headerOffset = 80;
      const links = Array.from(document.querySelectorAll('.toc a'));
      const ids = links.map(a => a.dataset.target);
      const sections = ids.map(id => document.getElementById(id)).filter(Boolean);

      links.forEach(a => {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          const el = document.getElementById(a.dataset.target);
          const y = el.getBoundingClientRect().top + window.scrollY - headerOffset;
          window.scrollTo({ top: y, behavior: 'smooth' });
        });
      });

      const obs = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          const id = entry.target.id;
          const link = links.find(l => l.dataset.target === id);
          if (!link) return;
          if (entry.isIntersecting) {
            links.forEach(l => l.classList.remove('active'));
            link.classList.add('active');
          }
        });
      }, { rootMargin: '-40% 0px -50% 0px', threshold: 0 });
      sections.forEach(s => obs.observe(s));

      const progressEl = document.getElementById('tocProgress');
      const progressRail = progressEl?.parentElement;
      function updateProgress(){
        if(!progressEl || !progressRail) return;
        const start = sections[0].getBoundingClientRect().top + window.scrollY - headerOffset;
        const last = sections[sections.length-1];
        const end = last.getBoundingClientRect().bottom + window.scrollY - headerOffset;
        const total = Math.max(1, end - start);
        const sc = window.scrollY;
        const pct = Math.min(1, Math.max(0, (sc - start) / total));
        const railH = progressRail.offsetHeight;
        progressEl.style.height = Math.round(railH * pct) + 'px';
      }
      updateProgress();
      window.addEventListener('scroll', updateProgress, { passive:true });
      window.addEventListener('resize', updateProgress);
    })();

    // -------- User Menu --------
    (async function renderUserMenu(){
      const mount = document.getElementById('userMenuMount');
      if (!mount) return;

      const access = getToken();
      const html = String.raw;
      const logout = () => { localStorage.removeItem('access'); localStorage.removeItem('refresh'); location.replace(L('{% url "landing" %}')); };

      if (!access) {
        mount.innerHTML = html`
          <div class="flex items-center gap-3">
            <a href="${L('{% url "login" %}')} " class="px-3 py-1.5 rounded-lg border transition hover:bg-slate-50">{% trans "Iniciar sesi√≥n" %}</a>
            <a href="${L('{% url "registro" %}')} " class="px-3 py-1.5 rounded-lg bg-brand-600 text-white transition hover:bg-brand-700">{% trans "Registrarse" %}</a>
          </div>`;
        document.getElementById('cartBadge')?.classList.add('hidden');
        return;
      }

      let displayName = '';
      try {
        const r1 = await authFetch('/api/perfiles/me/');
        if (r1.ok) { const p = await r1.json(); displayName = (p.nombre_completo || '').trim(); }
      } catch (_) {}
      if (!displayName) {
        try {
          const r2 = await authFetch('/api/users/me/');
          if (r2.ok) { const u = await r2.json(); displayName = (u.nombre || u.email || '').trim(); }
        } catch (_) {}
      }
      if (!displayName) displayName = '{% trans "Mi cuenta" %}';

      mount.innerHTML = html`
        <button id="btnUser" class="flex items-center gap-2 px-3 py-1.5 rounded-lg border transition hover:bg-slate-50">
          <span class="inline-flex h-7 w-7 items-center justify-center rounded-full bg-brand-100 text-brand-700 font-semibold">üë§</span>
          <span class="text-sm font-medium">${displayName}</span>
          <svg class="w-4 h-4 text-slate-500" viewBox="0 0 20 20" fill="currentColor"><path d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z"/></svg>
        </button>
        <div id="menuUser" class="absolute right-0 mt-2 w-56 rounded-2xl border bg-white shadow-lg p-2 hidden">
          <a href="${L('{% url "perfil" %}')} " class="block px-3 py-2 rounded-lg text-sm hover:bg-slate-50">{% trans "Mi perfil" %}</a>
          <a href="${L('{% url "perfil_editar" %}')} " class="block px-3 py-2 rounded-lg text-sm hover:bg-slate-50">{% trans "Editar perfil" %}</a>
          <a href="${L('{% url "publicar" %}')} " class="block px-3 py-2 rounded-lg text-sm hover:bg-slate-50">{% trans "Publicar art√≠culo" %}</a>
          <button id="logoutBtn" class="w-full text-left px-3 py-2 rounded-lg text-sm hover:bg-slate-50 text-red-600">{% trans "Cerrar sesi√≥n" %}</button>
        </div>`;

      const btn = document.getElementById('btnUser');
      const menu = document.getElementById('menuUser');
      const out  = document.getElementById('logoutBtn');
      const toggle = () => menu.classList.toggle('hidden');
      const closeOnClickOutside = (e) => { if (!menu.contains(e.target) && !btn.contains(e.target)) menu.classList.add('hidden'); };

      btn.addEventListener('click', toggle);
      document.addEventListener('click', closeOnClickOutside);
      out.addEventListener('click', logout);

      try{
        const r = await authFetch('/api/carrito/');
        if (r.ok) {
          const items = await r.json();
          const badge = document.getElementById('cartBadge');
          badge.classList.toggle('hidden', items.length === 0);
          badge.textContent = items.length;
        }
      }catch(_){}
    })();

    // ===== Notificaciones =====
    const notifBell = document.getElementById('notifBell');
    const notifPanel = document.getElementById('notifPanel');
    const badgeEl  = document.getElementById('notifBadge');
    const listEl   = document.getElementById('notifList');

    const setBadge = (n)=>{ if(n>0){ badgeEl.textContent=String(n); badgeEl.classList.remove('hidden'); } else { badgeEl.classList.add('hidden'); } };
    const norm = (v)=>{ try{return String(v??'').trim()}catch{return''} };

    function isMine(msg, meObj){
      const a=msg?.autor||{};
      const meId=norm(meObj?.id||meObj?.user?.id);
      const auId=norm(a?.id);
      const meE=(meObj?.email||meObj?.user?.email||'').toLowerCase();
      const auE=(a?.email||'').toLowerCase();
      const meU=(meObj?.username||meObj?.user?.username||'').toLowerCase();
      const auU=(a?.username||'').toLowerCase();
      return (meId&&auId&&meId===auId)||(meE&&auE&&meE===auE)||(meU&&auU&&meU===auU);
    }
    function fmtTime(ts){ try { return new Date(ts).toLocaleTimeString("es-CO",{hour:"2-digit",minute:"2-digit"}) } catch { return "" } }

    function addNotifCard({convId,who,text,when}){
      if(listEl.querySelector('.empty')) listEl.innerHTML='';
      const item=document.createElement('button');
      item.type='button';
      item.className='w-full text-left p-3 rounded-lg hover:bg-slate-50 flex gap-2';
      item.innerHTML=`
        <div class="h-8 w-8 rounded-full bg-slate-200 text-slate-600 grid place-items-center font-bold">${(who||'?')[0]?.toUpperCase()||'?'}</div>
        <div class="min-w-0">
          <div class="font-medium truncate">${who||'{% trans "Nuevo mensaje" %}'}</div>
          <div class="text-slate-500 text-sm line-clamp-2">${(text||'').replace(/</g,'&lt;')}</div>
          <div class="text-[11px] text-slate-400 mt-0.5">${fmtTime(when)}</div>
        </div>`;
      item.addEventListener('click', async ()=>{
        if(!getToken()){ location.href=L('{% url "login" %}?next={% url "chat_ui" %}'); return; }
        localStorage.setItem(`chat_last_read_${convId}`, new Date().toISOString());
        authFetch(`/api/chats/${convId}/read/`,{method:'POST'}).catch(()=>{});
        window.location.href = L('{% url "chat_ui" %}');
      });
      listEl.prepend(item);
    }

    function beep(){
      try{
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const o=ctx.createOscillator(), g=ctx.createGain();
        o.type='sine'; o.frequency.value=880;
        o.connect(g); g.connect(ctx.destination);
        g.gain.setValueAtTime(0.0001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.12, ctx.currentTime+0.01);
        o.start();
        setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.05); o.stop(ctx.currentTime+0.06); }, 140);
      }catch{}
    }
    let titleTimer=null, baseTitle=document.title;
    function flashTitle(){
      if(titleTimer) return;
      let on=false;
      titleTimer=setInterval(()=>{ document.title = on? '{% trans "¬°Nuevo mensaje!" %}' : baseTitle; on=!on; }, 800);
      setTimeout(()=>{ clearInterval(titleTimer); titleTimer=null; document.title=baseTitle; }, 6000);
    }

    async function getMe(){
      try{
        const r=await authFetch('/api/perfiles/me/'); if(!r.ok) return null;
        return await r.json();
      }catch{ return null; }
    }

    async function tickNotifications(){
      if(!getToken()) return;
      const meObj = await getMe(); if(!meObj) return;
      let count=0;

      const r=await authFetch('/api/chats/'); if(!r.ok) return;
      const convs=await r.json(); if(!Array.isArray(convs)) return;

      for(const c of convs){
        const convId=c.id;
        const lastReadISO=localStorage.getItem(`chat_last_read_${convId}`)||'';
        const lastRead=lastReadISO? new Date(lastReadISO).getTime():0;

        const rm=await authFetch(`/api/chats/${convId}/messages/`); if(!rm.ok) continue;
        const msgs=await rm.json(); if(!Array.isArray(msgs)||!msgs.length) continue;

        const incoming=msgs.filter(m => !isMine(m, meObj) && (!lastRead || new Date(m.creado).getTime() > lastRead));
        if(incoming.length){
          count += incoming.length;
          const last = incoming[incoming.length-1];
          const seen = localStorage.getItem(`home_last_seen_msg_${convId}`) || '';
          if(String(last.id)!==String(seen)){
            addNotifCard({convId, who:(last?.autor?.username||last?.autor?.email||'{% trans "Usuario" %}'), text:last?.contenido||'', when:last?.creado});
            beep(); flashTitle();
            localStorage.setItem(`home_last_seen_msg_${convId}`, String(last.id));
          }
        }
      }
      setBadge(count);
    }

    notifBell?.addEventListener('click', ()=>{
      if(!getToken()){ location.href=L('{% url "login" %}?next={% url "landing" %}'); return; }
      notifPanel.classList.toggle('hidden');
    });
    document.addEventListener('click', (e)=>{
      if(!notifPanel) return;
      const t=e.target;
      if(!notifPanel.contains(t) && t!==notifBell && !notifBell.contains(t)){
        notifPanel.classList.add('hidden');
      }
    });
    document.getElementById('notifMarkAll')?.addEventListener('click', async ()=>{
      if(!getToken()) return;
      try{
        const rc=await authFetch('/api/chats/');
        if(!rc.ok) return;
        const convs=await rc.json();
        const now=new Date().toISOString();
        for(const c of convs){
          localStorage.setItem(`chat_last_read_${c.id}`, now);
          authFetch(`/api/chats/${c.id}/read/`,{method:'POST'}).catch(()=>{});
        }
        document.getElementById('notifList').innerHTML='<div class="p-3 text-slate-400 empty">{% trans "Sin notificaciones" %}</div>';
        setBadge(0);
      }catch{}
    });

    tickNotifications();
    setInterval(tickNotifications, 10000);
  </script>
</body>
</html>
