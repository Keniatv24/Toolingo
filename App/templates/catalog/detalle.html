{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Detalle del artículo – Toolingo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { colors: {
      brand: {50:'#fff7ed',100:'#ffedd5',600:'#f97316',700:'#c2410c'}
    }}}}
  </script>
</head>
<body class="text-slate-800">
  <!-- Navbar mínima -->
  <header class="sticky top-0 bg-white/80 backdrop-blur border-b border-slate-200 z-50">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-6">
      <a href="/" class="flex items-center gap-2">
        <svg width="26" height="26" viewBox="0 0 24 24" class="text-brand-600 fill-current"><path d="M21 7.5a5.5 5.5 0 0 1-7.53 5.09l-6.44 6.44a1.5 1.5 0 0 1-2.12-2.12l6.44-6.44A5.5 5.5 0 1 1 21 7.5Z"/></svg>
        <span class="text-lg font-extrabold">Toolingo</span>
      </a>
      <nav class="hidden md:flex gap-6 text-sm ml-auto">
        <a href="/" class="hover:text-brand-600">Inicio</a>
        <a href="/catalogo/" class="font-semibold text-brand-700">Productos</a>
        <a href="/api/docs/" class="hover:text-brand-600">API</a>
        <a href="/publicar/" class="hover:text-brand-600 font-semibold">Publicar</a>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8">
    <a href="/catalogo/" class="text-sm text-brand-700 hover:underline">&larr; Volver al catálogo</a>

    <div id="wrap" class="mt-4 grid lg:grid-cols-12 gap-8">
      <!-- Galería -->
      <section class="lg:col-span-6">
        <div id="gallery" class="rounded-2xl border bg-white p-3">
          <div class="aspect-[16/10] rounded-xl bg-slate-100" id="galleryMain"></div>
        </div>
        <div id="thumbs" class="mt-3 flex gap-2 overflow-x-auto"></div>
      </section>

      <!-- Datos -->
      <section class="lg:col-span-6">
        <h1 id="title" class="text-2xl md:text-3xl font-extrabold tracking-tight">Cargando...</h1>
        <div class="mt-2 text-slate-600" id="ubiprice"></div>

        <div class="mt-4 p-4 rounded-2xl border bg-white">
          <h2 class="font-semibold">Descripción</h2>
          <p id="desc" class="text-slate-700 mt-2">Cargando…</p>
        </div>

        <div class="mt-4 p-4 rounded-2xl border bg-white">
          <h2 class="font-semibold">Propietario</h2>
          <div id="owner" class="text-slate-700 mt-2">Cargando…</div>
        </div>

        <div class="mt-6 flex gap-3">
          <a id="reservarBtn" href="#" class="px-5 py-3 rounded-xl bg-brand-600 text-white hover:bg-brand-700 transition">Reservar</a>
          <a id="contactarBtn" href="#" class="px-5 py-3 rounded-xl border hover:bg-slate-50 transition">Contactar</a>
        </div>
      </section>
    </div>
  </main>

  <footer class="py-10 text-center text-sm text-slate-500">© <span id="y"></span> Toolingo</footer>
  <script>document.getElementById('y').textContent = new Date().getFullYear()</script>

  <script>
    // ========== FETCH DETALLE ==========
    const ART_ID_SERVER = "{{ articulo_id }}"; // string desde Django (uuid o int)
    const fmt = n => Number(n||0).toLocaleString('es-CO');

    // Obtiene ID/slug desde la URL si no vino por contexto
    function getIdFromPath() {
      const parts = location.pathname.split('/').filter(Boolean); // ["articulo","<id>"]
      return parts[1] || "";
    }

    async function fetchByIdOrSlug(idOrSlug) {
      // 1) intenta por /api/articulos/{id}/
      const direct = await fetch(`/api/articulos/${encodeURIComponent(idOrSlug)}/`);
      if (direct.ok) return direct.json();

      // 2) si no existe como id, intenta por ?slug=
      const q = await fetch(`/api/articulos/?slug=${encodeURIComponent(idOrSlug)}`);
      if (q.ok) {
        const arr = await q.json();
        if (Array.isArray(arr) && arr.length) return arr[0];
      }

      // 3) como fallback, intenta buscar por search=
      const s = await fetch(`/api/articulos/?search=${encodeURIComponent(idOrSlug)}&ordering=-creado`);
      if (s.ok) {
        const arr = await s.json();
        if (Array.isArray(arr) && arr.length) return arr[0];
      }

      // si nada funcionó:
      throw new Error('Articulo no encontrado');
    }

    function renderArticulo(a) {
      // Título, ubicación, precio
      document.getElementById('title').textContent = a.titulo || 'Artículo';
      const ubi = a.ubicacion ? a.ubicacion : '';
      const price = a.precio_por_dia ? `$${fmt(a.precio_por_dia)}/día` : '';
      document.getElementById('ubiprice').textContent = [ubi, price].filter(Boolean).join(' • ') || '—';

      // Descripción
      document.getElementById('desc').textContent = a.descripcion || 'Sin descripción.';

      // Propietario
      const owner =
        a.propietario_nombre ||
        a.dueno_nombre ||
        (typeof a.propietario === 'object' ? (a.propietario.nombre || a.propietario.email) : a.propietario) ||
        'No disponible';
      document.getElementById('owner').textContent = owner;

      // Galería
      const main = document.getElementById('galleryMain');
      const thumbs = document.getElementById('thumbs');
      const imagenes = [];
      if (a.portada) imagenes.push(a.portada);
      if (Array.isArray(a.imagenes)) {
        a.imagenes.forEach(img => {
          const url = (img && (img.url || img.imagen || img.file)) || img;
          if (url) imagenes.push(url);
        });
      }

      if (imagenes.length) {
        main.innerHTML = `<img src="${imagenes[0]}" class="w-full h-full object-cover rounded-xl" alt="${a.titulo || 'Artículo'}" />`;
        thumbs.innerHTML = imagenes.map((u,i)=>`
          <button class="h-16 w-24 rounded-lg overflow-hidden border ${i===0?'ring-2 ring-brand-600':''}" data-i="${i}" type="button" aria-label="Ver imagen ${i+1}">
            <img src="${u}" class="w-full h-full object-cover" alt="Miniatura ${i+1}" />
          </button>
        `).join('');

        thumbs.addEventListener('click', (e)=>{
          const b = e.target.closest('button[data-i]'); if(!b) return;
          const idx = +b.dataset.i;
          main.innerHTML = `<img src="${imagenes[idx]}" class="w-full h-full object-cover rounded-xl" alt="${a.titulo || 'Artículo'}" />`;
          thumbs.querySelectorAll('button').forEach(x=>x.classList.remove('ring-2','ring-brand-600'));
          b.classList.add('ring-2','ring-brand-600');
        });
      } else {
        thumbs.innerHTML = '';
      }

      // Botones (ajusta rutas reales)
      const artRef = a.id || ART_ID; // usa id del objeto si existe
      document.getElementById('reservarBtn').href  = `/publicar/?art=${encodeURIComponent(artRef)}`;
      document.getElementById('contactarBtn').href = `/chat/?art=${encodeURIComponent(artRef)}`;
    }

    async function loadArticulo() {
      const fromContext = ART_ID_SERVER && ART_ID_SERVER !== "None" ? ART_ID_SERVER : "";
      const candidate = fromContext || getIdFromPath();

      try {
        const articulo = await fetchByIdOrSlug(candidate);
        renderArticulo(articulo);
      } catch (err) {
        document.getElementById('title').textContent = 'Artículo no encontrado';
        document.getElementById('desc').textContent = 'No pudimos cargar la información del artículo.';
        console.error(err);
      }
    }

    // Carga
    loadArticulo();
  </script>
</body>
</html>
