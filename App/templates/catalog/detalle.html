{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Detalle del art√≠culo ‚Äì Toolingo</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { brand: {50:'#fff7ed',100:'#ffedd5',600:'#f97316',700:'#c2410c'} },
          boxShadow: { soft:'0 10px 30px rgba(15,23,42,.06)', lift:'0 16px 44px rgba(15,23,42,.12)' }
        }
      }
    }
  </script>

  <!-- Flatpickr (datepicker) -->
  <link href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n/es.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/plugins/rangePlugin.js"></script>

  <style>
    .thumb:is(button)[data-active="true"]{ outline: 2px solid #f97316; outline-offset: 0; }
    .smooth { transition: all .25s cubic-bezier(.22,.61,.36,1); }

    /* ===== Booking-like styles ===== */
    .flatpickr-calendar {
      border-radius: 14px !important;
      box-shadow: 0 18px 48px rgba(15,23,42,.18) !important;
      border: 1px solid #e2e8f0 !important;
    }
    .flatpickr-day { font-weight: 500; border-radius: 8px !important; }
    .flatpickr-day.inRange,
    .flatpickr-day.prevMonthDay.inRange,
    .flatpickr-day.nextMonthDay.inRange{
      background:#e7f0ff !important; border-color:#e7f0ff !important; color:#0f172a !important;
    }
    .flatpickr-day.startRange, .flatpickr-day.endRange{
      background:#2563eb !important; color:#fff !important; border-color:#2563eb !important;
    }
    .flatpickr-day.startRange { border-top-left-radius:10px !important; border-bottom-left-radius:10px !important; }
    .flatpickr-day.endRange   { border-top-right-radius:10px !important; border-bottom-right-radius:10px !important; }
    .flatpickr-day.inRange:hover{ background:#dbeafe !important; }

    /* D√≠as no disponibles (rojo) */
    .flatpickr-day.tl-unavailable,
    .flatpickr-day.tl-unavailable:focus {
      background:#fee2e2 !important;
      border-color:#fecaca !important;
      color:#b91c1c !important;
      cursor:not-allowed !important;
    }
    .flatpickr-day.tl-unavailable:hover { background:#fecaca !important; }

    .tl-legend { font-size:12px; color:#475569; }
    .tl-dot { display:inline-block; width:.6rem; height:.6rem; border-radius:9999px; background:#ef4444; vertical-align:middle; margin-right:.4rem; }

    /* ===== Chat overlay ===== */
    .chat-overlay-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.35); display:none; z-index: 9998; }
    .chat-overlay {
      position: fixed; right: 32px; bottom: 32px;
      width: min(900px, 92vw); height: min(720px, 90vh);
      background: #fff; border-radius: 16px; box-shadow: 0 24px 72px rgba(0,0,0,.28);
      overflow: hidden; display:none; z-index: 9999;
    }
    .chat-overlay header { height: 48px; display:flex; align-items:center; justify-content:space-between; padding: 0 12px; background:#0f172a; color:#fff; font-weight:600; }
    .chat-overlay header button { background: transparent; border:0; color:#fff; font-size:20px; cursor:pointer; }
    .chat-overlay iframe { width:100%; height: calc(100% - 48px); border:0; }
    @media (max-width: 640px){
      .chat-overlay { left: 0; right: 0; top: 0; bottom: 0; width: 100vw; height: 100vh; border-radius: 0; }
      .chat-overlay iframe { height: calc(100% - 48px); }
    }
  </style>
</head>
<body class="text-slate-800 bg-white">
  <!-- NAVBAR -->
  <header class="sticky top-0 z-50 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-6">
      <a href="/" class="flex items-center gap-2">
        <svg width="26" height="26" viewBox="0 0 24 24" class="text-brand-600 fill-current">
          <path d="M21 7.5a5.5 5.5 0 0 1-7.53 5.09l-6.44 6.44a1.5 1.5 0 0 1-2.12-2.12l6.44-6.44A5.5 5.5 0 1 1 21 7.5Z"/>
        </svg>
        <span class="text-lg font-extrabold">Toolingo</span>
      </a>
      <nav class="hidden md:flex ml-auto items-center gap-6 text-sm">
        <a href="/" class="hover:text-brand-600">Inicio</a>
        <a href="/catalogo/" class="font-semibold text-brand-700">Productos</a>
        <a href="/publicar/" id="btnPublicar" class="font-semibold hover:text-brand-600">Publicar</a>

        <!-- Carrito -->
        <button id="cartBtn" class="relative p-2 rounded-lg hover:bg-slate-100" title="Carrito">
          üõí
          <span id="cartBadge" class="absolute -top-1 -right-1 text-[11px] px-1.5 py-0.5 rounded-full bg-brand-600 text-white hidden">0</span>
        </button>

        <!-- Campanita de notificaciones -->
        <button id="notifBell" class="relative p-2 rounded-lg hover:bg-slate-100" title="Notificaciones">
          üîî
          <span id="notifBadge" class="absolute -top-1 -right-1 text-[11px] px-1.5 py-0.5 rounded-full bg-red-600 text-white hidden">0</span>
        </button>
      </nav>

      <!-- Panel flotante de notificaciones -->
      <div id="notifPanel" class="hidden absolute right-4 top-14 w-80 max-h-96 overflow-auto bg-white border rounded-xl shadow-xl z-[10000]">
        <div class="px-4 py-2 border-b font-semibold">Notificaciones</div>
        <div id="notifList" class="p-2 text-sm text-slate-600">
          <div class="p-3 text-slate-400">Sin notificaciones</div>
        </div>
        <div class="px-3 py-2 border-t text-right">
          <button id="notifMarkAll" class="text-xs px-2 py-1 rounded bg-slate-100 hover:bg-slate-200">Marcar todo como le√≠do</button>
        </div>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-6xl mx-auto px-4 py-8">
    <a href="/catalogo/" class="inline-flex items-center gap-2 text-sm text-brand-700 hover:underline">
      <span aria-hidden="true">‚Üê</span> Volver al cat√°logo
    </a>

    <div class="mt-4 grid lg:grid-cols-12 gap-8">
      <!-- GALER√çA -->
      <section class="lg:col-span-6">
        <div class="rounded-2xl border bg-white p-3 shadow-soft">
          <div id="galleryMain" class="aspect-[16/10] rounded-xl bg-slate-100 overflow-hidden smooth"></div>
        </div>
        <div id="thumbs" class="mt-3 flex gap-3 overflow-x-auto py-1"></div>
      </section>

      <!-- DATOS -->
      <section class="lg:col-span-6">
        <div class="flex items-start flex-wrap gap-3">
          <h1 id="title" class="text-3xl md:text-4xl font-extrabold tracking-tight">Cargando‚Ä¶</h1>
          <div id="pricePill" class="ml-auto inline-flex items-center gap-2 px-3 py-1 rounded-full bg-brand-50 text-brand-700 text-sm font-semibold hidden"></div>
        </div>
        <p id="ubiprice" class="mt-2 text-slate-600"></p>

        <!-- Descripci√≥n -->
        <div class="mt-4 p-5 rounded-2xl border bg-white shadow-soft">
          <div class="flex items-center gap-2 mb-2">
            <span class="inline-block h-2 w-2 rounded-full bg-brand-600"></span>
            <h2 class="font-semibold">Descripci√≥n</h2>
          </div>
          <p id="desc" class="text-slate-700 leading-relaxed">Cargando‚Ä¶</p>
        </div>

        <!-- Propietario -->
        <div class="mt-4 p-5 rounded-2xl border bg-white shadow-soft">
          <div class="flex items-center gap-2 mb-3">
            <span class="inline-block h-2 w-2 rounded-full bg-brand-600"></span>
            <h2 class="font-semibold">Propietario</h2>
          </div>
          <div id="owner" class="flex items-center gap-4"></div>
        </div>

        <!-- Acciones -->
        <div class="mt-6 flex flex-wrap gap-3 items-center">
          <a id="reservarBtn" href="#" class="px-5 py-3 rounded-xl bg-brand-600 text-white hover:bg-brand-700 smooth shadow-soft hover:shadow-lift">Reservar</a>
          <button id="btnContactar" type="button" class="px-4 py-3 rounded-xl border hover:bg-slate-50 smooth">Contactar</button>
          <button id="shareBtn" type="button" class="px-4 py-3 rounded-xl border hover:bg-slate-50 smooth">Compartir</button>
          <button id="checkoutBtn" type="button" class="px-5 py-3 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 smooth ml-auto hidden">Continuar compra</button>
        </div>
      </section>
    </div>
  </main>

  <footer class="py-10 text-center text-sm text-slate-500">¬© <span id="y"></span> Toolingo</footer>
  <script>document.getElementById('y').textContent = new Date().getFullYear()</script>

  <!-- ===== Modal Reserva (Booking-like) ===== -->
  <div id="reservaModal" class="fixed inset-0 z-[60] hidden">
    <div class="absolute inset-0 bg-black/30" data-close="true"></div>
    <div class="absolute inset-0 grid place-items-center p-4">
      <div class="w-full max-w-2xl rounded-2xl bg-white shadow-xl border">
        <div class="px-5 py-4 border-b flex items-center justify-between">
          <h3 class="text-lg font-semibold">Reservar <span id="mArtTitle" class="font-bold"></span></h3>
          <button type="button" class="p-2 rounded hover:bg-slate-100" data-close="true">‚úï</button>
        </div>

        <div class="p-5 grid gap-4">
          <div class="grid sm:grid-cols-2 gap-4">
            <label class="grid gap-1">
              <span class="text-sm text-slate-600">Fecha inicio</span>
              <input id="fInicio" type="text" class="border rounded-xl px-3 py-2" placeholder="dd/mm/aaaa">
            </label>
            <label class="grid gap-1">
              <span class="text-sm text-slate-600">Fecha fin</span>
              <input id="fFin" type="text" class="border rounded-xl px-3 py-2" placeholder="dd/mm/aaaa">
            </label>
          </div>

          <div class="flex items-center gap-3 text-sm">
            <div class="tl-legend"><span class="tl-dot"></span>D√≠as no disponibles</div>
            <div id="dispMsg" class="text-sm text-slate-600"></div>
          </div>

          <div class="rounded-2xl bg-slate-50 p-4 text-sm">
            <div class="flex items-center justify-between">
              <span>D√≠as</span><span class="font-semibold" id="sumDias">‚Äî</span>
            </div>
            <div class="flex items-center justify-between mt-1">
              <span>Precio por d√≠a</span><span class="font-semibold" id="sumPPD">‚Äî</span>
            </div>
            <div class="flex items-center justify-between mt-3 pt-3 border-t text-base">
              <span class="font-semibold">Total estimado</span>
              <span class="font-bold text-slate-900" id="sumTotal">‚Äî</span>
            </div>
          </div>

          <div class="text-[12px] text-slate-500">
            * El precio final se confirma al crear la solicitud.
          </div>
        </div>

        <div class="px-5 py-4 border-t flex gap-3 justify-end">
          <button type="button" class="px-4 py-2 rounded-lg border hover:bg-slate-50" data-close="true">Cancelar</button>
          <button id="btnConfirmar" type="button" class="px-4 py-2 rounded-lg bg-brand-600 text-white hover:bg-brand-700 disabled:opacity-50" disabled>Agregar al carrito</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Chat Overlay ===== -->
  <div id="chatBackdrop" class="chat-overlay-backdrop"></div>
  <div id="chatOverlay" class="chat-overlay" role="dialog" aria-modal="true" aria-label="Chat">
    <header>
      <span>Chat</span>
      <button id="chatClose" title="Cerrar">‚úï</button>
    </header>
    <iframe id="chatFrame" src="" loading="lazy"></iframe>
  </div>

  <script>
    /* ===== Utils / Auth ===== */
    const ART_ID_SERVER = "{{ articulo_id }}";  /* si tu vista pasa articulo_id */
    const ownerBox = document.getElementById('owner');
    const fmt = n => Number(n||0).toLocaleString('es-CO');
    const fmtCOP = x => Number(x||0).toLocaleString('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0});
    const oneDay = 24*60*60*1000;

    // Tokens
    const TOKEN_KEY='access', REFRESH_KEY='refresh';
    function getToken(){ return localStorage.getItem(TOKEN_KEY) || null; }
    function getRefresh(){ return localStorage.getItem(REFRESH_KEY) || null; }
    function setTokens({access,refresh}){ if(access) localStorage.setItem(TOKEN_KEY,access); if(refresh) localStorage.setItem(REFRESH_KEY,refresh); }
    async function refreshAccessToken(){
      const refresh=getRefresh(); if(!refresh) return null;
      const r=await fetch('/api/token/refresh/',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({refresh})});
      if(!r.ok) return null; const d=await r.json();
      if(d.access){ setTokens({access:d.access}); return d.access; } return null;
    }
    async function authFetch(url,opt={}){
      const t=getToken();
      if(!t){ location.href=`/login/?next=${encodeURIComponent(location.pathname)}`; throw new Error('No autenticado'); }
      const h=new Headers(opt.headers||{});
      h.set('Authorization',`Bearer ${t}`);
      if(opt.body && !h.has('Content-Type')) h.set('Content-Type','application/json');
      let resp=await fetch(url,{...opt,headers:h});
      if(resp.status===401){
        const na=await refreshAccessToken(); if(!na) return resp;
        h.set('Authorization',`Bearer ${na}`); resp=await fetch(url,{...opt,headers:h});
      }
      return resp;
    }

    // Publicar -> fuerza login si no hay token
    (function(){
      const t = getToken();
      const a = document.getElementById('btnPublicar');
      if (!t && a) a.href = '/login/?next=/publicar/';
    })();

    // Carrito (badge + click)
    const cartBtn = document.getElementById('cartBtn');
    const cartBadge = document.getElementById('cartBadge');
    cartBtn?.addEventListener('click', () => {
      const t = getToken();
      if (!t) location.href = '/login/?next=/carrito/';
      else location.href = '/carrito/';
    });
    (async () => {
      if (!getToken()) { cartBadge?.classList.add('hidden'); return; }
      try {
        const r = await authFetch('/api/carrito/');
        if (!r.ok) return;
        const items = await r.json();
        cartBadge.classList.toggle('hidden', items.length === 0);
        cartBadge.textContent = items.length;
      } catch(_) {}
    })();

    // ===== Notificaciones (campanita) =====
    const notifBell  = document.getElementById('notifBell');
    const notifBadge = document.getElementById('notifBadge');
    const notifPanel = document.getElementById('notifPanel');
    const notifList  = document.getElementById('notifList');
    const notifMarkAll = document.getElementById('notifMarkAll');

    function togglePanel(){ notifPanel.classList.toggle('hidden'); }
    document.addEventListener('click',(e)=>{
      if (!notifPanel) return;
      if (notifPanel.contains(e.target) || notifBell.contains(e.target)) return;
      notifPanel.classList.add('hidden');
    });
    notifBell?.addEventListener('click',togglePanel);

    async function loadNotifs(){
      if (!getToken()) return;
      try{
        const r = await authFetch('/api/notificaciones/?ordering=-creado&limit=20');
        if(!r.ok) return;
        const data = await r.json(); // espera array [{id,texto,leido,creado},...]
        const list = Array.isArray(data) ? data : (data.results || []);
        const unread = list.filter(n=>!n.leido).length;
        notifBadge.classList.toggle('hidden', unread===0);
        notifBadge.textContent = unread;
        if (list.length===0){
          notifList.innerHTML = `<div class="p-3 text-slate-400">Sin notificaciones</div>`;
        } else {
          notifList.innerHTML = list.map(n => `
            <div class="p-2 rounded ${n.leido?'':'bg-slate-50'}">
              <div class="text-sm ${n.leido?'text-slate-600':'text-slate-900 font-medium'}">${n.texto || 'Notificaci√≥n'}</div>
              <div class="text-[11px] text-slate-400">${new Date(n.creado).toLocaleString('es-CO')}</div>
            </div>`).join('');
        }
      }catch(_) {}
    }
    notifMarkAll?.addEventListener('click', async ()=>{
      try{ await authFetch('/api/notificaciones/marcar-todas/',{method:'POST'}); }catch(_){}
      loadNotifs();
    });
    // Poll sencillo
    setInterval(loadNotifs, 10000);
    loadNotifs();

    // ====== Datos del art√≠culo ======
    function avatarHtml(nameLike){ const txt=(nameLike||'').trim(); const ini=txt?txt[0].toUpperCase():'üë§'; return `<div class="h-12 w-12 rounded-full bg-brand-100 text-brand-700 grid place-items-center text-lg font-bold">${ini}</div>`; }

    async function fetchByIdOrSlug(idOrSlug){
      const direct = await fetch(`/api/articulos/${encodeURIComponent(idOrSlug)}/`); if (direct.ok) return direct.json();
      const q = await fetch(`/api/articulos/?slug=${encodeURIComponent(idOrSlug)}`); if (q.ok){ const arr = await q.json(); if (Array.isArray(arr) && arr.length) return arr[0]; }
      const s = await fetch(`/api/articulos/?search=${encodeURIComponent(idOrSlug)}&ordering=-creado`); if (s.ok){ const arr = await s.json(); if (Array.isArray(arr) && arr.length) return arr[0]; }
      throw new Error('Articulo no encontrado');
    }

    function renderOwner(a){
      const info=a.propietario_info||{}; const pObj=typeof a.propietario==='object'?a.propietario:{}; 
      const nombre=info.nombre || a.propietario_nombre || pObj.nombre || pObj.full_name || pObj.username || a.dueno_nombre || '';
      const email=info.email || pObj.email || a.propietario_email || '';
      const tel=info.telefono || pObj.telefono || pObj.phone || a.propietario_telefono || '';
      const ubi=info.ubicacion || a.ubicacion_prop || '';
      ownerBox.innerHTML=`
        <div class="flex items-center gap-4 w-full">
          ${avatarHtml(nombre || email || a.propietario)}
          <div class="min-w-0">
            <div class="font-semibold">${ nombre || 'Propietario' }</div>
            <div class="text-sm text-slate-500 break-all">
              ${ ubi ? `<span class="inline-block mr-1.5 px-1.5 py-0.5 rounded bg-slate-100">${ubi}</span>` : '' }
              ${ email ? `<a class="hover:underline" href="mailto:${email}">${email}</a>` : '' }
              ${ email && tel ? ' ‚Ä¢ ' : '' }
              ${ tel ? `<a class="hover:underline" href="tel:${tel}">${tel}</a>` : '' }
              ${ (!email && !tel && a.propietario) ? `<span class="text-slate-400">${a.propietario}</span>` : '' }
            </div>
          </div>
        </div>`;
    }

    function renderArticulo(a){
      document.getElementById('title').textContent = a.titulo || 'Art√≠culo';
      const ubi=a.ubicacion || ''; const price=a.precio_por_dia ? `$${fmt(a.precio_por_dia)}/d√≠a` : '';
      document.getElementById('ubiprice').textContent = [ubi, price].filter(Boolean).join(' ‚Ä¢ ') || '‚Äî';
      const pricePill=document.getElementById('pricePill'); if(price){ pricePill.textContent=price; pricePill.classList.remove('hidden'); }
      document.getElementById('desc').textContent = a.descripcion || 'Sin descripci√≥n.'; renderOwner(a);

      // Galer√≠a
      const main=document.getElementById('galleryMain'); const thumbs=document.getElementById('thumbs'); const imgs=[];
      if (a.portada) imgs.push(a.portada);
      if (Array.isArray(a.imagenes)) a.imagenes.forEach(img=>{ const u=(img&&(img.url||img.imagen||img.file))||img; if(u) imgs.push(u); });
      if (imgs.length){
        main.innerHTML=`<img src="${imgs[0]}" class="w-full h-full object-cover rounded-xl smooth" alt="${a.titulo || 'Art√≠culo'}">`;
        thumbs.innerHTML=imgs.map((u,i)=>`<button type="button" class="thumb h-16 w-24 rounded-lg overflow-hidden border smooth" data-i="${i}" ${i===0?'data-active="true"':''}><img src="${u}" class="w-full h-full object-cover" alt="Miniatura ${i+1}"></button>`).join('');
        thumbs.addEventListener('click',e=>{ const b=e.target.closest('button.thumb'); if(!b) return; const idx=+b.dataset.i; main.innerHTML=`<img src="${imgs[idx]}" class="w-full h-full object-cover rounded-xl smooth" alt="${a.titulo || 'Art√≠culo'}">`; thumbs.querySelectorAll('button.thumb').forEach(x=>x.removeAttribute('data-active')); b.setAttribute('data-active','true'); });
      } else { main.innerHTML=`<div class="w-full h-full rounded-xl bg-slate-100"></div>`; thumbs.innerHTML=''; }

      // Botones
      document.getElementById('reservarBtn').addEventListener('click',(e)=>{ e.preventDefault(); openReservaModal(a); });
      document.getElementById('btnContactar').addEventListener('click', ()=> openChatOverlay(a.id || ART_ID_SERVER));
    }

    async function loadArticulo(){
      const candidate = (ART_ID_SERVER && ART_ID_SERVER !== "None") ? ART_ID_SERVER : location.pathname.split('/').filter(Boolean)[1] || "";
      try{ const articulo = await fetchByIdOrSlug(candidate); window.__ARTICULO__=articulo; renderArticulo(articulo); }
      catch(err){ document.getElementById('title').textContent='Art√≠culo no encontrado'; document.getElementById('desc').textContent='No pudimos cargar la informaci√≥n del art√≠culo.'; console.error(err); }
    }

    // ====== Chat Overlay ======
    function openChatOverlay(articleId){
      if (!localStorage.getItem('access') && !localStorage.getItem('jwt')) {
        window.location.href=`/login/?next=${encodeURIComponent(location.pathname)}`;
        return;
      }
      const frame=document.getElementById('chatFrame');
      const bust = Date.now(); // recarga forzada
      frame.src=`/chat/?embed=1&article=${encodeURIComponent(articleId)}&intent=contact&v=${bust}`;
      document.getElementById('chatBackdrop').style.display='block';
      document.getElementById('chatOverlay').style.display='block';
    }
    document.getElementById('chatClose').onclick = () => {
      document.getElementById('chatOverlay').style.display='none';
      document.getElementById('chatBackdrop').style.display='none';
      document.getElementById('chatFrame').src='about:blank';
    };
    document.getElementById('chatBackdrop').onclick = () => {
      document.getElementById('chatOverlay').style.display='none';
      document.getElementById('chatBackdrop').style.display='none';
      document.getElementById('chatFrame').src='about:blank';
    };

    // ====== Reserva (Booking-like) ======
    let __ART__ = null;          // se setea al abrir modal
    let __fpInstance = null;     // instancia de flatpickr

    function openReservaModal(a){
      __ART__ = a || window.__ARTICULO__ || {};
      document.getElementById('mArtTitle').textContent = __ART__.titulo || 'Art√≠culo';
      document.getElementById('reservaModal').classList.remove('hidden');
      initBookingCalendar(__ART__);
    }
    document.querySelectorAll('#reservaModal [data-close="true"]').forEach(el=>{
      el.addEventListener('click', ()=> document.getElementById('reservaModal').classList.add('hidden'));
    });

    // Disponibilidad
    async function fetchBookedDates(articleId){
      if (__ART__ && Array.isArray(__ART__.fechas_ocupadas) && __ART__.fechas_ocupadas.length){
        return { pricePerDay: __ART__.precio_por_dia || 0, booked: __ART__.fechas_ocupadas };
      }
      try{
        const r = await fetch(`/api/articulos/${encodeURIComponent(articleId)}/disponibilidad/`);
        if(!r.ok) throw 0;
        const data = await r.json();
        return { pricePerDay: data.price_per_day || 0, booked: data.booked || [] };
      }catch{
        return { pricePerDay: __ART__?.precio_por_dia || 0, booked: [] };
      }
    }
    function toFlatpickrDisable(booked){
      if (!Array.isArray(booked)) return [];
      return booked.map(b=>{
        if (typeof b === 'string') return b;
        if (b && b.from && b.to) return { from:b.from, to:b.to };
        return null;
      }).filter(Boolean);
    }
    function buildDisabledDateSet(booked){
      const set = new Set();
      const one = 24*60*60*1000;
      booked.forEach(b=>{
        if (typeof b === 'string'){
          set.add(b);
        } else if (b && b.from && b.to){
          const d0 = new Date(b.from+'T00:00:00'); const d1 = new Date(b.to+'T00:00:00');
          for(let t=d0.getTime(); t<=d1.getTime(); t+=one){
            set.add(new Date(t).toISOString().slice(0,10));
          }
        }
      });
      return set;
    }

    async function initBookingCalendar(art){
      const fIni = document.getElementById('fInicio');
      const fFin = document.getElementById('fFin');
      const diasEl = document.getElementById('sumDias');
      const ppdEl  = document.getElementById('sumPPD');
      const totEl  = document.getElementById('sumTotal');
      const btnAdd = document.getElementById('btnConfirmar');
      const dispMsg= document.getElementById('dispMsg');

      fIni.value=''; fFin.value=''; diasEl.textContent='‚Äî'; ppdEl.textContent='‚Äî'; totEl.textContent='‚Äî'; btnAdd.disabled=true; dispMsg.textContent='';

      const { pricePerDay, booked } = await fetchBookedDates(art.id || ART_ID_SERVER);
      ppdEl.textContent = pricePerDay ? fmtCOP(pricePerDay) : '‚Äî';
      const disableList = toFlatpickrDisable(booked);
      const disabledSet = buildDisabledDateSet(booked);

      if (__fpInstance) { try{__fpInstance.destroy();}catch{} __fpInstance=null; }

      __fpInstance = flatpickr(fIni, {
        altInput: true,
        altFormat: "d/m/Y",
        dateFormat: "Y-m-d",
        mode: "range",
        plugins: [ new rangePlugin({ input: "#fFin" }) ],
        minDate: "today",
        disable: disableList,
        showMonths: 2,
        locale: "es",
        onDayCreate: function(_, __, ___, dayElem){
          const dateStr = dayElem.dateObj?.toISOString?.().slice(0,10);
          if (dateStr && disabledSet.has(dateStr)) dayElem.classList.add("tl-unavailable");
        },
        onChange: function(selected){
          if (selected.length < 2){ diasEl.textContent='‚Äî'; totEl.textContent='‚Äî'; btnAdd.disabled=true; return; }
          const d0 = new Date(selected[0].setHours(0,0,0,0));
          const d1 = new Date(selected[1].setHours(0,0,0,0));

          // verificar bloqueos en el medio
          for(let t=d0.getTime(); t<=d1.getTime(); t+=oneDay){
            const iso = new Date(t).toISOString().slice(0,10);
            if (disabledSet.has(iso)){ dispMsg.innerHTML = `<span class="text-red-600 font-medium">‚ö† Hay d√≠as no disponibles dentro del rango.</span>`; btnAdd.disabled=true; return; }
          }
          dispMsg.textContent = 'Fechas disponibles ‚úÖ';
          const days = Math.max(1, Math.round((d1 - d0)/oneDay) + 1);
          diasEl.textContent = String(days);
          totEl.textContent = fmtCOP(days * (pricePerDay || 0));
          btnAdd.disabled = false;
        }
      });
    }

    async function addToCart({artId, startISO, endISO}){
      const r = await authFetch('/api/carrito/',{
        method:'POST',
        body: JSON.stringify({ articulo: artId, fecha_inicio: startISO, fecha_fin: endISO })
      });
      return r;
    }
    document.getElementById('btnConfirmar').addEventListener('click', async ()=>{
      if (!__fpInstance) return;
      const sel = __fpInstance.selectedDates || [];
      if (sel.length < 2) return;
      const d0 = sel[0]; const d1 = sel[1];
      const startISO = d0.toISOString().slice(0,10);
      const endISO   = d1.toISOString().slice(0,10);
      const artId    = (__ART__ && (__ART__.id || __ART__.pk)) || ART_ID_SERVER;

      try{
        const resp = await addToCart({artId, startISO, endISO});
        if (!resp.ok){
          const msg = (await resp.json().catch(()=>({}))).detail || 'No se pudo agregar al carrito.';
          alert(msg); return;
        }
        window.location.href = '/carrito/';
      }catch(e){ alert('No se pudo agregar al carrito.'); }
    });

    /* ===== Arranque ===== */
    loadArticulo();
  </script>
</body>
</html>
