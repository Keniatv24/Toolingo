{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Detalle del art√≠culo ‚Äì Toolingo</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {50:'#fff7ed',100:'#ffedd5',600:'#f97316',700:'#c2410c'}
          },
          boxShadow: {
            soft:'0 10px 30px rgba(15,23,42,.06)',
            lift:'0 16px 44px rgba(15,23,42,.12)'
          }
        }
      }
    }
  </script>

  <style>
    .thumb:is(button)[data-active="true"]{ outline: 2px solid #f97316; outline-offset: 0; }
    .smooth { transition: all .25s cubic-bezier(.22,.61,.36,1); }
  </style>
</head>
<body class="text-slate-800 bg-white">
  <!-- NAVBAR -->
  <header class="sticky top-0 z-50 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-6">
      <a href="/" class="flex items-center gap-2">
        <svg width="26" height="26" viewBox="0 0 24 24" class="text-brand-600 fill-current">
          <path d="M21 7.5a5.5 5.5 0 0 1-7.53 5.09l-6.44 6.44a1.5 1.5 0 0 1-2.12-2.12l6.44-6.44A5.5 5.5 0 1 1 21 7.5Z"/>
        </svg>
        <span class="text-lg font-extrabold">Toolingo</span>
      </a>
      <nav class="hidden md:flex ml-auto items-center gap-6 text-sm">
        <a href="/" class="hover:text-brand-600">Inicio</a>
        <a href="/catalogo/" class="font-semibold text-brand-700">Productos</a>
        <a href="/api/docs/" class="hover:text-brand-600">API</a>
        <a href="/publicar/" class="font-semibold hover:text-brand-600">Publicar</a>
      </nav>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-6xl mx-auto px-4 py-8">
    <a href="/catalogo/" class="inline-flex items-center gap-2 text-sm text-brand-700 hover:underline">
      <span aria-hidden="true">‚Üê</span> Volver al cat√°logo
    </a>

    <div class="mt-4 grid lg:grid-cols-12 gap-8">
      <!-- GALER√çA -->
      <section class="lg:col-span-6">
        <div class="rounded-2xl border bg-white p-3 shadow-soft">
          <div id="galleryMain" class="aspect-[16/10] rounded-xl bg-slate-100 overflow-hidden smooth">
            <!-- imagen principal aqu√≠ -->
          </div>
        </div>
        <div id="thumbs" class="mt-3 flex gap-3 overflow-x-auto py-1"></div>
      </section>

      <!-- DATOS -->
      <section class="lg:col-span-6">
        <div class="flex items-start flex-wrap gap-3">
          <h1 id="title" class="text-3xl md:text-4xl font-extrabold tracking-tight">Cargando‚Ä¶</h1>
          <div id="pricePill" class="ml-auto inline-flex items-center gap-2 px-3 py-1 rounded-full bg-brand-50 text-brand-700 text-sm font-semibold hidden">
            <!-- Precio se inyecta -->
          </div>
        </div>
        <p id="ubiprice" class="mt-2 text-slate-600"></p>

        <!-- Descripci√≥n -->
        <div class="mt-4 p-5 rounded-2xl border bg-white shadow-soft">
          <div class="flex items-center gap-2 mb-2">
            <span class="inline-block h-2 w-2 rounded-full bg-brand-600"></span>
            <h2 class="font-semibold">Descripci√≥n</h2>
          </div>
          <p id="desc" class="text-slate-700 leading-relaxed">Cargando‚Ä¶</p>
        </div>

        <!-- Propietario -->
        <div class="mt-4 p-5 rounded-2xl border bg-white shadow-soft">
          <div class="flex items-center gap-2 mb-3">
            <span class="inline-block h-2 w-2 rounded-full bg-brand-600"></span>
            <h2 class="font-semibold">Propietario</h2>
          </div>

          <div id="owner" class="flex items-center gap-4">
            <!-- Tarjeta propietario se inyecta aqu√≠ -->
          </div>
        </div>

        <!-- Acciones -->
        <div class="mt-6 flex flex-wrap gap-3">
          <a id="reservarBtn" href="#"
             class="px-5 py-3 rounded-xl bg-brand-600 text-white hover:bg-brand-700 smooth shadow-soft hover:shadow-lift">
            Reservar
          </a>
          <a id="contactarBtn" href="#"
             class="px-5 py-3 rounded-xl border hover:bg-slate-50 smooth">
            Contactar
          </a>
          <button id="shareBtn" type="button"
                  class="px-4 py-3 rounded-xl border hover:bg-slate-50 smooth">
            Compartir
          </button>
        </div>
      </section>
    </div>
  </main>

  <footer class="py-10 text-center text-sm text-slate-500">¬© <span id="y"></span> Toolingo</footer>
  <script>document.getElementById('y').textContent = new Date().getFullYear()</script>

  <script>
    // ========= DETALLE =========
    const ART_ID_SERVER = "{{ articulo_id }}"; // string (uuid o int)
    const fmt = n => Number(n||0).toLocaleString('es-CO');

    const ownerBox = document.getElementById('owner');

    function getIdFromPath(){
      const parts = location.pathname.split('/').filter(Boolean); // ["articulo","<id>"]
      return parts[1] || "";
    }

    // Busca por id directo, luego por slug, luego por search
    async function fetchByIdOrSlug(idOrSlug){
      const direct = await fetch(`/api/articulos/${encodeURIComponent(idOrSlug)}/`);
      if (direct.ok) return direct.json();

      const q = await fetch(`/api/articulos/?slug=${encodeURIComponent(idOrSlug)}`);
      if (q.ok){
        const arr = await q.json();
        if (Array.isArray(arr) && arr.length) return arr[0];
      }

      const s = await fetch(`/api/articulos/?search=${encodeURIComponent(idOrSlug)}&ordering=-creado`);
      if (s.ok){
        const arr = await s.json();
        if (Array.isArray(arr) && arr.length) return arr[0];
      }
      throw new Error('Articulo no encontrado');
    }

    function avatarHtml(nameLike){
      const txt = (nameLike || '').trim();
      const ini = txt ? txt[0].toUpperCase() : 'üë§';
      return `
        <div class="h-12 w-12 rounded-full bg-brand-100 text-brand-700 grid place-items-center text-lg font-bold">
          ${ini}
        </div>`;
    }

    function renderOwner(a){
      // Intenta mapear propiedades comunes del serializer
      const p = typeof a.propietario === 'object' ? a.propietario : {};
      const nombre = a.propietario_nombre || p.nombre || p.full_name || p.username || a.dueno_nombre || '';
      const email  = p.email || a.propietario_email || '';
      const tel    = p.telefono || p.phone || a.propietario_telefono || '';

      ownerBox.innerHTML = `
        <div class="flex items-center gap-4 w-full">
          ${avatarHtml(nombre || email || a.propietario)}
          <div class="min-w-0">
            <div class="font-semibold">${ nombre || 'Propietario' }</div>
            <div class="text-sm text-slate-500 break-all">
              ${ email ? `<a class="hover:underline" href="mailto:${email}">${email}</a>` : '' }
              ${ email && tel ? ' ‚Ä¢ ' : '' }
              ${ tel ? `<a class="hover:underline" href="tel:${tel}">${tel}</a>` : '' }
              ${ (!email && !tel && a.propietario) ? `<span class="text-slate-400">${a.propietario}</span>` : '' }
            </div>
          </div>
        </div>
      `;
    }

    function renderArticulo(a){
      // T√≠tulo / ubicaci√≥n / precio
      document.getElementById('title').textContent = a.titulo || 'Art√≠culo';
      const ubi = a.ubicacion || '';
      const price = a.precio_por_dia ? `$${fmt(a.precio_por_dia)}/d√≠a` : '';
      document.getElementById('ubiprice').textContent = [ubi, price].filter(Boolean).join(' ‚Ä¢ ') || '‚Äî';

      const pricePill = document.getElementById('pricePill');
      if (price){
        pricePill.textContent = price;
        pricePill.classList.remove('hidden');
      }

      // Descripci√≥n
      document.getElementById('desc').textContent = a.descripcion || 'Sin descripci√≥n.';

      // Propietario
      renderOwner(a);

      // Galer√≠a
      const main = document.getElementById('galleryMain');
      const thumbs = document.getElementById('thumbs');
      const imagenes = [];
      if (a.portada) imagenes.push(a.portada);
      if (Array.isArray(a.imagenes)){
        a.imagenes.forEach(img => {
          const url = (img && (img.url || img.imagen || img.file)) || img;
          if (url) imagenes.push(url);
        });
      }
      if (imagenes.length){
        main.innerHTML = `<img src="${imagenes[0]}" class="w-full h-full object-cover rounded-xl smooth" alt="${a.titulo || 'Art√≠culo'}">`;
        thumbs.innerHTML = imagenes.map((u,i)=>`
          <button type="button" class="thumb h-16 w-24 rounded-lg overflow-hidden border smooth" data-i="${i}" ${i===0?'data-active="true"':''}>
            <img src="${u}" class="w-full h-full object-cover" alt="Miniatura ${i+1}">
          </button>
        `).join('');

        thumbs.addEventListener('click', e=>{
          const b = e.target.closest('button.thumb'); if (!b) return;
          const idx = +b.dataset.i;
          main.innerHTML = `<img src="${imagenes[idx]}" class="w-full h-full object-cover rounded-xl smooth" alt="${a.titulo || 'Art√≠culo'}">`;
          thumbs.querySelectorAll('button.thumb').forEach(x=>x.removeAttribute('data-active'));
          b.setAttribute('data-active','true');
        });
      } else {
        main.innerHTML = `<div class="w-full h-full rounded-xl bg-slate-100"></div>`;
        thumbs.innerHTML = '';
      }

      // Botones
      const artRef = a.id || ART_ID_SERVER;
      document.getElementById('reservarBtn').href  = `/publicar/?art=${encodeURIComponent(artRef)}`;
      document.getElementById('contactarBtn').href = `/chat/?art=${encodeURIComponent(artRef)}`;
    }

    async function loadArticulo(){
      const fromContext = ART_ID_SERVER && ART_ID_SERVER !== "None" ? ART_ID_SERVER : "";
      const candidate = fromContext || getIdFromPath();
      try{
        const articulo = await fetchByIdOrSlug(candidate);
        renderArticulo(articulo);
      }catch(err){
        document.getElementById('title').textContent = 'Art√≠culo no encontrado';
        document.getElementById('desc').textContent = 'No pudimos cargar la informaci√≥n del art√≠culo.';
        console.error(err);
      }
    }

    // Compartir
    document.getElementById('shareBtn')?.addEventListener('click', async ()=>{
      const url = location.href;
      try{
        if (navigator.share){
          await navigator.share({ title: document.title, url });
        } else {
          await navigator.clipboard.writeText(url);
          const btn = document.getElementById('shareBtn');
          const old = btn.textContent;
          btn.textContent = 'Enlace copiado';
          setTimeout(()=>btn.textContent = old, 1400);
        }
      }catch(_){}
    });

    loadArticulo();
  </script>
</body>
</html>
