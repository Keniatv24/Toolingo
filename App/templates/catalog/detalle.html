{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Detalle del art√≠culo ‚Äì Toolingo</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { brand: {50:'#fff7ed',100:'#ffedd5',600:'#f97316',700:'#c2410c'} },
          boxShadow: { soft:'0 10px 30px rgba(15,23,42,.06)', lift:'0 16px 44px rgba(15,23,42,.12)' }
        }
      }
    }
  </script>

  <!-- Flatpickr (datepicker) -->
  <link href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n/es.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/plugins/rangePlugin.js"></script>

  <style>
    .thumb:is(button)[data-active="true"]{ outline: 2px solid #f97316; outline-offset: 0; }
    .smooth { transition: all .25s cubic-bezier(.22,.61,.36,1); }

    /* D√≠as no disponibles (rojo) */
    .flatpickr-day.tl-unavailable,
    .flatpickr-day.tl-unavailable:focus {
      background:#fee2e2 !important; /* rojo 100 */
      border-color:#fecaca !important; /* rojo 200 */
      color:#b91c1c !important;       /* rojo 700 */
      cursor:not-allowed !important;
    }
    .flatpickr-day.tl-unavailable:hover {
      background:#fecaca !important;
    }

    /* Leyenda peque√±a bajo el calendario */
    .tl-legend { font-size:12px; color:#475569; }
    .tl-dot { display:inline-block; width:.6rem; height:.6rem; border-radius:9999px; background:#ef4444; vertical-align:middle; margin-right:.4rem; }
  </style>
</head>
<body class="text-slate-800 bg-white">
  <!-- NAVBAR -->
  <header class="sticky top-0 z-50 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-6">
      <a href="/" class="flex items-center gap-2">
        <svg width="26" height="26" viewBox="0 0 24 24" class="text-brand-600 fill-current">
          <path d="M21 7.5a5.5 5.5 0 0 1-7.53 5.09l-6.44 6.44a1.5 1.5 0 0 1-2.12-2.12l6.44-6.44A5.5 5.5 0 1 1 21 7.5Z"/>
        </svg>
        <span class="text-lg font-extrabold">Toolingo</span>
      </a>
      <nav class="hidden md:flex ml-auto items-center gap-6 text-sm">
        <a href="/" class="hover:text-brand-600">Inicio</a>
        <a href="/catalogo/" class="font-semibold text-brand-700">Productos</a>
        <a href="/api/docs/" class="hover:text-brand-600">API</a>
        <a href="/publicar/" class="font-semibold hover:text-brand-600">Publicar</a>

        <!-- Carrito (redirige a /carrito/) -->
        <button id="cartBtn" class="relative p-2 rounded-lg hover:bg-slate-100" title="Carrito">
          üõí
          <span id="cartBadge" class="absolute -top-1 -right-1 text-[11px] px-1.5 py-0.5 rounded-full bg-brand-600 text-white hidden">0</span>
        </button>
      </nav>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-6xl mx-auto px-4 py-8">
    <a href="/catalogo/" class="inline-flex items-center gap-2 text-sm text-brand-700 hover:underline">
      <span aria-hidden="true">‚Üê</span> Volver al cat√°logo
    </a>

    <div class="mt-4 grid lg:grid-cols-12 gap-8">
      <!-- GALER√çA -->
      <section class="lg:col-span-6">
        <div class="rounded-2xl border bg-white p-3 shadow-soft">
          <div id="galleryMain" class="aspect-[16/10] rounded-xl bg-slate-100 overflow-hidden smooth"></div>
        </div>
        <div id="thumbs" class="mt-3 flex gap-3 overflow-x-auto py-1"></div>
      </section>

      <!-- DATOS -->
      <section class="lg:col-span-6">
        <div class="flex items-start flex-wrap gap-3">
          <h1 id="title" class="text-3xl md:text-4xl font-extrabold tracking-tight">Cargando‚Ä¶</h1>
          <div id="pricePill" class="ml-auto inline-flex items-center gap-2 px-3 py-1 rounded-full bg-brand-50 text-brand-700 text-sm font-semibold hidden"></div>
        </div>
        <p id="ubiprice" class="mt-2 text-slate-600"></p>

        <!-- Descripci√≥n -->
        <div class="mt-4 p-5 rounded-2xl border bg-white shadow-soft">
          <div class="flex items-center gap-2 mb-2">
            <span class="inline-block h-2 w-2 rounded-full bg-brand-600"></span>
            <h2 class="font-semibold">Descripci√≥n</h2>
          </div>
          <p id="desc" class="text-slate-700 leading-relaxed">Cargando‚Ä¶</p>
        </div>

        <!-- Propietario -->
        <div class="mt-4 p-5 rounded-2xl border bg-white shadow-soft">
          <div class="flex items-center gap-2 mb-3">
            <span class="inline-block h-2 w-2 rounded-full bg-brand-600"></span>
            <h2 class="font-semibold">Propietario</h2>
          </div>
          <div id="owner" class="flex items-center gap-4"></div>
        </div>

        <!-- Acciones -->
        <div class="mt-6 flex flex-wrap gap-3 items-center">
          <a id="reservarBtn" href="#" class="px-5 py-3 rounded-xl bg-brand-600 text-white hover:bg-brand-700 smooth shadow-soft hover:shadow-lift">Reservar</a>
          <a id="contactarBtn" href="#" class="px-5 py-3 rounded-xl border hover:bg-slate-50 smooth">Contactar</a>
          <button id="shareBtn" type="button" class="px-4 py-3 rounded-xl border hover:bg-slate-50 smooth">Compartir</button>

          <!-- NUEVO: Continuar compra -->
          <button id="checkoutBtn" type="button"
                  class="px-5 py-3 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 smooth ml-auto hidden">
            Continuar compra
          </button>
        </div>
      </section>
    </div>
  </main>

  <footer class="py-10 text-center text-sm text-slate-500">¬© <span id="y"></span> Toolingo</footer>
  <script>document.getElementById('y').textContent = new Date().getFullYear()</script>

  <!-- ===== Modal Reserva ===== -->
  <div id="reservaModal" class="fixed inset-0 z-[60] hidden">
    <div class="absolute inset-0 bg-black/30" data-close="true"></div>
    <div class="absolute inset-0 grid place-items-center p-4">
      <div class="w-full max-w-lg rounded-2xl bg-white shadow-lift border">
        <div class="px-5 py-4 border-b flex items-center justify-between">
          <h3 class="text-lg font-semibold">Reservar <span id="mArtTitle" class="font-bold"></span></h3>
          <button type="button" class="p-2 rounded hover:bg-slate-100" data-close="true">‚úï</button>
        </div>

        <div class="p-5 grid gap-4">
          <div class="grid sm:grid-cols-2 gap-4">
            <label class="grid gap-1">
              <span class="text-sm text-slate-600">Fecha inicio</span>
              <input id="fInicio" type="text" class="border rounded-lg px-3 py-2" placeholder="dd/mm/aaaa">
            </label>
            <label class="grid gap-1">
              <span class="text-sm text-slate-600">Fecha fin</span>
              <input id="fFin" type="text" class="border rounded-lg px-3 py-2" placeholder="dd/mm/aaaa">
            </label>
          </div>

          <div class="tl-legend"><span class="tl-dot"></span>No disponible</div>
          <div id="dispMsg" class="text-sm"></div>

          <div class="rounded-xl bg-slate-50 p-4 grid grid-cols-2 gap-3 text-sm">
            <div>D√≠as</div><div class="text-right font-semibold" id="sumDias">‚Äî</div>
            <div>Precio por d√≠a</div><div class="text-right font-semibold" id="sumPPD">‚Äî</div>
            <div>Total estimado</div><div class="text-right font-bold text-slate-900" id="sumTotal">‚Äî</div>
          </div>

          <div class="text-xs text-slate-500">* El precio final se confirma al crear la solicitud.</div>
        </div>

        <div class="px-5 py-4 border-t flex gap-3 justify-end">
          <button type="button" class="px-4 py-2 rounded-lg border hover:bg-slate-50" data-close="true">Cancelar</button>
          <button id="btnConfirmar" type="button" class="px-4 py-2 rounded-lg bg-brand-600 text-white hover:bg-brand-700" disabled>Agregar al carrito</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========= DETALLE =========
    const ART_ID_SERVER = "{{ articulo_id }}";
    const fmt = n => Number(n||0).toLocaleString('es-CO');
    const ownerBox = document.getElementById('owner');
    let ARTICULO_CACHE = null;

    function getIdFromPath(){
      const parts = location.pathname.split('/').filter(Boolean);
      return parts[1] || "";
    }

    // ----- Obtener art√≠culo por id/slug -----
    async function fetchByIdOrSlug(idOrSlug){
      const direct = await fetch(`/api/articulos/${encodeURIComponent(idOrSlug)}/`);
      if (direct.ok) return direct.json();

      const q = await fetch(`/api/articulos/?slug=${encodeURIComponent(idOrSlug)}`);
      if (q.ok){
        const arr = await q.json();
        if (Array.isArray(arr) && arr.length) return arr[0];
      }

      const s = await fetch(`/api/articulos/?search=${encodeURIComponent(idOrSlug)}&ordering=-creado`);
      if (s.ok){
        const arr = await s.json();
        if (Array.isArray(arr) && arr.length) return arr[0];
      }
      throw new Error('Articulo no encontrado');
    }

    // ----- UI propietario -----
    function avatarHtml(nameLike){
      const txt = (nameLike || '').trim();
      const ini = txt ? txt[0].toUpperCase() : 'üë§';
      return `<div class="h-12 w-12 rounded-full bg-brand-100 text-brand-700 grid place-items-center text-lg font-bold">${ini}</div>`;
    }

    function renderOwner(a){
      const info = a.propietario_info || {};
      const pObj = typeof a.propietario === 'object' ? a.propietario : {};
      const nombre =
        info.nombre || a.propietario_nombre || pObj.nombre || pObj.full_name || pObj.username || a.dueno_nombre || '';
      const email  = info.email || pObj.email || a.propietario_email || '';
      const tel    = info.telefono || pObj.telefono || pObj.phone || a.propietario_telefono || '';
      const ubi    = info.ubicacion || a.ubicacion_prop || '';

      ownerBox.innerHTML = `
        <div class="flex items-center gap-4 w-full">
          ${avatarHtml(nombre || email || a.propietario)}
          <div class="min-w-0">
            <div class="font-semibold">${ nombre || 'Propietario' }</div>
            <div class="text-sm text-slate-500 break-all">
              ${ ubi ? `<span class="inline-block mr-1.5 px-1.5 py-0.5 rounded bg-slate-100">${ubi}</span>` : '' }
              ${ email ? `<a class="hover:underline" href="mailto:${email}">${email}</a>` : '' }
              ${ email && tel ? ' ‚Ä¢ ' : '' }
              ${ tel ? `<a class="hover:underline" href="tel:${tel}">${tel}</a>` : '' }
              ${ (!email && !tel && a.propietario) ? `<span class="text-slate-400">${a.propietario}</span>` : '' }
            </div>
          </div>
        </div>`;
    }

    // ----- Render detalle -----
    function renderArticulo(a){
      document.getElementById('title').textContent = a.titulo || 'Art√≠culo';
      const ubi = a.ubicacion || '';
      const price = a.precio_por_dia ? `$${fmt(a.precio_por_dia)}/d√≠a` : '';
      document.getElementById('ubiprice').textContent = [ubi, price].filter(Boolean).join(' ‚Ä¢ ') || '‚Äî';

      const pricePill = document.getElementById('pricePill');
      if (price){ pricePill.textContent = price; pricePill.classList.remove('hidden'); }

      document.getElementById('desc').textContent = a.descripcion || 'Sin descripci√≥n.';
      renderOwner(a);

      // Galer√≠a
      const main = document.getElementById('galleryMain');
      const thumbs = document.getElementById('thumbs');
      const imagenes = [];
      if (a.portada) imagenes.push(a.portada);
      if (Array.isArray(a.imagenes)){
        a.imagenes.forEach(img => {
          const url = (img && (img.url || img.imagen || img.file)) || img;
          if (url) imagenes.push(url);
        });
      }
      if (imagenes.length){
        main.innerHTML = `<img src="${imagenes[0]}" class="w-full h-full object-cover rounded-xl smooth" alt="${a.titulo || 'Art√≠culo'}">`;
        thumbs.innerHTML = imagenes.map((u,i)=>`
          <button type="button" class="thumb h-16 w-24 rounded-lg overflow-hidden border smooth" data-i="${i}" ${i===0?'data-active="true"':''}>
            <img src="${u}" class="w-full h-full object-cover" alt="Miniatura ${i+1}">
          </button>
        `).join('');
        thumbs.addEventListener('click', e=>{
          const b = e.target.closest('button.thumb'); if (!b) return;
          const idx = +b.dataset.i;
          main.innerHTML = `<img src="${imagenes[idx]}" class="w-full h-full object-cover rounded-xl smooth" alt="${a.titulo || 'Art√≠culo'}">`;
          thumbs.querySelectorAll('button.thumb').forEach(x=>x.removeAttribute('data-active'));
          b.setAttribute('data-active','true');
        });
      } else {
        main.innerHTML = `<div class="w-full h-full rounded-xl bg-slate-100"></div>`;
        thumbs.innerHTML = '';
      }

      const reservarBtn = document.getElementById('reservarBtn');
      const artRef = a.id || ART_ID_SERVER;
      document.getElementById('contactarBtn').href = `/chat/?art=${encodeURIComponent(artRef)}`;

      reservarBtn.removeAttribute('href');
      reservarBtn.addEventListener('click', (e) => {
        e.preventDefault();
        openReservaModal(a);
      });
    }

    async function loadArticulo(){
      const fromContext = ART_ID_SERVER && ART_ID_SERVER !== "None" ? ART_ID_SERVER : "";
      const candidate = fromContext || getIdFromPath();
      try{
        const articulo = await fetchByIdOrSlug(candidate);
        window.__ARTICULO__ = articulo;
        ARTICULO_CACHE = articulo;
        renderArticulo(articulo);
      }catch(err){
        document.getElementById('title').textContent = 'Art√≠culo no encontrado';
        document.getElementById('desc').textContent = 'No pudimos cargar la informaci√≥n del art√≠culo.';
        console.error(err);
      }
    }

    // Compartir
    document.getElementById('shareBtn')?.addEventListener('click', async ()=>{
      const url = location.href;
      try{
        if (navigator.share){
          await navigator.share({ title: document.title, url });
        } else {
          await navigator.clipboard.writeText(url);
          const btn = document.getElementById('shareBtn');
          const old = btn.textContent;
          btn.textContent = 'Enlace copiado';
          setTimeout(()=>btn.textContent = old, 1400);
        }
      }catch(_){}
    });

    // ===== Helpers reserva / dinero =====
    function daysBetween(d1, d2){
      const ms = (d2 - d1);
      const days = Math.floor(ms / (1000*60*60*24)) + 1;
      return Math.max(days, 1);
    }
    function toISODateStr(date){ // Date -> 'YYYY-MM-DD'
      const y = date.getFullYear();
      const m = String(date.getMonth()+1).padStart(2,'0');
      const d = String(date.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }
    function parseDMY(s){ // 'dd/mm/aaaa' -> Date
      const [d,m,y] = s.split('/').map(Number);
      const dt = new Date(Date.UTC(y,(m-1),d));
      return isNaN(dt) ? null : dt;
    }
    function formatCOP(n){
      return Number(n||0).toLocaleString('es-CO', {style:'currency', currency:'COP', maximumFractionDigits:0});
    }
    function setDispMessage(ok, text){
      const el = document.getElementById('dispMsg');
      el.textContent = text || '';
      el.className = "text-sm " + (ok ? "text-emerald-600" : "text-red-600");
    }

    // ===== JWT helpers + authFetch =====
    const TOKEN_KEY = 'access';
    const REFRESH_KEY = 'refresh';

    function getToken() { return localStorage.getItem(TOKEN_KEY) || null; }
    function getRefresh() { return localStorage.getItem(REFRESH_KEY) || null; }
    function setTokens({ access, refresh }) {
      if (access) localStorage.setItem(TOKEN_KEY, access);
      if (refresh) localStorage.setItem(REFRESH_KEY, refresh);
    }
    async function refreshAccessToken() {
      const refresh = getRefresh();
      if (!refresh) return null;
      const r = await fetch('/api/token/refresh/', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ refresh })
      });
      if (!r.ok) return null;
      const data = await r.json();
      if (data.access) { setTokens({ access: data.access }); return data.access; }
      return null;
    }
    async function authFetch(url, options = {}) {
      const token = getToken();
      if (!token) {
        location.href = `/login/?next=${encodeURIComponent(location.pathname)}`;
        throw new Error('No autenticado');
      }
      const headers = new Headers(options.headers || {});
      headers.set('Authorization', `Bearer ${token}`);
      if (options.body && !headers.has('Content-Type')) headers.set('Content-Type', 'application/json');
      let resp = await fetch(url, { ...options, headers });
      if (resp.status === 401) {
        const newAccess = await refreshAccessToken();
        if (!newAccess) return resp;
        headers.set('Authorization', `Bearer ${newAccess}`);
        resp = await fetch(url, { ...options, headers });
      }
      return resp;
    }

    // ==== Carrito API (sin panel) ====
    function requireLoginOrRedirect(){
      const t = getToken();
      if (!t) { location.href = `/login/?next=${encodeURIComponent('/carrito/')}`; return false; }
      return true;
    }
    async function apiGetCart(){
      const r = await authFetch('/api/carrito/');
      if (!r.ok) throw new Error('No se pudo cargar el carrito');
      return r.json();
    }
    async function apiAddToCart(item){
      const r = await authFetch('/api/carrito/', { method:'POST', body: JSON.stringify(item) });
      if (!r.ok){
        const d = await r.json().catch(()=> ({}));
        throw new Error(d.detail || d.non_field_errors?.[0] || 'No se pudo agregar al carrito');
      }
      return r.json();
    }

    // ==== Navbar carrito & checkout ====
    const cartBtn = document.getElementById('cartBtn');
    const cartBadge = document.getElementById('cartBadge');
    const checkoutBtn = document.getElementById('checkoutBtn');

    cartBtn?.addEventListener('click', ()=>{
      if (!getToken()) location.href = '/login/?next=/carrito/';
      else location.href = '/carrito/';
    });
    checkoutBtn?.addEventListener('click', ()=>{
      if (!getToken()) location.href = '/login/?next=/checkout/';
      else location.href = '/checkout/';
    });

    (async ()=>{
      if (!getToken()) { cartBadge?.classList.add('hidden'); checkoutBtn?.classList.add('hidden'); return; }
      try{
        const items = await apiGetCart();
        const hasItems = Array.isArray(items) && items.length > 0;
        cartBadge.classList.toggle('hidden', !hasItems);
        cartBadge.textContent = hasItems ? items.length : 0;
        checkoutBtn.classList.toggle('hidden', !hasItems);
      }catch(_){
        checkoutBtn?.classList.add('hidden');
      }
    })();

    // ====== Disponibilidad + Datepicker PRO (Flatpickr) ======
    // Cache { 'YYYY-MM' : Set(['YYYY-MM-DD', ...]) }
    const MONTH_CACHE = new Map();

    async function fetchDisponibilidadMes(artId, year, month01){
      const key = `${year}-${String(month01).padStart(2,'0')}`;
      if (MONTH_CACHE.has(key)) return MONTH_CACHE.get(key);

      // rango del mes
      const from = `${key}-01`;
      const lastDay = new Date(year, month01, 0).getDate(); // month01 es 1..12
      const to = `${key}-${String(lastDay).padStart(2,'0')}`;

      const url = `/api/alquileres/disponibilidad/?articulo=${encodeURIComponent(artId)}&from=${from}&to=${to}`;
      const r = await fetch(url);
      if (!r.ok) { MONTH_CACHE.set(key, new Set()); return MONTH_CACHE.get(key); }
      const data = await r.json();
      const set = new Set(Array.isArray(data.dias_ocupados) ? data.dias_ocupados : []);
      MONTH_CACHE.set(key, set);
      return set;
    }

    // Devuelve true si la fecha est√° ocupada seg√∫n cach√©
    function isUnavailable(date){
      const y = date.getFullYear();
      const m = String(date.getMonth()+1).padStart(2,'0');
      const key = `${y}-${m}`;
      const set = MONTH_CACHE.get(key);
      if (!set) return false;
      return set.has(toISODateStr(date));
    }

    function setupDatepicker(art){
      const inputStart = document.getElementById('fInicio');
      const inputEnd   = document.getElementById('fFin');
      const btnConfirm = document.getElementById('btnConfirmar');

      // Resetea valores
      inputStart.value = '';
      inputEnd.value = '';
      btnConfirm.disabled = true;

      // funci√≥n disable din√°mica
      const disableFn = (date)=> isUnavailable(date);

      // Carga mes visible (actual) y siguiente para UX fluida
      async function primeMonths(instance){
        const y = instance.currentYear;
        const m = instance.currentMonth + 1; // 1..12
        await Promise.all([
          fetchDisponibilidadMes(art.id || ART_ID_SERVER, y, m),
          fetchDisponibilidadMes(art.id || ART_ID_SERVER, m===12?y+1:y, m===12?1:m+1),
        ]);
        instance.redraw(); // repinta para aplicar clases
      }

      // Marca los d√≠as rojos en el render
      function onDayCreate(dObj, dStr, fp, dayElem){
        const dt = dayElem.dateObj;
        if (isUnavailable(dt)) dayElem.classList.add('tl-unavailable');
      }

      // Validaci√≥n del rango seleccionado
      function validateRange(fp){
        const s = inputStart.value, e = inputEnd.value;
        if (!s || !e){ setDispMessage(true, 'Selecciona un rango de fechas'); btnConfirm.disabled = true; return; }
        const d1 = parseDMY(s), d2 = parseDMY(e);
        if (!d1 || !d2 || d2 < d1){ setDispMessage(false, 'Rango inv√°lido'); btnConfirm.disabled = true; return; }

        // si alg√∫n d√≠a del rango est√° ocupado ‚Üí error
        let clash = false;
        for (let dt = new Date(d1); dt <= d2; dt.setUTCDate(dt.getUTCDate()+1)){
          if (isUnavailable(new Date(dt))) { clash = true; break; }
        }
        if (clash){ setDispMessage(false, 'El rango contiene d√≠as no disponibles'); btnConfirm.disabled = true; return; }

        // OK: calcula totales
        setDispMessage(true, 'Fechas disponibles');
        const dias = daysBetween(new Date(d1), new Date(d2));
        document.getElementById('sumDias').textContent = dias;
        document.getElementById('sumPPD').textContent = formatCOP(art.precio_por_dia);
        document.getElementById('sumTotal').textContent = formatCOP(dias * (art.precio_por_dia || 0));
        btnConfirm.disabled = false;
      }

      // Inicializa flatpickr en espa√±ol con 2 inputs (rangePlugin)
      const fp = flatpickr(inputStart, {
        altInput: false,
        dateFormat: "d/m/Y",
        locale: flatpickr.l10ns.es,
        minDate: "today",
        plugins: [new rangePlugin({ input: inputEnd })],
        disable: [disableFn],               // bloquea selecci√≥n en d√≠as ocupados
        onOpen: [primeMonths],
        onMonthChange: [primeMonths],
        onYearChange: [primeMonths],
        onDayCreate: [onDayCreate],
        onChange: function(){ validateRange(this); }
      });

      // Primera precarga (mes actual)
      primeMonths(fp);
    }

    // ====== Modal: abrir, wire & confirmar ======
    async function checkDisponibilidad(artId, d1, d2){
      const from = toISODateStr(d1);
      const to   = toISODateStr(d2);
      const url = `/api/alquileres/disponibilidad/?articulo=${encodeURIComponent(artId)}&from=${from}&to=${to}`;
      const r = await fetch(url);
      if (!r.ok) throw new Error('No se pudo consultar disponibilidad');
      return r.json();
    }

    function openReservaModal(art){
      const modal = document.getElementById('reservaModal');
      modal.classList.remove('hidden');

      document.getElementById('mArtTitle').textContent = art.titulo || 'Art√≠culo';
      document.getElementById('sumPPD').textContent = formatCOP(art.precio_por_dia);
      document.getElementById('sumDias').textContent = '‚Äî';
      document.getElementById('sumTotal').textContent = '‚Äî';
      setDispMessage(true, 'Selecciona un rango de fechas');

      // Monta el datepicker PRO
      setupDatepicker(art);

      // confirmar => agregar al carrito y redirigir a /carrito/
      document.getElementById('btnConfirmar').onclick = async () => {
        const s = document.getElementById('fInicio').value;
        const e = document.getElementById('fFin').value;
        const d1 = parseDMY(s), d2 = parseDMY(e);
        if (!d1 || !d2) { setDispMessage(false, 'Selecciona inicio y fin'); return; }
        if (!requireLoginOrRedirect()) return;

        try{
          // Revalida contra API el rango final
          const info = await checkDisponibilidad(art.id || ART_ID_SERVER, d1, d2);
          const ocupados = new Set(info.dias_ocupados || []);
          for (let dt = new Date(d1); dt <= d2; dt.setUTCDate(dt.getUTCDate()+1)){
            if (ocupados.has(toISODateStr(new Date(dt)))) throw new Error('Fechas no disponibles');
          }

          const payload = {
            articulo: art.id || ART_ID_SERVER,
            // backend espera YYYY-MM-DD
            fecha_inicio: toISODateStr(d1),
            fecha_fin: toISODateStr(d2)
          };
          await apiAddToCart(payload);

          // Actualiza badge y muestra bot√≥n de checkout
          try{
            const items = await apiGetCart();
            const hasItems = Array.isArray(items) && items.length > 0;
            cartBadge.classList.toggle('hidden', !hasItems);
            cartBadge.textContent = hasItems ? items.length : 0;
            checkoutBtn.classList.toggle('hidden', !hasItems);
          }catch(_){}

          location.href = '/carrito/';
        }catch(err){ setDispMessage(false, err.message || 'No se pudo agregar'); }
      };

      // cerrar modal
      const closeHandler = (e) => {
        if (e.target.matches('[data-close], [data-close] * , .bg-black\\/30')) {
          modal.classList.add('hidden');
          modal.removeEventListener('click', closeHandler);
        }
      };
      modal.addEventListener('click', closeHandler);
    }

    loadArticulo();
  </script>
</body>
</html>
