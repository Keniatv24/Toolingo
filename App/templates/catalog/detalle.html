{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Detalle del art√≠culo ‚Äì Toolingo</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { brand: {50:'#fff7ed',100:'#ffedd5',600:'#f97316',700:'#c2410c'} },
          boxShadow: { soft:'0 10px 30px rgba(15,23,42,.06)', lift:'0 16px 44px rgba(15,23,42,.12)' }
        }
      }
    }
  </script>

  <!-- Flatpickr opcional (si quieres usarlo) -->
  <link href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n/es.js"></script>

  <style>
    .thumb:is(button)[data-active="true"]{ outline: 2px solid #f97316; outline-offset: 0; }
    .smooth { transition: all .25s cubic-bezier(.22,.61,.36,1); }
    .chat-overlay-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.35); display:none; z-index: 9998; }
    .chat-overlay {
      position: fixed; right: 32px; bottom: 32px;
      width: min(900px, 92vw); height: min(720px, 90vh);
      background: #fff; border-radius: 16px; box-shadow: 0 24px 72px rgba(0,0,0,.28);
      overflow: hidden; display:none; z-index: 9999;
    }
    .chat-overlay header { height: 48px; display:flex; align-items:center; justify-content:space-between; padding: 0 12px; background:#0f172a; color:#fff; font-weight:600; }
    .chat-overlay header button { background: transparent; border:0; color:#fff; font-size:20px; cursor:pointer; }
    .chat-overlay iframe { width:100%; height: calc(100% - 48px); border:0; }
    @media (max-width: 640px){
      .chat-overlay { left: 0; right: 0; top: 0; bottom: 0; width: 100vw; height: 100vh; border-radius: 0; }
      .chat-overlay iframe { height: calc(100% - 48px); }
    }
  </style>
</head>
<body class="text-slate-800 bg-white">

  <!-- NAVBAR -->
  <header class="sticky top-0 z-50 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-6">
      <a href="/" class="flex items-center gap-2">
        <svg width="26" height="26" viewBox="0 0 24 24" class="text-brand-600 fill-current">
          <path d="M21 7.5a5.5 5.5 0 0 1-7.53 5.09l-6.44 6.44a1.5 1.5 0 0 1-2.12-2.12l6.44-6.44A5.5 5.5 0 1 1 21 7.5Z"/>
        </svg>
        <span class="text-lg font-extrabold">Toolingo</span>
      </a>
      <nav class="hidden md:flex ml-auto items-center gap-6 text-sm">
        <a href="/" class="hover:text-brand-600">Inicio</a>
        <a href="/catalogo/" class="font-semibold text-brand-700">Productos</a>
        <a href="/publicar/" class="font-semibold hover:text-brand-600">Publicar</a>

        <!-- Carrito -->
        <button id="cartBtn" class="relative p-2 rounded-lg hover:bg-slate-100" title="Carrito">üõí
          <span id="cartBadge" class="absolute -top-1 -right-1 text-[11px] px-1.5 py-0.5 rounded-full bg-brand-600 text-white hidden">0</span>
        </button>
      </nav>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-6xl mx-auto px-4 py-8">
    <a href="/catalogo/" class="inline-flex items-center gap-2 text-sm text-brand-700 hover:underline">
      <span aria-hidden="true">‚Üê</span> Volver al cat√°logo
    </a>

    <div class="mt-4 grid lg:grid-cols-12 gap-8">
      <!-- GALER√çA -->
      <section class="lg:col-span-6">
        <div class="rounded-2xl border bg-white p-3 shadow-soft">
          <div id="galleryMain" class="aspect-[16/10] rounded-xl bg-slate-100 overflow-hidden smooth"></div>
        </div>
        <div id="thumbs" class="mt-3 flex gap-3 overflow-x-auto py-1"></div>
      </section>

      <!-- DATOS -->
      <section class="lg:col-span-6">
        <div class="flex items-start flex-wrap gap-3">
          <h1 id="title" class="text-3xl md:text-4xl font-extrabold tracking-tight">Cargando‚Ä¶</h1>
          <div id="pricePill" class="ml-auto inline-flex items-center gap-2 px-3 py-1 rounded-full bg-brand-50 text-brand-700 text-sm font-semibold hidden"></div>
        </div>
        <p id="ubiprice" class="mt-2 text-slate-600"></p>

        <!-- Descripci√≥n -->
        <div class="mt-4 p-5 rounded-2xl border bg-white shadow-soft">
          <div class="flex items-center gap-2 mb-2">
            <span class="inline-block h-2 w-2 rounded-full bg-brand-600"></span>
            <h2 class="font-semibold">Descripci√≥n</h2>
          </div>
          <p id="desc" class="text-slate-700 leading-relaxed">Cargando‚Ä¶</p>
        </div>

        <!-- Propietario -->
        <div class="mt-4 p-5 rounded-2xl border bg-white shadow-soft">
          <div class="flex items-center gap-2 mb-3">
            <span class="inline-block h-2 w-2 rounded-full bg-brand-600"></span>
            <h2 class="font-semibold">Propietario</h2>
          </div>
          <div id="owner" class="flex items-center gap-4"></div>
        </div>

        <!-- Acciones -->
        <div class="mt-6 flex flex-wrap gap-3 items-center">
          <a id="reservarBtn" href="#" class="px-5 py-3 rounded-xl bg-brand-600 text-white hover:bg-brand-700 smooth shadow-soft hover:shadow-lift">Reservar</a>
          <button id="btnContactar" type="button" class="px-4 py-3 rounded-xl border hover:bg-slate-50 smooth">Contactar</button>
          <button id="shareBtn" type="button" class="px-4 py-3 rounded-xl border hover:bg-slate-50 smooth">Compartir</button>
          <button id="checkoutBtn" type="button" class="px-5 py-3 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 smooth ml-auto hidden">Continuar compra</button>
        </div>
      </section>
    </div>
  </main>

  <footer class="py-10 text-center text-sm text-slate-500">¬© <span id="y"></span> Toolingo</footer>
  <script>document.getElementById('y').textContent = new Date().getFullYear()</script>

  <!-- ===== Modal Reserva ===== -->
  <div id="reservaModal" class="fixed inset-0 z-[60] hidden">
    <div class="absolute inset-0 bg-black/30" data-close="true"></div>
    <div class="absolute inset-0 grid place-items-center p-4">
      <div class="w-full max-w-lg rounded-2xl bg-white shadow-lift border">
        <div class="px-5 py-4 border-b flex items-center justify-between">
          <h3 class="text-lg font-semibold">Reservar <span id="mArtTitle" class="font-bold"></span></h3>
          <button type="button" class="p-2 rounded hover:bg-slate-100" data-close="true">‚úï</button>
        </div>

        <div class="p-5 grid gap-4">
          <div class="grid sm:grid-cols-2 gap-4">
            <label class="grid gap-1">
              <span class="text-sm text-slate-600">Fecha inicio</span>
              <input id="fInicio" type="text" class="border rounded-lg px-3 py-2" placeholder="dd/mm/aaaa">
            </label>
            <label class="grid gap-1">
              <span class="text-sm text-slate-600">Fecha fin</span>
              <input id="fFin" type="text" class="border rounded-lg px-3 py-2" placeholder="dd/mm/aaaa">
            </label>
          </div>

          <div id="dispMsg" class="text-sm text-emerald-700 hidden">Fechas disponibles ‚úì</div>
          <div id="dispBad" class="text-sm text-red-600 hidden">No disponible</div>

          <div class="rounded-xl bg-slate-50 p-4 grid grid-cols-2 gap-3 text-sm">
            <div>D√≠as</div><div class="text-right font-semibold" id="sumDias">‚Äî</div>
            <div>Precio por d√≠a</div><div class="text-right font-semibold" id="sumPPD">‚Äî</div>
            <div>Total estimado</div><div class="text-right font-bold text-slate-900" id="sumTotal">‚Äî</div>
          </div>

          <div class="text-xs text-slate-500">* El precio final se confirma al crear la solicitud.</div>
        </div>

        <div class="px-5 py-4 border-t flex gap-3 justify-end">
          <button type="button" class="px-4 py-2 rounded-lg border hover:bg-slate-50" data-close="true">Cancelar</button>
          <button id="btnConfirmar" type="button" class="px-4 py-2 rounded-lg bg-brand-600 text-white hover:bg-brand-700" disabled>Agregar al carrito</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Chat Overlay ===== -->
  <div id="chatBackdrop" class="chat-overlay-backdrop"></div>
  <div id="chatOverlay" class="chat-overlay" role="dialog" aria-modal="true" aria-label="Chat">
    <header>
      <span>Chat</span>
      <button id="chatClose" title="Cerrar">‚úï</button>
    </header>
    <iframe id="chatFrame" src="" loading="lazy"></iframe>
  </div>

  <script>
    /* ===== Utils ===== */
    const ART_ID_SERVER = "{{ articulo_id }}";  // si tu vista pasa articulo_id
    const ownerBox = document.getElementById('owner');
    const fmtCOP = n => Number(n||0).toLocaleString('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0});
    const fmt = n => Number(n||0).toLocaleString('es-CO');

    // JWT helpers
    const TOKEN_KEY='access', REFRESH_KEY='refresh';
    const getToken = ()=> localStorage.getItem(TOKEN_KEY) || null;
    const getRefresh = ()=> localStorage.getItem(REFRESH_KEY) || null;
    const setTokens = ({access,refresh})=>{ if(access) localStorage.setItem(TOKEN_KEY,access); if(refresh) localStorage.setItem(REFRESH_KEY,refresh); };
    async function refreshAccessToken(){ const r=getRefresh(); if(!r) return null; const resp=await fetch('/api/token/refresh/',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({refresh:r})}); if(!resp.ok) return null; const d=await resp.json(); if(d.access){ setTokens({access:d.access}); return d.access; } return null; }
    async function authFetch(url,opt={}){ const t=getToken(); if(!t){ location.href=`/login/?next=${encodeURIComponent(location.pathname)}`; throw new Error('No autenticado'); } const h=new Headers(opt.headers||{}); h.set('Authorization',`Bearer ${t}`); if(opt.body && !h.has('Content-Type')) h.set('Content-Type','application/json'); let resp=await fetch(url,{...opt,headers:h}); if(resp.status===401){ const na=await refreshAccessToken(); if(na){ h.set('Authorization',`Bearer ${na}`); resp=await fetch(url,{...opt,headers:h}); } } return resp; }

    // Navegaci√≥n carrito
    const cartBtn=document.getElementById('cartBtn');
    const cartBadge=document.getElementById('cartBadge');
    cartBtn?.addEventListener('click',()=>{ if(!getToken()) location.href='/login/?next=/carrito/'; else location.href='/carrito/'; });

    async function refreshCartBadge(){
      try{
        const r = await authFetch('/api/carrito/');
        if(!r.ok) return;
        const items = await r.json();
        cartBadge?.classList.toggle('hidden', !(items?.length));
        if (items?.length) cartBadge.textContent = items.length;
      }catch(_){}
    }

    // Avatar HTML
    function avatarHtml(nameLike){ const txt=(nameLike||'').trim(); const ini=txt?txt[0].toUpperCase():'üë§'; return `<div class="h-12 w-12 rounded-full bg-brand-100 text-brand-700 grid place-items-center text-lg font-bold">${ini}</div>`; }

    // Fetch por ID o slug
    async function fetchByIdOrSlug(idOrSlug){
      const direct = await fetch(`/api/articulos/${encodeURIComponent(idOrSlug)}/`); if (direct.ok) return direct.json();
      const q = await fetch(`/api/articulos/?slug=${encodeURIComponent(idOrSlug)}`); if (q.ok){ const arr = await q.json(); if (Array.isArray(arr) && arr.length) return arr[0]; }
      const s = await fetch(`/api/articulos/?search=${encodeURIComponent(idOrSlug)}&ordering=-creado`); if (s.ok){ const arr = await s.json(); if (Array.isArray(arr) && arr.length) return arr[0]; }
      throw new Error('Articulo no encontrado');
    }

    function renderOwner(a){
      const info=a.propietario_info||{}; const pObj=typeof a.propietario==='object'?a.propietario:{}; 
      const nombre=info.nombre || a.propietario_nombre || pObj.nombre || pObj.full_name || pObj.username || a.dueno_nombre || '';
      const email=info.email || pObj.email || a.propietario_email || '';
      const tel=info.telefono || pObj.telefono || pObj.phone || a.propietario_telefono || '';
      const ubi=info.ubicacion || a.ubicacion_prop || '';
      ownerBox.innerHTML=`
        <div class="flex items-center gap-4 w-full">
          ${avatarHtml(nombre || email || a.propietario)}
          <div class="min-w-0">
            <div class="font-semibold">${ nombre || 'Propietario' }</div>
            <div class="text-sm text-slate-500 break-all">
              ${ ubi ? `<span class="inline-block mr-1.5 px-1.5 py-0.5 rounded bg-slate-100">${ubi}</span>` : '' }
              ${ email ? `<a class="hover:underline" href="mailto:${email}">${email}</a>` : '' }
              ${ email && tel ? ' ‚Ä¢ ' : '' }
              ${ tel ? `<a class="hover:underline" href="tel:${tel}">${tel}</a>` : '' }
              ${ (!email && !tel && a.propietario) ? `<span class="text-slate-400">${a.propietario}</span>` : '' }
            </div>
          </div>
        </div>`;
    }

    function renderArticulo(a){
      document.getElementById('title').textContent = a.titulo || 'Art√≠culo';
      const ubi=a.ubicacion || ''; const price=a.precio_por_dia ? `$${fmt(a.precio_por_dia)}/d√≠a` : '';
      document.getElementById('ubiprice').textContent = [ubi, price].filter(Boolean).join(' ‚Ä¢ ') || '‚Äî';
      const pricePill=document.getElementById('pricePill'); if(price){ pricePill.textContent=price; pricePill.classList.remove('hidden'); }
      document.getElementById('desc').textContent = a.descripcion || 'Sin descripci√≥n.'; 
      renderOwner(a);

      // Galer√≠a
      const main=document.getElementById('galleryMain'); const thumbs=document.getElementById('thumbs'); const imgs=[];
      if (a.portada) imgs.push(a.portada);
      if (Array.isArray(a.imagenes)) a.imagenes.forEach(img=>{ const u=(img&&(img.url||img.imagen||img.file))||img; if(u) imgs.push(u); });
      if (imgs.length){
        main.innerHTML=`<img src="${imgs[0]}" class="w-full h-full object-cover rounded-xl smooth" alt="${a.titulo || 'Art√≠culo'}">`;
        thumbs.innerHTML=imgs.map((u,i)=>`<button type="button" class="thumb h-16 w-24 rounded-lg overflow-hidden border smooth" data-i="${i}" ${i===0?'data-active="true"':''}><img src="${u}" class="w-full h-full object-cover" alt="Miniatura ${i+1}"></button>`).join('');
        thumbs.addEventListener('click',e=>{ const b=e.target.closest('button.thumb'); if(!b) return; const idx=+b.dataset.i; main.innerHTML=`<img src="${imgs[idx]}" class="w-full h-full object-cover rounded-xl smooth" alt="${a.titulo || 'Art√≠culo'}">`; thumbs.querySelectorAll('button.thumb').forEach(x=>x.removeAttribute('data-active')); b.setAttribute('data-active','true'); });
      } else { main.innerHTML=`<div class="w-full h-full rounded-xl bg-slate-100"></div>`; thumbs.innerHTML=''; }

      // Botones
      document.getElementById('reservarBtn').addEventListener('click',(e)=>{ e.preventDefault(); openReservaModal(a); });
      document.getElementById('btnContactar').addEventListener('click', ()=> openChatOverlay(a.id || ART_ID_SERVER));
    }

    async function loadArticulo(){
      const candidate = (ART_ID_SERVER && ART_ID_SERVER !== "None") ? ART_ID_SERVER : location.pathname.split('/').filter(Boolean)[1] || "";
      try{ const articulo = await fetchByIdOrSlug(candidate); window.__ARTICULO__=articulo; renderArticulo(articulo); }
      catch(err){ document.getElementById('title').textContent='Art√≠culo no encontrado'; document.getElementById('desc').textContent='No pudimos cargar la informaci√≥n del art√≠culo.'; console.error(err); }
    }

    // ====== Reserva (c√°lculos + POST carrito) ======
    const fInicio = ()=> document.getElementById('fInicio');
    const fFin = ()=> document.getElementById('fFin');
    const sumDias = document.getElementById('sumDias');
    const sumPPD  = document.getElementById('sumPPD');
    const sumTotal= document.getElementById('sumTotal');
    const dispMsg = document.getElementById('dispMsg');
    const dispBad = document.getElementById('dispBad');

    function esToIsoDate(s){
      if(!s) return '';
      if(s.includes('-')) return s.trim();
      const [dd,mm,yy]=s.split('/').map(x=>x.trim());
      if(!dd||!mm||!yy) return '';
      return `${yy.padStart(4,'0')}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}`;
    }

    function diffDays(isoStart, isoEnd){
      try{
        const a = new Date(isoStart+'T00:00:00');
        const b = new Date(isoEnd+'T00:00:00');
        const ms = b - a;
        const d = Math.round(ms/86400000);
        return d>0 ? d : 0;
      }catch{ return 0; }
    }

    function recalcSummary(a){
      const iniISO = esToIsoDate(fInicio().value);
      const finISO = esToIsoDate(fFin().value);

      const dias = diffDays(iniISO, finISO);
      const ppd = Number(a.precio_por_dia || 0);
      const total = dias * ppd;

      sumDias.textContent = dias || '‚Äî';
      sumPPD.textContent  = ppd ? fmtCOP(ppd) : '‚Äî';
      sumTotal.textContent= total ? fmtCOP(total) : '‚Äî';

      // Sem√°foro simple (puedes conectar tu disponibilidad real)
      const ok = dias>0;
      dispMsg.classList.toggle('hidden', !ok);
      dispBad.classList.toggle('hidden', ok);

      document.getElementById('btnConfirmar').disabled = !ok;
    }

    function wireAddToCart(a){
      const btn = document.getElementById('btnConfirmar');
      btn.onclick = async () => {
        const isoIni = esToIsoDate(fInicio().value);
        const isoFin = esToIsoDate(fFin().value);
        if(!isoIni || !isoFin){ alert('Elige fechas v√°lidas.'); return; }

        const payload = {
          articulo: a.id || a.pk || a.uuid || a,   // ajusta si tu API usa otro nombre
          fecha_inicio: isoIni,
          fecha_fin: isoFin,
        };

        try{
          const r = await authFetch('/api/carrito/', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });

          if(!r.ok){
            let msg = 'No se pudo agregar al carrito.';
            try{
              const err = await r.json();
              msg = err?.detail || err?.error || JSON.stringify(err);
            }catch{
              try{ msg = await r.text(); }catch{}
            }
            alert(msg);
            return;
          }

          await refreshCartBadge();
          document.getElementById('reservaModal')?.classList.add('hidden');
          if(confirm('‚úÖ ¬°Agregado! ¬øIr al carrito ahora?')) location.href='/carrito/';
        }catch(e){
          console.error(e);
          alert('Error de red al agregar al carrito.');
        }
      };
    }

    function openReservaModal(a){
      document.getElementById('mArtTitle').textContent = a.titulo || 'Art√≠culo';
      document.getElementById('reservaModal').classList.remove('hidden');

      // Flatpickr sencillo en formato dd/mm/aaaa
      if(window.flatpickr){
        flatpickr(fInicio(), {dateFormat:'d/m/Y', locale:'es'});
        flatpickr(fFin(),    {dateFormat:'d/m/Y', locale:'es'});
      }

      // listeners de rec√°lculo
      [fInicio(), fFin()].forEach(el=> el.addEventListener('input', ()=> recalcSummary(a)));
      recalcSummary(a);

      // conectar bot√≥n agregar
      wireAddToCart(a);
    }

    document.querySelectorAll('#reservaModal [data-close="true"]').forEach(el=>{
      el.addEventListener('click', ()=> document.getElementById('reservaModal').classList.add('hidden'));
    });

    // ====== Chat Overlay ======
    function openChatOverlay(articleId){
      if (!getToken()) { window.location.href=`/login/?next=${encodeURIComponent(location.pathname)}`; return; }
      const frame=document.getElementById('chatFrame');
      const bust = Date.now();
      frame.src=`/chat/?embed=1&article=${encodeURIComponent(articleId)}&intent=contact&v=${bust}`;
      document.getElementById('chatBackdrop').style.display='block';
      document.getElementById('chatOverlay').style.display='block';
    }
    document.getElementById('chatClose').onclick = () => {
      document.getElementById('chatOverlay').style.display='none';
      document.getElementById('chatBackdrop').style.display='none';
      document.getElementById('chatFrame').src='about:blank';
    };
    document.getElementById('chatBackdrop').onclick = () => {
      document.getElementById('chatOverlay').style.display='none';
      document.getElementById('chatBackdrop').style.display='none';
      document.getElementById('chatFrame').src='about:blank';
    };

    /* ===== Arranque ===== */
    loadArticulo();
    refreshCartBadge();
  </script>
</body>
</html>
