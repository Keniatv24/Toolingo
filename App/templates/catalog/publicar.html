<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Publicar art√≠culo ‚Äì Toolingo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: { 600: '#f97316', 700: '#c2410c' }
          }
        }
      }
    };
  </script>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800">
  <main class="max-w-2xl mx-auto p-6">
    <a href="/" class="inline-flex items-center gap-2 mb-6">
      <svg width="26" height="26" viewBox="0 0 24 24" class="text-brand-600 fill-current">
        <path d="M21 7.5a5.5 5.5 0 0 1-7.53 5.09l-6.44 6.44a1.5 1.5 0 0 1-2.12-2.12l6.44-6.44A5.5 5.5 0 1 1 21 7.5Z"/>
      </svg>
      <span class="text-lg font-extrabold">Toolingo</span>
    </a>

    <section class="bg-white border rounded-2xl shadow p-6">
      <h1 class="text-2xl font-bold">Publicar un art√≠culo</h1>
      <p class="text-sm text-slate-600 mb-4">Completa los datos y publica tu herramienta.</p>

      <form id="pubForm" class="grid md:grid-cols-2 gap-4">
        <!-- T√≠tulo -->
        <div class="md:col-span-2">
          <label class="text-sm text-slate-600">T√≠tulo</label>
          <input id="titulo" class="w-full border rounded-xl px-3 py-2" placeholder="Taladro percutor 800W" required />
        </div>

        <!-- Descripci√≥n -->
        <div class="md:col-span-2">
          <label class="text-sm text-slate-600">Descripci√≥n</label>
          <textarea id="descripcion" rows="3" class="w-full border rounded-xl px-3 py-2" placeholder="Caracter√≠sticas, estado, incluye..."></textarea>
        </div>

        <!-- Categor√≠a -->
        <div>
          <label class="text-sm text-slate-600">Categor√≠a</label>
          <select id="categoria" class="w-full border rounded-xl px-3 py-2" required></select>
        </div>

        <!-- Precio -->
        <div>
          <label class="text-sm text-slate-600">Precio por d√≠a (COP)</label>
          <input id="precio" type="number" class="w-full border rounded-xl px-3 py-2" placeholder="35000" required />
        </div>

        <!-- Dep√≥sito -->
        <div>
          <label class="text-sm text-slate-600">Dep√≥sito (opcional)</label>
          <input id="deposito" type="number" class="w-full border rounded-xl px-3 py-2" placeholder="80000" />
        </div>

        <!-- Ubicaci√≥n -->
        <div class="md:col-span-2">
          <label class="text-sm text-slate-600 flex items-center justify-between">
            <span>Ubicaci√≥n (texto: barrio/ciudad/direcci√≥n)</span>
            <button id="btnGeo" type="button" class="text-xs px-2 py-1 rounded bg-slate-100 hover:bg-slate-200">üìç Usar mi ubicaci√≥n</button>
          </label>
          <input id="ubicacion" class="w-full border rounded-xl px-3 py-2" placeholder="Medell√≠n, Laureles" required />
          <p id="geoInfo" class="text-xs text-slate-500 mt-1"></p>
        </div>

        <!-- Coordenadas ocultas -->
        <input id="lat" type="hidden" />
        <input id="lng" type="hidden" />

        <!-- Im√°genes -->
        <div class="md:col-span-2">
          <label class="text-sm text-slate-600">Fotos del art√≠culo (m√≠nimo 1)</label>
          <input id="imagenes" type="file" accept="image/*" multiple required class="w-full border rounded-xl px-3 py-2" />
          <div id="preview" class="mt-2 flex flex-wrap gap-2"></div>
          <p class="text-xs text-slate-500">Puedes subir varias. La primera ser√° la principal.</p>
        </div>

        <!-- Bot√≥n -->
        <div class="md:col-span-2">
          <button class="w-full py-2 rounded-xl bg-brand-600 text-white hover:bg-brand-700 transition" type="submit">Publicar</button>
        </div>
      </form>

      <div id="msg" class="text-sm mt-3"></div>
    </section>
  </main>

  <script>
    // 1) Requiere login
    (function authGuard(){
      const t = localStorage.getItem('access');
      if (!t) {
        const next = encodeURIComponent(location.pathname);
        location.replace(`/login/?next=${next}`);
      }
    })();

    // 2) Cargar categor√≠as
    (async function loadCats(){
      try {
        const r = await fetch('/api/categorias/');
        const cats = await r.json();
        const children = {};
        cats.forEach(c => { if(c.parent){ (children[c.parent] ||= []).push(c); }});
        const hojas = cats.filter(c => !(children[c.id] && children[c.id].length));
        const sel = document.getElementById('categoria');
        sel.innerHTML = hojas.map(c => `<option value="${c.id}" data-slug="${c.slug}">${c.nombre}</option>`).join('');
      } catch (e) {
        const msg = document.getElementById('msg');
        msg.textContent = 'No se pudieron cargar categor√≠as';
        msg.className = 'text-sm text-red-600';
      }
    })();

    // 3) Preview im√°genes
    const imgInput = document.getElementById('imagenes');
    const preview  = document.getElementById('preview');
    imgInput?.addEventListener('change', () => {
      preview.innerHTML = '';
      const files = imgInput.files || [];
      if (!files.length) return;
      [...files].forEach(file => {
        const url = URL.createObjectURL(file);
        const img = document.createElement('img');
        img.src = url;
        img.alt = file.name;
        img.className = 'h-16 w-16 object-cover rounded-lg border';
        preview.appendChild(img);
      });
    });

    // 4) Bot√≥n geolocalizaci√≥n
    document.getElementById('btnGeo').addEventListener('click', () => {
      const btn = document.getElementById('btnGeo');
      const info = document.getElementById('geoInfo');
      if (!('geolocation' in navigator)) {
        alert('Tu navegador no soporta geolocalizaci√≥n.');
        return;
      }
      const old = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Obteniendo‚Ä¶';
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude } = pos.coords || {};
          document.getElementById('lat').value = (latitude ?? '').toFixed(6);
          document.getElementById('lng').value = (longitude ?? '').toFixed(6);
          info.textContent = `Coordenadas detectadas: ${latitude?.toFixed(6)}, ${longitude?.toFixed(6)} (se guardar√°n)`;
          btn.disabled = false;
          btn.textContent = old;
        },
        () => {
          info.textContent = 'No se pudo obtener tu ubicaci√≥n. Escr√≠bela manualmente.';
          btn.disabled = false;
          btn.textContent = old;
        },
        { enableHighAccuracy: false, timeout: 8000, maximumAge: 0 }
      );
    });

    // 5) Env√≠o del formulario
    document.getElementById('pubForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const msg = document.getElementById('msg');
      msg.textContent = '';

      const token = localStorage.getItem('access');
      if (!token) {
        location.replace('/login/?next=/publicar/');
        return;
      }

      const files = document.getElementById('imagenes').files;
      if (!files || files.length === 0) {
        msg.textContent = 'Debes adjuntar al menos una foto.';
        msg.className = 'text-sm text-red-600';
        return;
      }

      const fd = new FormData();
      fd.append('titulo', document.getElementById('titulo').value.trim());
      fd.append('descripcion', document.getElementById('descripcion').value.trim());
      fd.append('categoria', document.getElementById('categoria').value);
      fd.append('precio_por_dia', document.getElementById('precio').value || '0');
      fd.append('deposito', document.getElementById('deposito').value || '0');
      fd.append('ubicacion', document.getElementById('ubicacion').value.trim());
      fd.append('disponibilidad_global', 'true');

      // Coordenadas
      const lat = document.getElementById('lat').value;
      const lng = document.getElementById('lng').value;
      if (lat && lng) {
        fd.append('lat', lat);
        fd.append('lng', lng);
      }

      for (const f of files) fd.append('imagenes', f);

      try {
        const r = await fetch('/api/articulos/', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: fd
        });

        if (r.status === 401) {
          location.replace('/login/?next=/publicar/');
          return;
        }
        if (!r.ok) {
          const err = await r.json().catch(()=>({detail:'Error'}));
          throw new Error(err.detail || JSON.stringify(err));
        }
        await r.json();
        msg.textContent = '‚úÖ ¬°Art√≠culo publicado con √©xito!';
        msg.className = 'text-sm text-green-700';
        setTimeout(()=> location.replace('/catalogo/'), 1200);
      } catch (e2) {
        msg.textContent = e2.message || 'Error desconocido';
        msg.className = 'text-sm text-red-600';
      }
    });
  </script>
</body>
</html>
