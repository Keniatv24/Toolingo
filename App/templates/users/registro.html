<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registrarse – Toolingo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config={theme:{extend:{colors:{brand:{600:'#f97316',700:'#c2410c'}}}}}</script>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800">
  <main class="max-w-md mx-auto p-6">
    <a href="/" class="inline-flex items-center gap-2 mb-6">
      <svg width="26" height="26" viewBox="0 0 24 24" class="text-brand-600 fill-current"><path d="M21 7.5a5.5 5.5 0 0 1-7.53 5.09l-6.44 6.44a1.5 1.5 0 0 1-2.12-2.12l6.44-6.44A5.5 5.5 0 1 1 21 7.5Z"/></svg>
      <span class="text-lg font-extrabold">Toolingo</span>
    </a>

    <section class="bg-white border rounded-2xl shadow p-6">
      <h1 class="text-2xl font-bold">Crear cuenta</h1>
      <p class="text-sm text-slate-600 mb-4">Regístrate para publicar o alquilar artículos.</p>

      <form id="regForm" class="grid gap-3">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-sm text-slate-600">Nombre</label>
            <input id="first_name" class="w-full border rounded-xl px-3 py-2" placeholder="Kenia" required />
          </div>
          <div>
            <label class="text-sm text-slate-600">Apellido</label>
            <input id="last_name" class="w-full border rounded-xl px-3 py-2" placeholder="Toscano" required />
          </div>
        </div>

        <div>
          <label class="text-sm text-slate-600">Correo</label>
          <input id="email" type="email" class="w-full border rounded-xl px-3 py-2" placeholder="tucorreo@ejemplo.com" required />
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-sm text-slate-600">Contraseña</label>
            <input id="password" type="password" class="w-full border rounded-xl px-3 py-2" placeholder="mín. 8 caracteres" required />
          </div>
          <div>
            <label class="text-sm text-slate-600">Repetir contraseña</label>
            <input id="password2" type="password" class="w-full border rounded-xl px-3 py-2" required />
          </div>
        </div>

        <button class="w-full py-2 rounded-xl bg-brand-600 text-white hover:bg-brand-700 transition" type="submit">
          Crear cuenta
        </button>
      </form>

      <div id="msg" class="text-sm mt-3"></div>

      <p class="text-sm text-slate-600 mt-4">
        ¿Ya tienes cuenta?
        <a href="/login/" class="text-brand-700 hover:underline">Inicia sesión</a>
      </p>
    </section>
  </main>

  <script>
    document.getElementById('regForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const msg = document.getElementById('msg'); msg.textContent='';

      const first_name = document.getElementById('first_name').value.trim();
      const last_name  = document.getElementById('last_name').value.trim();
      const email      = document.getElementById('email').value.trim();
      const password   = document.getElementById('password').value;
      const password2  = document.getElementById('password2').value;

      if (password !== password2) {
        msg.textContent = 'Las contraseñas no coinciden.';
        msg.className = 'text-sm text-red-600';
        return;
      }

      try {
        // 1) Registrar
        const r = await fetch('/api/users/', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ first_name, last_name, email, password })
        });
        if (!r.ok) {
          const err = await r.json().catch(()=>({detail:'Error'}));
          throw new Error(err.detail || (err.email && err.email[0]) || 'No se pudo registrar');
        }

        // 2) Login automático (JWT)
        const t = await fetch('/api/token/', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ email, password })
        });
        if (!t.ok) throw new Error('Registro ok, pero no se pudo iniciar sesión.');
        const tokens = await t.json();
        localStorage.setItem('access', tokens.access);
        localStorage.setItem('refresh', tokens.refresh);

        // 3) Redirigir (si venía de publicar, vuelve allá)
        const next = new URLSearchParams(location.search).get('next') || '/';
        location.replace(next);
      } catch (e2) {
        msg.textContent = e2.message || 'Error inesperado';
        msg.className = 'text-sm text-red-600';
      }
    });
  </script>
</body>
</html>
