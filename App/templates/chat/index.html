{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat – Toolingo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {50:'#fff7ed',100:'#ffedd5',600:'#f97316',700:'#c2410c'}
          }
        }
      }
    }
  </script>
</head>
<body class="bg-slate-50 flex flex-col h-screen">

  <!-- ======= HEADER ======= -->
  <header class="bg-slate-900 text-white flex items-center justify-between px-4 py-3">
    <div class="flex items-center gap-3">
      <span class="text-xl font-bold">Chat</span>
      <div id="chatArticle" class="hidden sm:flex items-center gap-3">
        <img id="chatArtImg" src="" alt="Artículo" class="h-9 w-9 rounded-lg object-cover border border-white/20">
        <div class="text-sm">
          <div id="chatArtTitle" class="font-medium"></div>
          <div id="chatArtOwner" class="text-xs text-slate-300"></div>
        </div>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button id="markReadBtn" class="text-sm bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded">Marcar leído</button>
      <button id="refreshBtn" class="text-sm bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded">Refrescar</button>
    </div>
  </header>

  <!-- ======= MENSAJES ======= -->
  <main id="messages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-100"></main>

  <!-- ======= INPUT MENSAJE ======= -->
  <footer class="bg-white border-t p-3">
    <form id="sendForm" class="flex items-end gap-3">
      <div class="flex-1 relative">
        <textarea id="messageInput" rows="1" placeholder="Escribe un mensaje..." class="w-full resize-none border rounded-xl px-4 py-3 pr-14 focus:ring-2 focus:ring-brand-600 focus:outline-none"></textarea>
        <button type="submit" id="sendBtn" class="absolute right-2 bottom-2 bg-brand-600 hover:bg-brand-700 text-white px-4 py-1.5 rounded-lg">Enviar</button>
      </div>
    </form>
    <p class="text-xs text-slate-400 mt-2">Enter para enviar • Shift+Enter para salto de línea</p>
  </footer>

  <script>
    // ========== UTILIDADES ==========
    const qs = new URLSearchParams(location.search);
    const embed = qs.get("embed") === "1";
    const articleId = qs.get("article");
    let conversationId = null;
    let me = null;

    function fmtTime(ts) {
      const d = new Date(ts);
      return d.toLocaleTimeString("es-CO", { hour: "2-digit", minute: "2-digit" });
    }

    function getToken() {
      return localStorage.getItem("access") || localStorage.getItem("jwt");
    }

    async function authFetch(url, opt = {}) {
      const t = getToken();
      if (!t) {
        if (!embed) location.href = `/login/?next=${encodeURIComponent(location.pathname)}`;
        throw new Error("No autenticado");
      }
      const headers = new Headers(opt.headers || {});
      headers.set("Authorization", `Bearer ${t}`);
      if (opt.body && !headers.has("Content-Type"))
        headers.set("Content-Type", "application/json");
      const resp = await fetch(url, { ...opt, headers });
      return resp;
    }

    async function getJSON(url, opt = {}) {
      const resp = await authFetch(url, opt);
      let data = {};
      try { data = await resp.json(); } catch {}
      return { ok: resp.ok, data };
    }

    // ========== RENDER MENSAJES ==========
    const messagesEl = document.getElementById("messages");

    function renderMessages(msgs) {
      messagesEl.innerHTML = "";
      msgs.forEach(m => {
        const mine = m.autor?.id === me?.id;
        const bubble = document.createElement("div");
        bubble.className = `max-w-[80%] p-3 rounded-2xl shadow-sm ${mine ? "bg-brand-600 text-white ml-auto" : "bg-white text-slate-800"} `;
        bubble.innerHTML = `
          <div class="text-sm">${m.contenido}</div>
          <div class="text-[11px] mt-1 opacity-70 text-right">${m.autor?.username || m.autor?.email || ""} • ${fmtTime(m.creado)}</div>
        `;
        const wrap = document.createElement("div");
        wrap.className = `flex ${mine ? "justify-end" : "justify-start"}`;
        wrap.appendChild(bubble);
        messagesEl.appendChild(wrap);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    async function loadMessages() {
      if (!conversationId) return;
      const { ok, data } = await getJSON(`/api/chats/${conversationId}/messages/`);
      if (ok) renderMessages(data);
    }

    async function sendMessage(content) {
      if (!conversationId) return;
      const { ok, data } = await getJSON(`/api/chats/${conversationId}/messages/`, {
        method: "POST",
        body: JSON.stringify({ contenido: content })
      });
      if (ok) {
        await loadMessages();
      }
    }

    // ========== EVENTOS ==========
    const form = document.getElementById("sendForm");
    const input = document.getElementById("messageInput");
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;
      input.value = "";
      await sendMessage(text);
    });

    document.getElementById("refreshBtn").addEventListener("click", loadMessages);
    document.getElementById("markReadBtn").addEventListener("click", async () => {
      if (conversationId) await authFetch(`/api/chats/${conversationId}/read/`, { method: "POST" });
    });

    // ========== CONVERSACIÓN POR ARTÍCULO ==========
    async function ensureConversationByArticle() {
      if (!articleId) return;

      const { ok, data } = await getJSON(`/api/chats/by-article/?articulo=${encodeURIComponent(articleId)}`, {
        method: "POST",
        body: JSON.stringify({ articulo_id: articleId })
      });

      if (!ok) {
        messagesEl.innerHTML = `<div class="text-center text-red-600 font-medium mt-8">⚠️ No se pudo iniciar la conversación</div>`;
        console.error("Error al crear chat:", data);
        return;
      }

      conversationId = data.id;
      // Mostrar datos del artículo si el backend lo envía o está en cache
      if (window.parent && window.parent.__ARTICULO__) {
        const a = window.parent.__ARTICULO__;
        const box = document.getElementById("chatArticle");
        document.getElementById("chatArtImg").src = a.portada || "";
        document.getElementById("chatArtTitle").textContent = a.titulo || "Artículo";
        document.getElementById("chatArtOwner").textContent = a.propietario_nombre || "";
        box.classList.remove("hidden");
      }

      if (data.created) {
        await sendMessage("¡Hola! Estoy interesad@ en tu artículo.");
      }
      await loadMessages();
    }

    // ========== PERFIL Y ARRANQUE ==========
    async function init() {
      const meResp = await getJSON("/api/perfiles/me/");
      if (!meResp.ok) {
        messagesEl.innerHTML = `<div class="text-center text-red-600 font-medium mt-8">Debes iniciar sesión para usar el chat.</div>`;
        return;
      }
      me = meResp.data;

      if (articleId) {
        await ensureConversationByArticle();
      } else {
        messagesEl.innerHTML = `<div class="text-center text-slate-500 mt-8">Selecciona un chat o un artículo para empezar una conversación.</div>`;
      }
    }

    init();
  </script>
</body>
</html>
